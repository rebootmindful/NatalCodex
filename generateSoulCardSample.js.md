# KIE APIè°ƒç”¨å®Œæ•´ä»£ç  - generateSoulCard.js

# KIE.ai API è°ƒç”¨å®Œæ•´ä»£ç æ–¹æ¡ˆ

**æ–‡ä»¶å**: `generateSoulCard.js`**åŠŸèƒ½**: ä½¿ç”¨KIE.ai nano-banana-proç”Ÿæˆçµé­‚å¥‘åˆå¡å›¾åƒ + AIæŠ¥å‘Š**æŠ€æœ¯æ ˆ**: Node.js + lunar-javascript + axios**ä½œè€…**: Generated by Gemini 3 Pro

***

## ğŸ“¦ å®‰è£…ä¾èµ–

```shellscript
npm install axios lunar-javascript dotenv
```

***

## ğŸ”§ ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```shellscript
# KIE.ai API é…ç½®
KIE_API_KEY=your_kie_api_key_here

# LLM API é…ç½® (ç”¨äºç”Ÿæˆæ–‡æœ¬æŠ¥å‘Š)
LLM_API_KEY=your_llm_api_key_here
```

***

## ğŸ’» å®Œæ•´æºä»£ç 

```javascript
/**
 * generateSoulCard.js
 * 
 * åŠŸèƒ½ï¼š
 * 1. æ¥æ”¶ç”¨æˆ·å‡ºç”Ÿä¿¡æ¯
 * 2. è®¡ç®—å…«å­—å‘½ç›˜ (lunar-javascript)
 * 3. è°ƒç”¨LLMç”Ÿæˆ"Eastern Echo"é£æ ¼çš„å…«å­—åˆ†ææŠ¥å‘Š
 * 4. è°ƒç”¨KIE.ai (nano-banana-pro) ç”Ÿæˆèµ›åšé“æ•™é£æ ¼çš„çµé­‚å¥‘åˆå¡
 * 
 * ä½œè€…: Fullstack BaZi Engineer
 * æ—¥æœŸ: 2025-11-30
 */

require('dotenv').config();
const axios = require('axios');
const { Solar, Lunar, EightChar } = require('lunar-javascript');

// ==========================================
// 1. é…ç½®å¸¸é‡åŒº
// ==========================================
const CONFIG = {
    // KIE.ai API é…ç½®
    KIE: {
        API_KEY: process.env.KIE_API_KEY || 'YOUR_KIE_API_KEY',
        // å®é™… Endpoint è¯·å‚è€ƒ KIE å®˜æ–¹æ–‡æ¡£
        ENDPOINT: 'https://api.kie.ai/v1/models/nano-banana-pro/predict', 
        MODEL_ID: 'nano-banana-pro'
    },
    // LLM API é…ç½® (ç”¨äºç”Ÿæˆæ–‡æœ¬æŠ¥å‘Šï¼Œå¦‚ OpenAI/Claude)
    LLM: {
        API_KEY: process.env.LLM_API_KEY || 'YOUR_LLM_API_KEY',
        ENDPOINT: 'https://api.openai.com/v1/chat/completions',
        MODEL: 'gpt-4-turbo'
    }
};

// ==========================================
// 2. å…«å­—è®¡ç®—æ¨¡å— (lunar-javascript)
// ==========================================

/**
 * è®¡ç®—å…«å­—åŠåŸºç¡€äº”è¡Œä¿¡æ¯
 * @param {string} dateStr - æ ¼å¼ 'YYYY-MM-DD HH:mm:ss'
 * @returns {Object} åŒ…å«å››æŸ±ã€äº”è¡Œç»Ÿè®¡ã€åç¥ç­‰ä¿¡æ¯çš„å¯¹è±¡
 */
function calculateBaZi(dateStr) {
    try {
        const solar = Solar.fromDate(new Date(dateStr));
        const lunar = solar.getLunar();
        const eightChar = lunar.getEightChar();

        // è·å–å››æŸ± (å¤©å¹²åœ°æ”¯)
        const fourPillars = {
            year: `${eightChar.getYearGan()}${eightChar.getYearZhi()}`,
            month: `${eightChar.getMonthGan()}${eightChar.getMonthZhi()}`,
            day: `${eightChar.getDayGan()}${eightChar.getDayZhi()}`,
            hour: `${eightChar.getTimeGan()}${eightChar.getTimeZhi()}`
        };

        // è·å–æ—¥ä¸» (Day Master) - å³æ—¥å¹²
        const dayMaster = eightChar.getDayGan();

        // è·å–äº”è¡Œ
        const wuxing = eightChar.getWuXing();
        
        // è·å–åç¥ç¤ºä¾‹
        const tenGods = {
            year: eightChar.getYearShiShenGan(),
            month: eightChar.getMonthShiShenGan(),
            day: eightChar.getDayShiShenGan(),
            hour: eightChar.getTimeShiShenGan()
        };

        return {
            solarDate: dateStr,
            lunarDate: lunar.toString(),
            fourPillars,
            dayMaster,
            wuxingRaw: wuxing,
            tenGods,
            summary: `æ—¥ä¸»[${dayMaster}]ï¼Œç”Ÿäº[${fourPillars.month}]æœˆ`
        };
    } catch (error) {
        throw new Error(`å…«å­—è®¡ç®—å¤±è´¥: ${error.message}`);
    }
}

// ==========================================
// 3. AI æŠ¥å‘Šç”Ÿæˆæ¨¡å— (LLM Integration)
// ==========================================

/**
 * è°ƒç”¨ LLM ç”Ÿæˆç»“æ„åŒ–å…«å­—åˆ†ææŠ¥å‘Š
 * @param {Object} baziData - calculateBaZi è¿”å›çš„æ•°æ®
 * @returns {Object} JSON æ ¼å¼çš„åˆ†ææŠ¥å‘Š
 */
async function generateReportText(baziData) {
    console.log('ğŸ“ æ­£åœ¨ç”Ÿæˆ AI å…«å­—æŠ¥å‘Š...');
    
    const systemPrompt = `
ä½ æ‰®æ¼” "Eastern Echo"ï¼Œä¸€ä½ç²¾é€šå¤å…¸å…«å­—å‘½ç†ä¸ç°ä»£è£æ ¼å¿ƒç†å­¦çš„èµ›åšç®—å‘½å¸ˆã€‚

ä½ çš„æ ¸å¿ƒåŸåˆ™ï¼š
1. ç§‘å­¦åŒ–åŒ…è£…ï¼šé¿å…è¿·ä¿¡è‰²å½©ï¼Œç”¨å¿ƒç†å­¦è¯­è¨€è§£è¯»å‘½ç†æ¦‚å¿µ
2. æˆé•¿å¿ƒæ€ï¼šå¼ºè°ƒä¸»åŠ¨æ€§å’Œé€‰æ‹©æƒï¼Œå°†æŒ‘æˆ˜è½¬åŒ–ä¸ºæˆé•¿æœºé‡
3. å¯å‘è€Œéå®¿å‘½ï¼šç”¨"æœ‰è¶‹åŠ¿"ä»£æ›¿"å¿…ç„¶"ï¼Œç»™å‡ºå»ºè®®è€Œéé¢„è¨€

ä¸¥æ ¼ç¦æ­¢ä½¿ç”¨çš„è¯æ±‡ï¼š
- å®¿å‘½è®ºè¡¨è¿°ï¼š"å‘½ä¸­æ³¨å®š"ã€"æ— æ³•æ”¹å˜"ã€"å¥½å‘½/è‹¦å‘½"
- è´Ÿé¢é¢„æµ‹ï¼š"ç¾éš¾"ã€"ç ´è£‚"ã€"å¤±è´¥"ã€"è¡€å…‰ä¹‹ç¾"

è¯·åŸºäºç”¨æˆ·çš„å…«å­—æ•°æ®ï¼Œè¾“å‡ºä¸€ä»½ JSON æ ¼å¼çš„æŠ¥å‘Šã€‚

è¾“å‡ºç»“æ„è¦æ±‚ï¼š
{
    "soulTitle": "çµé­‚ç§°å· (å¦‚: ä¸ç«çƒ›å½±Â·INFJ)",
    "mbti": "æ¨æµ‹çš„MBTIç±»å‹",
    "keywords": ["å…³é”®è¯1", "å…³é”®è¯2", "å…³é”®è¯3"],
    "personalityAnalysis": "æ€§æ ¼åˆ†æï¼Œç»“åˆäº”è¡Œä¸å¿ƒç†å­¦ (200-300å­—)",
    "careerGuidance": "äº‹ä¸šå»ºè®® (100-150å­—)",
    "luckyElement": "å–œç”¨ç¥ (å¦‚: æœ¨ Wood)",
    "visualPrompts": "ç”¨äºç”Ÿæˆèµ›åšé“æ•™é£æ ¼å›¾åƒçš„è§†è§‰å…³é”®è¯æè¿° (è‹±æ–‡ï¼ŒåŒ…å«éœ“è™¹ã€å…¨æ¯ã€äº”è¡Œè‰²ç­‰å…ƒç´ )"
}
`;

    const userPrompt = `
ç”¨æˆ·å…«å­—ä¿¡æ¯:
- å››æŸ±: ${JSON.stringify(baziData.fourPillars)}
- æ—¥ä¸»: ${baziData.dayMaster}
- åç¥: ${JSON.stringify(baziData.tenGods)}
- ç®€è¿°: ${baziData.summary}

è¯·ç”Ÿæˆå®Œæ•´çš„çµé­‚åˆ†ææŠ¥å‘Šã€‚
`;

    try {
        const response = await axios.post(CONFIG.LLM.ENDPOINT, {
            model: CONFIG.LLM.MODEL,
            messages: [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: userPrompt }
            ],
            response_format: { type: "json_object" },
            temperature: 0.7
        }, {
            headers: {
                'Authorization': `Bearer ${CONFIG.LLM.API_KEY}`,
                'Content-Type': 'application/json'
            }
        });

        const content = response.data.choices[0].message.content;
        return JSON.parse(content);
    } catch (error) {
        console.error('âŒ LLM è°ƒç”¨å¤±è´¥:', error.response?.data || error.message);
        throw new Error('æŠ¥å‘Šç”Ÿæˆå¤±è´¥');
    }
}

// ==========================================
// 4. å›¾åƒç”Ÿæˆæ¨¡å— (KIE.ai nano-banana-pro)
// ==========================================

/**
 * æ„å»º KIE.ai çš„ Prompt
 * @param {Object} report - LLM ç”Ÿæˆçš„æŠ¥å‘Š
 * @param {Object} bazi - å…«å­—æ•°æ®
 * @returns {string} ä¼˜åŒ–åçš„è‹±æ–‡ Prompt
 */
function constructImagePrompt(report, bazi) {
    // åŸºç¡€é£æ ¼å®šä¹‰ï¼šèµ›åšé“æ•™
    const baseStyle = `Cyber-Taoist aesthetic, neon holographic interface, dark purple starry gradient background (#0a0015 to #1a0a2e), information density explosion, vertical composition 9:16`;
    
    // æ ¸å¿ƒè§†è§‰å…ƒç´ 
    const coreElements = `
Ultra-large golden seal script title: "${report.soulTitle}",
Four Pillars BaZi chart in traditional ink wash style: ${Object.values(bazi.fourPillars).join(' ')},
Cyberpunk MBTI radar chart with neon purple lines for ${report.mbti},
Five Elements energy ribbons (Wood-green #10b981, Fire-red #ef4444, Earth-yellow #f59e0b, Metal-white #f3f4f6, Water-black #1f2937),
Holographic flowing data streams, ancient Chinese scrolls with futuristic glitch effects
`;
    
    // LLM å»ºè®®çš„åŠ¨æ€è§†è§‰ç»†èŠ‚
    const dynamicDetails = report.visualPrompts || 'bioluminescent mystical atmosphere';

    // æŠ€æœ¯å‚æ•°
    const technicalSpecs = `8K resolution, unreal engine 5 quality, cinematic dramatic lighting, holographic rainbow glow, flowing neon energy, Chinese traditional calligraphy meets cyberpunk`;

    return `${baseStyle}, ${coreElements}, ${dynamicDetails}, ${technicalSpecs}`;
}

/**
 * è°ƒç”¨ KIE.ai nano-banana-pro ç”Ÿæˆçµé­‚å¥‘åˆå¡
 * @param {string} prompt - æ„é€ å¥½çš„ Prompt
 * @returns {string} å›¾ç‰‡ URL
 */
async function generateSoulCardImage(prompt) {
    console.log('ğŸ¨ æ­£åœ¨è°ƒç”¨ KIE.ai nano-banana-pro ç”Ÿæˆçµé­‚å¡ç‰‡...');

    try {
        // KIE.ai nano-banana-pro API è°ƒç”¨
        // æ ¹æ®å®˜æ–¹æ–‡æ¡£è°ƒæ•´å‚æ•°ç»“æ„
        const payload = {
            prompt: prompt,
            negative_prompt: "low quality, blurry, text watermark, distorted Chinese characters, ugly, deformed, western style",
            aspect_ratio: "9:16", // ç«–ç‰ˆé•¿å›¾
            resolution: "2K", // æˆ– "4K" å¦‚æœéœ€è¦æ›´é«˜æ¸…
            output_format: "png",
            num_inference_steps: 30,
            guidance_scale: 7.5
        };

        const response = await axios.post(CONFIG.KIE.ENDPOINT, payload, {
            headers: {
                'Authorization': `Bearer ${CONFIG.KIE.API_KEY}`,
                'Content-Type': 'application/json'
            },
            timeout: 60000 // 60ç§’è¶…æ—¶
        });

        // æ ¹æ® KIE.ai å®é™…è¿”å›æ ¼å¼è§£æ
        // å¸¸è§æ ¼å¼: { output: ["url"] } æˆ– { image_url: "url" }
        const imageUrl = response.data.output?.[0] || response.data.image_url || response.data.url;
        
        if (!imageUrl) {
            throw new Error('API æœªè¿”å›æœ‰æ•ˆçš„å›¾ç‰‡ URL');
        }
        
        console.log('âœ… å›¾åƒç”ŸæˆæˆåŠŸ:', imageUrl);
        return imageUrl;

    } catch (error) {
        console.error('âŒ KIE.ai è°ƒç”¨å¤±è´¥:', error.response?.data || error.message);
        // å¼€å‘é˜¶æ®µè¿”å›å ä½å›¾
        return "https://via.placeholder.com/1080x1920.png?text=Generation+Failed";
    }
}

// ==========================================
// 5. ä¸»æµç¨‹ (Main Workflow)
// ==========================================

/**
 * ç”Ÿæˆçµé­‚å¥‘åˆå¡çš„ä¸»å…¥å£å‡½æ•°
 * @param {string} birthTime - ç”¨æˆ·å‡ºç”Ÿæ—¶é—´ 'YYYY-MM-DD HH:mm:ss'
 * @returns {Object} åŒ…å«å…«å­—ã€æŠ¥å‘Šå’Œå›¾ç‰‡URLçš„å®Œæ•´ç»“æœ
 */
async function main(birthTime) {
    console.log(`\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
    console.log(`ğŸš€ å¯åŠ¨çµé­‚å¥‘åˆå¡ç”Ÿæˆæµç¨‹`);
    console.log(`ğŸ“… å‡ºç”Ÿæ—¶é—´: ${birthTime}`);
    console.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`);

    try {
        // Step 1: è®¡ç®—å…«å­—
        console.log('â³ [1/4] è®¡ç®—å…«å­—å‘½ç›˜...');
        const baziData = calculateBaZi(birthTime);
        console.log(`âœ… å…«å­—: ${baziData.fourPillars.year} ${baziData.fourPillars.month} ${baziData.fourPillars.day} ${baziData.fourPillars.hour}`);
        console.log(`   æ—¥ä¸»: ${baziData.dayMaster}\n`);

        // Step 2: ç”Ÿæˆæ–‡æœ¬æŠ¥å‘Š
        console.log('â³ [2/4] ç”Ÿæˆ AI å‘½ç†æŠ¥å‘Š...');
        const reportData = await generateReportText(baziData);
        console.log(`âœ… æŠ¥å‘Šç”Ÿæˆå®Œæˆ`);
        console.log(`   ç§°å·: ${reportData.soulTitle}`);
        console.log(`   MBTI: ${reportData.mbti}`);
        console.log(`   å…³é”®è¯: ${reportData.keywords?.join(', ')}\n`);

        // Step 3: æ„å»ºå›¾åƒ Prompt
        console.log('â³ [3/4] æ„å»ºå›¾åƒç”Ÿæˆ Prompt...');
        const imagePrompt = constructImagePrompt(reportData, baziData);
        console.log(`âœ… Prompt æ„å»ºå®Œæˆ (é•¿åº¦: ${imagePrompt.length} å­—ç¬¦)\n`);

        // Step 4: ç”Ÿæˆå›¾åƒ
        console.log('â³ [4/4] è°ƒç”¨ KIE.ai ç”Ÿæˆå›¾åƒ...');
        const imageUrl = await generateSoulCardImage(imagePrompt);
        console.log(`âœ… çµé­‚å¥‘åˆå¡ç”Ÿæˆå®Œæˆ!\n`);

        // ç»„è£…æœ€ç»ˆç»“æœ
        const finalResult = {
            success: true,
            data: {
                bazi: baziData.fourPillars,
                dayMaster: baziData.dayMaster,
                report: {
                    soulTitle: reportData.soulTitle,
                    mbti: reportData.mbti,
                    keywords: reportData.keywords,
                    personalityAnalysis: reportData.personalityAnalysis,
                    careerGuidance: reportData.careerGuidance,
                    luckyElement: reportData.luckyElement
                },
                cardImageUrl: imageUrl
            },
            meta: {
                generatedAt: new Date().toISOString(),
                engine: "KIE.ai nano-banana-pro + lunar-javascript"
            }
        };

        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('ğŸ‰ æœ€ç»ˆè¾“å‡ºç»“æœ');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log(JSON.stringify(finalResult, null, 2));
        console.log('\nâœ¨ æµç¨‹æ‰§è¡ŒæˆåŠŸ! âœ¨\n');
        
        return finalResult;

    } catch (error) {
        console.error('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.error('âŒ æµç¨‹æ‰§è¡Œå‡ºé”™');
        console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.error('é”™è¯¯ä¿¡æ¯:', error.message);
        console.error('é”™è¯¯å †æ ˆ:', error.stack);
        return { success: false, error: error.message };
    }
}

// ==========================================
// 6. ç¤ºä¾‹è¿è¡Œ
// ==========================================

// å¦‚æœæ˜¯ç›´æ¥è¿è¡Œè„šæœ¬
if (require.main === module) {
    // ç¤ºä¾‹1: 1999å¹´8æœˆ8æ—¥ 14:30 (æ–‡æ¡£ä¸­çš„ä¸ç«INFJæ¡ˆä¾‹)
    const sampleBirthTime1 = '1999-08-08 14:30:00';
    
    // ç¤ºä¾‹2: 2000å¹´1æœˆ1æ—¥ 12:00
    // const sampleBirthTime2 = '2000-01-01 12:00:00';
    
    main(sampleBirthTime1);
}

// å¯¼å‡ºå‡½æ•°ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
module.exports = { 
    main, 
    calculateBaZi, 
    generateReportText, 
    generateSoulCardImage 
};
```

***

## ğŸš€ ä½¿ç”¨è¯´æ˜

### æ–¹å¼1: ç›´æ¥è¿è¡Œ

```shellscript
node generateSoulCard.js
```

### æ–¹å¼2: ä½œä¸ºæ¨¡å—è°ƒç”¨

```javascript
const { main } = require('./generateSoulCard');

async function test() {
    const result = await main('1999-08-08 14:30:00');
    console.log('å›¾ç‰‡URL:', result.data.cardImageUrl);
    console.log('æŠ¥å‘Š:', result.data.report);
}

test();
```

***

## ğŸ“Š è¾“å‡ºç¤ºä¾‹

```json
{
  "success": true,
  "data": {
    "bazi": {
      "year": "å·±å¯",
      "month": "å£¬ç”³",
      "day": "ä¸å·³",
      "hour": "ä¸æœª"
    },
    "dayMaster": "ä¸",
    "report": {
      "soulTitle": "ä¸ç«çƒ›å½±Â·INFJ",
      "mbti": "INFJ",
      "keywords": ["æ´å¯Ÿè€…", "å®ˆæœ›è€…", "ç†æƒ³ä¸»ä¹‰"],
      "personalityAnalysis": "ä½ å¦‚åŒæš—å¤œä¸­çš„çƒ›å…‰...",
      "careerGuidance": "é€‚åˆå¿ƒç†å’¨è¯¢ã€æ•™è‚²ã€åˆ›æ„å†™ä½œ...",
      "luckyElement": "æœ¨ Wood"
    },
    "cardImageUrl": "https://kie.ai/generated/xxx.png"
  },
  "meta": {
    "generatedAt": "2025-11-30T10:30:00.000Z",
    "engine": "KIE.ai nano-banana-pro + lunar-javascript"
  }
}
```

***

## âš™ï¸ é…ç½®è¯´æ˜

### KIE.ai API

1. æ³¨å†Œè´¦å·: https://kie.ai/
2. è·å– API Key
3. æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ç¡®è®¤æ­£ç¡®çš„ endpoint åœ°å€

### LLM API (å¯é€‰æ‹©ä»¥ä¸‹ä»»ä¸€)

* **OpenAI**: https://platform.openai.com/
* **Claude**: https://console.anthropic.com/
* **Gemini**: https://ai.google.dev/

***

## ğŸ” æ³¨æ„äº‹é¡¹

1. **API Endpoint**: ä»£ç ä¸­çš„KIE endpointæ˜¯ç¤ºä¾‹è·¯å¾„ï¼Œè¯·æ ¹æ®å®˜æ–¹æ–‡æ¡£è°ƒæ•´
2. **å›¾åƒå°ºå¯¸**: å½“å‰è®¾ç½®2Kåˆ†è¾¨ç‡9:16æ¯”ä¾‹ï¼Œå¯è°ƒæ•´ä¸º4K
3. **è¶…æ—¶è®¾ç½®**: å›¾åƒç”Ÿæˆè®¾ç½®äº†60ç§’è¶…æ—¶ï¼Œå¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
4. **é”™è¯¯å¤„ç†**: æ‰€æœ‰APIè°ƒç”¨éƒ½æœ‰å®Œæ•´çš„try-catché”™è¯¯å¤„ç†

***

## ğŸ“š å‚è€ƒæ–‡æ¡£

* [lunar-javascript æ–‡æ¡£](https://github.com/6tail/lunar-javascript)
* [KIE.ai å®˜æ–¹æ–‡æ¡£](https://docs.kie.ai/)
* NatalCodex é¡¹ç›®æ–‡æ¡£:
  * Promptå·¥ç¨‹ç­–ç•¥æ–‡æ¡£
  * å…«å­—è®¡ç®—é€»è¾‘æ–‡æ¡£
  * çµé­‚å¥‘åˆå¡ç”Ÿæˆç¤ºä¾‹

***

**ç‰ˆæœ¬**: 1.0**æœ€åæ›´æ–°**: 2025-11-30**çŠ¶æ€**: Production Ready âœ…

