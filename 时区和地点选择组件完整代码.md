# æ—¶åŒºå’Œåœ°ç‚¹é€‰æ‹©ç»„ä»¶å®Œæ•´ä»£ç 

# NatalCodex æ—¶åŒºå’Œåœ°ç‚¹é€‰æ‹©ç»„ä»¶ - å®Œæ•´å¯ç”¨ä»£ç 

æœ¬æ–‡æ¡£åŒ…å«å¯ä»¥ç›´æ¥å¤åˆ¶ç²˜è´´åˆ°é¡¹ç›®ä¸­ä½¿ç”¨çš„å®Œæ•´ä»£ç ã€‚

## ğŸ“¦ å®‰è£…ä¾èµ–

```shellscript
# æ ¸å¿ƒä¾èµ–
npm install react-timezone-select

# å¦‚æœä½¿ç”¨åœ°å›¾æ–¹æ¡ˆ(å¯é€‰)
npm install react-leaflet leaflet
```

***

## ğŸ¯ æ–¹æ¡ˆä¸€ï¼šåŸå¸‚æœç´¢è‡ªåŠ¨å¡«å……ï¼ˆæ¨èMVPä½¿ç”¨ï¼‰

### 1. LocationSearchInput.tsx

è¿™æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åŸå¸‚æœç´¢ç»„ä»¶ï¼Œä½¿ç”¨ OpenStreetMap çš„å…è´¹ APIã€‚

```tsx
'use client';

import React, { useState, useCallback } from 'react';

// Simple debounce utility
const debounce = (func: Function, wait: number) => {
  let timeout: NodeJS.Timeout;
  return (...args: any[]) => {
    clearTimeout(timeout);
    timeout = setTimeout(() => func(...args), wait);
  };
};

interface LocationResult {
  lat: number;
  lon: number;
  displayName: string;
  timezone?: string; // Will be derived
}

interface Props {
  onLocationSelect: (location: LocationResult) => void;
  defaultValue?: string;
  className?: string;
}

interface OSMPlace {
  place_id: number;
  lat: string;
  lon: string;
  display_name: string;
}

const LocationSearchInput: React.FC<Props> = ({ 
  onLocationSelect, 
  defaultValue = '',
  className = '' 
}) => {
  const [query, setQuery] = useState(defaultValue);
  const [suggestions, setSuggestions] = useState<OSMPlace[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const searchCity = async (input: string) => {
    if (!input || input.length < 2) {
      setSuggestions([]);
      return;
    }
    
    setLoading(true);
    setError(null);
    
    try {
      // Using OpenStreetMap Nominatim API (Free, requires User-Agent)
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?` + 
        `format=json&q=${encodeURIComponent(input)}&limit=8&addressdetails=1`,
        { 
          headers: { 
            'User-Agent': 'NatalCodex-App/1.0'  // Required by OSM policy
          } 
        }
      );
      
      if (!response.ok) {
        throw new Error('Search failed');
      }
      
      const data = await response.json();
      setSuggestions(data);
    } catch (err) {
      console.error("Location search failed:", err);
      setError("Search failed. Please try again.");
      setSuggestions([]);
    } finally {
      setLoading(false);
    }
  };

  // Debounce search to run 500ms after user stops typing
  const debouncedSearch = useCallback(
    debounce((value: string) => searchCity(value), 500),
    []
  );

  const handleInput = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setQuery(value);
    debouncedSearch(value);
  };

  const handleSelect = (place: OSMPlace) => {
    setQuery(place.display_name);
    setSuggestions([]);
    
    // Pass data back to parent
    onLocationSelect({
      lat: parseFloat(place.lat),
      lon: parseFloat(place.lon),
      displayName: place.display_name
    });
  };

  const handleBlur = () => {
    // Delay to allow click on suggestion
    setTimeout(() => setSuggestions([]), 200);
  };

  return (
    <div className={`relative w-full ${className}`}>
      <label className="block text-sm font-medium mb-2 text-cyber-sage">
        Birth City / Location
      </label>
      
      <input
        type="text"
        value={query}
        onChange={handleInput}
        onBlur={handleBlur}
        placeholder="Search city (e.g., Beijing, New York, London)"
        className="w-full p-3 bg-cyber-dark/50 border border-cyber-accent/30 rounded-lg 
                   text-white placeholder-gray-500 focus:outline-none focus:border-cyber-accent
                   transition-colors"
      />
      
      {/* Loading indicator */}
      {loading && (
        <div className="absolute right-3 top-11 text-cyber-accent text-sm">
          Searching...
        </div>
      )}
      
      {/* Error message */}
      {error && (
        <div className="text-red-400 text-xs mt-1">
          {error}
        </div>
      )}
      
      {/* Suggestion Dropdown */}
      {suggestions.length > 0 && (
        <ul className="absolute z-20 w-full bg-cyber-dark border border-cyber-accent/50 
                       rounded-lg shadow-2xl mt-1 max-h-64 overflow-auto">
          {suggestions.map((place) => (
            <li
              key={place.place_id}
              onClick={() => handleSelect(place)}
              className="p-3 hover:bg-cyber-accent/20 cursor-pointer text-sm text-gray-300
                         border-b border-cyber-accent/10 last:border-b-0 transition-colors"
            >
              ğŸ“ {place.display_name}
            </li>
          ))}
        </ul>
      )}
      
      <div className="text-xs text-gray-500 mt-1">
        ğŸ’¡ Your location helps calculate accurate solar time for BaZi analysis
      </div>
    </div>
  );
};

export default LocationSearchInput;
```

***

### 2. TimezoneSelector.tsx

æ—¶åŒºé€‰æ‹©ç»„ä»¶ï¼Œæ”¯æŒè‡ªåŠ¨æ£€æµ‹ç”¨æˆ·å½“å‰æ—¶åŒºã€‚

```tsx
'use client';

import React, { useState, useEffect } from 'react';
import TimezoneSelect from 'react-timezone-select';

interface Props {
  onChange: (timezone: any) => void;
  className?: string;
}

const TimezoneSelector: React.FC<Props> = ({ onChange, className = '' }) => {
  const [selectedTimezone, setSelectedTimezone] = useState<any>(
    Intl.DateTimeFormat().resolvedOptions().timeZone // Auto-detect
  );

  useEffect(() => {
    // Initialize with auto-detected timezone
    onChange(selectedTimezone);
  }, []);

  const handleChange = (timezone: any) => {
    setSelectedTimezone(timezone);
    onChange(timezone);
  };

  return (
    <div className={`w-full ${className}`}>
      <label className="block text-sm font-medium mb-2 text-cyber-sage">
        Birth Timezone (Auto-detected)
      </label>
      
      <TimezoneSelect
        value={selectedTimezone}
        onChange={handleChange}
        styles={{
          control: (provided) => ({
            ...provided,
            backgroundColor: 'rgba(10, 14, 39, 0.5)',
            borderColor: 'rgba(0, 255, 157, 0.3)',
            color: 'white',
            padding: '4px',
            borderRadius: '8px',
          }),
          menu: (provided) => ({
            ...provided,
            backgroundColor: '#0a0e27',
            border: '1px solid rgba(0, 255, 157, 0.5)',
          }),
          option: (provided, state) => ({
            ...provided,
            backgroundColor: state.isFocused ? 'rgba(0, 255, 157, 0.2)' : '#0a0e27',
            color: '#d4d4d8',
            cursor: 'pointer',
          }),
          singleValue: (provided) => ({
            ...provided,
            color: 'white',
          }),
          input: (provided) => ({
            ...provided,
            color: 'white',
          }),
        }}
      />
      
      <div className="text-xs text-gray-500 mt-1">
        ğŸ• Timezone will be used to calculate accurate birth time
      </div>
    </div>
  );
};

export default TimezoneSelector;
```

***

### 3. BirthInfoForm.tsx - å®Œæ•´æ•´åˆè¡¨å•

è¿™æ˜¯æ•´åˆäº†æ‰€æœ‰åŠŸèƒ½çš„å®Œæ•´å‡ºç”Ÿä¿¡æ¯è¡¨å•ã€‚

```tsx
'use client';

import React, { useState } from 'react';
import LocationSearchInput from './LocationSearchInput';
import TimezoneSelector from './TimezoneSelector';

interface BirthFormData {
  year: number;
  month: number;
  day: number;
  hour?: number;
  location?: {
    lat: number;
    lon: number;
    displayName: string;
  };
  timezone?: {
    value: string; // IANA timezone like "Asia/Shanghai"
    label: string; // Display label
    offset: number; // Current offset in hours
  };
}

interface Props {
  onSubmit: (data: BirthFormData) => void;
  className?: string;
}

const BirthInfoForm: React.FC<Props> = ({ onSubmit, className = '' }) => {
  const [formData, setFormData] = useState<BirthFormData>({
    year: 1990,
    month: 1,
    day: 1,
    hour: undefined,
    location: undefined,
    timezone: undefined,
  });

  const [showHour, setShowHour] = useState(false);

  const handleLocationSelect = (location: any) => {
    setFormData(prev => ({
      ...prev,
      location: {
        lat: location.lat,
        lon: location.lon,
        displayName: location.displayName
      }
    }));
  };

  const handleTimezoneChange = (timezone: any) => {
    setFormData(prev => ({
      ...prev,
      timezone: {
        value: timezone.value,
        label: timezone.label,
        offset: timezone.offset || 0
      }
    }));
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    // Validation
    if (!formData.location) {
      alert('Please select your birth location');
      return;
    }
    
    onSubmit(formData);
  };

  return (
    <form 
      onSubmit={handleSubmit} 
      className={`w-full max-w-2xl mx-auto space-y-6 ${className}`}
    >
      <div className="bg-cyber-dark/30 backdrop-blur-sm border border-cyber-accent/30 
                      rounded-2xl p-8 shadow-2xl">
        
        <h2 className="text-3xl font-serif text-cyber-accent mb-6 text-center">
          Enter Birth Information
        </h2>

        {/* Date Inputs */}
        <div className="grid grid-cols-3 gap-4 mb-6">
          <div>
            <label className="block text-sm font-medium mb-2 text-cyber-sage">
              Year
            </label>
            <input
              type="number"
              min="1900"
              max="2024"
              value={formData.year}
              onChange={(e) => setFormData(prev => ({ ...prev, year: parseInt(e.target.value) }))}
              className="w-full p-3 bg-cyber-dark/50 border border-cyber-accent/30 rounded-lg 
                         text-white focus:outline-none focus:border-cyber-accent"
              required
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-2 text-cyber-sage">
              Month
            </label>
            <input
              type="number"
              min="1"
              max="12"
              value={formData.month}
              onChange={(e) => setFormData(prev => ({ ...prev, month: parseInt(e.target.value) }))}
              className="w-full p-3 bg-cyber-dark/50 border border-cyber-accent/30 rounded-lg 
                         text-white focus:outline-none focus:border-cyber-accent"
              required
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-2 text-cyber-sage">
              Day
            </label>
            <input
              type="number"
              min="1"
              max="31"
              value={formData.day}
              onChange={(e) => setFormData(prev => ({ ...prev, day: parseInt(e.target.value) }))}
              className="w-full p-3 bg-cyber-dark/50 border border-cyber-accent/30 rounded-lg 
                         text-white focus:outline-none focus:border-cyber-accent"
              required
            />
          </div>
        </div>

        {/* Hour (Optional) */}
        <div className="mb-6">
          <div className="flex items-center justify-between mb-2">
            <label className="text-sm font-medium text-cyber-sage">
              Hour (Optional)
            </label>
            <button
              type="button"
              onClick={() => setShowHour(!showHour)}
              className="text-xs text-cyber-accent hover:underline"
            >
              {showHour ? 'Hide' : 'Add birth hour for more accuracy'}
            </button>
          </div>
          
          {showHour && (
            <input
              type="number"
              min="0"
              max="23"
              value={formData.hour || ''}
              onChange={(e) => setFormData(prev => ({ 
                ...prev, 
                hour: e.target.value ? parseInt(e.target.value) : undefined 
              }))}
              placeholder="Hour (0-23)"
              className="w-full p-3 bg-cyber-dark/50 border border-cyber-accent/30 rounded-lg 
                         text-white placeholder-gray-500 focus:outline-none focus:border-cyber-accent"
            />
          )}
        </div>

        {/* Location Search */}
        <LocationSearchInput 
          onLocationSelect={handleLocationSelect}
          className="mb-6"
        />

        {/* Selected Location Display */}
        {formData.location && (
          <div className="mb-6 p-3 bg-cyber-accent/10 border border-cyber-accent/30 rounded-lg">
            <div className="text-sm text-gray-300">
              <span className="text-cyber-accent font-medium">Selected Location:</span>
              <div className="mt-1">{formData.location.displayName}</div>
              <div className="text-xs text-gray-500 mt-1">
                Lat: {formData.location.lat.toFixed(4)}, Lon: {formData.location.lon.toFixed(4)}
              </div>
            </div>
          </div>
        )}

        {/* Timezone Selector */}
        <TimezoneSelector 
          onChange={handleTimezoneChange}
          className="mb-6"
        />

        {/* Privacy Notice */}
        <div className="text-xs text-gray-500 text-center mb-6 p-3 bg-cyber-dark/50 rounded-lg">
          ğŸ”’ <span className="text-cyber-accent">Privacy First:</span> Your data stays on your device. 
          We do not store your birth information.
        </div>

        {/* Submit Button */}
        <button
          type="submit"
          className="w-full py-4 bg-gradient-to-r from-cyber-accent to-zen-bamboo
                     text-cyber-dark font-semibold rounded-lg text-lg
                     hover:shadow-[0_0_30px_rgba(0,255,157,0.6)] 
                     transition-all duration-300 transform hover:scale-[1.02]"
        >
          Start Analysis âœ¨
        </button>
      </div>
    </form>
  );
};

export default BirthInfoForm;
```

***

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

åœ¨ä½ çš„é¡µé¢ä¸­è¿™æ ·ä½¿ç”¨ï¼š

```tsx
// app/input/page.tsx
'use client';

import React from 'react';
import { useRouter } from 'next/navigation';
import BirthInfoForm from '@/components/BirthInfoForm';

export default function InputPage() {
  const router = useRouter();

  const handleFormSubmit = (data: any) => {
    console.log('Birth data submitted:', data);
    
    // Save to localStorage or state management
    localStorage.setItem('birthData', JSON.stringify(data));
    
    // Navigate to result page
    router.push('/result');
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-cyber-dark via-cyber-purple/20 to-cyber-dark 
                    flex items-center justify-center p-4">
      <BirthInfoForm onSubmit={handleFormSubmit} />
    </div>
  );
}
```

***

## ğŸ¨ Tailwind é…ç½®è¡¥å……

ç¡®ä¿ä½ çš„ `tailwind.config.ts` åŒ…å«è¿™äº›é¢œè‰²ï¼š

```typescript
theme: {
  extend: {
    colors: {
      'cyber': {
        'dark': '#0a0e27',
        'accent': '#00ff9d',
        'purple': '#9d4edd',
        'sage': '#d4d4d8',
      },
      'zen': {
        'bamboo': '#52b788',
      }
    }
  }
}
```

***

## âœ… åŠŸèƒ½æ¸…å•

* âœ… åŸå¸‚æœç´¢è‡ªåŠ¨è¡¥å…¨ï¼ˆOpenStreetMapï¼Œå…è´¹ï¼‰
* âœ… é˜²æŠ–ä¼˜åŒ–ï¼ˆé¿å…é¢‘ç¹è¯·æ±‚ APIï¼‰
* âœ… è‡ªåŠ¨æ£€æµ‹ç”¨æˆ·æ—¶åŒº
* âœ… ç¾è§‚çš„ Cyber-Zen é£æ ¼
* âœ… å®Œæ•´çš„è¡¨å•éªŒè¯
* âœ… éšç§æç¤º
* âœ… å“åº”å¼è®¾è®¡
* âœ… TypeScript ç±»å‹å®‰å…¨
* âœ… å¯ç›´æ¥å¤åˆ¶ç²˜è´´ä½¿ç”¨

***

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **API ä½¿ç”¨è§„èŒƒ**ï¼šOpenStreetMap Nominatim è¦æ±‚è®¾ç½® User-Agentï¼Œä»£ç ä¸­å·²åŒ…å«
2. **é€Ÿç‡é™åˆ¶**ï¼šå…è´¹ API æœ‰é¢‘ç‡é™åˆ¶ï¼ˆçº¦ 1 æ¬¡/ç§’ï¼‰ï¼Œé˜²æŠ–åŠŸèƒ½å¯ä»¥å¸®åŠ©é¿å…è¶…é™
3. **ç”Ÿäº§ç¯å¢ƒ**ï¼šå¦‚æœæµé‡å¤§ï¼Œè€ƒè™‘ä½¿ç”¨ Mapbox æˆ– Google Places APIï¼ˆéœ€ä»˜è´¹ï¼‰
4. **æ—¶åŒºå¤„ç†**ï¼šæ—¶åŒºé€‰æ‹©å™¨ä¼šè‡ªåŠ¨å¤„ç†å¤ä»¤æ—¶ï¼Œä½†å»ºè®®åœ¨åç«¯è®¡ç®—çœŸå¤ªé˜³æ—¶æ—¶ä½¿ç”¨å®Œæ•´çš„ IANA æ—¶åŒºæ ‡è¯†ç¬¦

å®Œæ•´ä»£ç å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼ğŸ‰

