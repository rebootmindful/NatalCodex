<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NatalCodex ç®¡ç†åå°</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    * {margin:0;padding:0;box-sizing:border-box}
    body {font-family:'Inter',sans-serif;background:#0a0e27;color:#e5e7eb;min-height:100vh}
    
    .header {background:rgba(0,0,0,0.3);border-bottom:1px solid rgba(255,255,255,0.1);padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
    .header h1 {font-size:20px;color:#00ff9d}
    .header-right {display:flex;align-items:center;gap:16px}
    .admin-email {color:#9ca3af;font-size:14px}
    .logout-btn {padding:8px 16px;background:transparent;border:1px solid #ef4444;color:#ef4444;border-radius:6px;cursor:pointer;font-size:14px}
    .logout-btn:hover {background:#ef4444;color:#fff}
    
    .container {max-width:1400px;margin:0 auto;padding:24px}
    
    .tabs {display:flex;gap:8px;margin-bottom:24px;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:16px}
    .tab {padding:12px 24px;background:transparent;border:1px solid rgba(255,255,255,0.2);color:#9ca3af;border-radius:8px;cursor:pointer;font-size:14px;transition:all .2s}
    .tab:hover {border-color:#00ff9d;color:#00ff9d}
    .tab.active {background:#00ff9d;color:#0a0e27;border-color:#00ff9d}
    
    .panel {display:none}
    .panel.active {display:block}
    
    .stats-grid {display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
    .stat-card {background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px}
    .stat-label {color:#9ca3af;font-size:13px;margin-bottom:8px}
    .stat-value {font-size:28px;font-weight:700;color:#00ff9d}
    .stat-sub {color:#6b7280;font-size:12px;margin-top:4px}
    
    .card {background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:24px;margin-bottom:24px}
    .card-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .card-title {font-size:18px;font-weight:600;color:#fff}
    
    .search-box {display:flex;gap:12px;margin-bottom:16px}
    .search-input {flex:1;padding:10px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;font-size:14px}
    .search-input::placeholder {color:#6b7280}
    .search-input:focus {outline:none;border-color:#00ff9d}
    
    .btn {padding:10px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;border:none;transition:all .2s}
    .btn-primary {background:#00ff9d;color:#0a0e27}
    .btn-primary:hover {background:#00d4aa}
    .btn-secondary {background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.2)}
    .btn-secondary:hover {background:rgba(255,255,255,0.2)}
    .btn-danger {background:#ef4444;color:#fff}
    .btn-danger:hover {background:#dc2626}
    .btn-sm {padding:6px 12px;font-size:12px}
    
    table {width:100%;border-collapse:collapse}
    th,td {padding:12px 16px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.1)}
    th {color:#9ca3af;font-weight:500;font-size:13px}
    td {color:#e5e7eb;font-size:14px}
    tr:hover {background:rgba(255,255,255,0.02)}
    
    .badge {display:inline-block;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:500}
    .badge-green {background:rgba(0,255,157,0.2);color:#00ff9d}
    .badge-red {background:rgba(239,68,68,0.2);color:#ef4444}
    .badge-yellow {background:rgba(234,179,8,0.2);color:#eab308}
    .badge-blue {background:rgba(59,130,246,0.2);color:#3b82f6}
    
    .modal-overlay {position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:100}
    .modal-overlay.show {display:flex}
    .modal {background:#1a1f4d;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:32px;max-width:500px;width:90%}
    .modal-title {font-size:20px;font-weight:600;color:#fff;margin-bottom:24px}
    .form-group {margin-bottom:20px}
    .form-label {display:block;color:#9ca3af;font-size:14px;margin-bottom:8px}
    .form-select,.form-input {width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;font-size:14px}
    .form-select:focus,.form-input:focus {outline:none;border-color:#00ff9d}
    .modal-actions {display:flex;gap:12px;justify-content:flex-end;margin-top:24px}
    
    .pagination {display:flex;justify-content:center;gap:8px;margin-top:16px}
    .page-btn {padding:8px 14px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.2);color:#fff;border-radius:6px;cursor:pointer}
    .page-btn:hover {border-color:#00ff9d}
    .page-btn.active {background:#00ff9d;color:#0a0e27;border-color:#00ff9d}
    
    .loading {text-align:center;padding:40px;color:#9ca3af}
    .error {background:rgba(239,68,68,0.1);border:1px solid #ef4444;border-radius:8px;padding:16px;color:#ef4444;margin-bottom:16px}
    
    .filter-row {display:flex;gap:12px;margin-bottom:16px}
    .filter-select {padding:8px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff;font-size:13px}
    
    @media (max-width:768px) {
      .stats-grid {grid-template-columns:repeat(2,1fr)}
      .tabs {flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>ğŸ”® NatalCodex ç®¡ç†åå°</h1>
    <div class="header-right">
      <span class="admin-email" id="adminEmail">-</span>
      <button class="logout-btn" onclick="logout()">é€€å‡º</button>
    </div>
  </header>

  <div class="container">
    <!-- Error Display -->
    <div id="errorBox" class="error" style="display:none"></div>
    
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="stats">ğŸ“Š ç»Ÿè®¡æ¦‚è§ˆ</button>
      <button class="tab" data-tab="users">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</button>
      <button class="tab" data-tab="orders">ğŸ’° è®¢å•ç®¡ç†</button>
      <button class="tab" data-tab="promo">ğŸ« ä¼˜æƒ ç ç®¡ç†</button>
      <button class="tab" data-tab="settings">ğŸ“¢ æ¨å¹¿è®¾ç½®</button>
    </div>

    <!-- Stats Panel -->
    <div class="panel active" id="panel-stats">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
          <div class="stat-value" id="stat-users">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æ€»æ”¶å…¥</div>
          <div class="stat-value" id="stat-revenue">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æ€»ä½¿ç”¨æ¬¡æ•°</div>
          <div class="stat-value" id="stat-usage">-</div>
          <div class="stat-sub" id="stat-usage-detail">MBTI: - / KUDER: -</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ä¼˜æƒ ç </div>
          <div class="stat-value" id="stat-promo">-</div>
          <div class="stat-sub" id="stat-promo-detail">å·²ç”¨: - / æœ‰æ•ˆ: -</div>
        </div>
      </div>
    </div>

    <!-- Users Panel -->
    <div class="panel" id="panel-users">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ç”¨æˆ·åˆ—è¡¨</h3>
        </div>
        <div class="search-box">
          <input type="text" class="search-input" id="userSearch" placeholder="æœç´¢é‚®ç®±...">
          <button class="btn btn-primary" onclick="searchUsers()">æœç´¢</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>é‚®ç®±</th>
              <th>å‰©ä½™æ¬¡æ•°</th>
              <th>å·²è´­æ¬¡æ•°</th>
              <th>æ³¨å†Œæ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="usersTable">
            <tr><td colspan="6" class="loading">åŠ è½½ä¸­...</td></tr>
          </tbody>
        </table>
        <div class="pagination" id="usersPagination"></div>
      </div>
    </div>

    <!-- Orders Panel -->
    <div class="panel" id="panel-orders">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">è®¢å•åˆ—è¡¨</h3>
        </div>
        <div class="filter-row">
          <select class="filter-select" id="orderFilter" onchange="loadOrders()">
            <option value="">å…¨éƒ¨</option>
            <option value="paid">å·²æ”¯ä»˜</option>
            <option value="pending">å¾…æ”¯ä»˜</option>
            <option value="expired">å·²è¿‡æœŸ</option>
            <option value="failed">å¤±è´¥</option>
          </select>
          <input type="text" class="search-input" id="orderSearch" placeholder="æœç´¢è®¢å•å·..." style="max-width:200px">
          <button class="btn btn-secondary" onclick="loadOrders()">æœç´¢</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>è®¢å•å·</th>
              <th>ç”¨æˆ·</th>
              <th>å¥—é¤</th>
              <th>é‡‘é¢</th>
              <th>ä¼˜æƒ ç </th>
              <th>çŠ¶æ€</th>
              <th>åˆ›å»ºæ—¶é—´</th>
            </tr>
          </thead>
          <tbody id="ordersTable">
            <tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>
          </tbody>
        </table>
        <div class="pagination" id="ordersPagination"></div>
      </div>
    </div>

    <!-- Promo Panel -->
    <div class="panel" id="panel-promo">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ä¼˜æƒ ç ç®¡ç†</h3>
          <button class="btn btn-primary" onclick="showGeneratePromoModal()">+ ç”Ÿæˆä¼˜æƒ ç </button>
        </div>
        <div class="filter-row">
          <select class="filter-select" id="promoFilter" onchange="loadPromoCodes()">
            <option value="">å…¨éƒ¨</option>
            <option value="active">æœ‰æ•ˆ</option>
            <option value="used">å·²ä½¿ç”¨</option>
            <option value="expired">å·²è¿‡æœŸ</option>
          </select>
        </div>
        <table>
          <thead>
            <tr>
              <th>ä¼˜æƒ ç </th>
              <th>ç±»å‹</th>
              <th>æŠ˜æ‰£</th>
              <th>çŠ¶æ€</th>
              <th>ä½¿ç”¨è€…</th>
              <th>è¿‡æœŸæ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="promoTable">
            <tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>
          </tbody>
        </table>
        <div class="pagination" id="promoPagination"></div>
      </div>
    </div>

    <!-- Settings Panel -->
    <div class="panel" id="panel-settings">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">æ¨å¹¿æœŸå…è´¹æ¬¡æ•°è®¾ç½®</h3>
        </div>
        <div style="margin-bottom:24px">
          <div id="promoStatus" style="padding:16px;border-radius:12px;margin-bottom:20px;text-align:center">
            <span id="promoStatusIcon" style="font-size:24px">â³</span>
            <span id="promoStatusText" style="font-size:16px;margin-left:8px">åŠ è½½ä¸­...</span>
          </div>
          <div class="form-group">
            <label class="form-label">æ–°ç”¨æˆ·å…è´¹æ¬¡æ•°</label>
            <input type="number" class="form-input" id="settingFreeCredits" min="1" max="100" value="1" style="max-width:200px">
            <div style="color:#6b7280;font-size:12px;margin-top:4px">æ¨å¹¿æœŸå†…æ³¨å†Œçš„ç”¨æˆ·å°†è·å¾—æ­¤æ¬¡æ•°ï¼ˆ1-100ï¼‰</div>
          </div>
          <div class="form-group">
            <label class="form-label">æ¨å¹¿å¼€å§‹æ—¶é—´</label>
            <input type="datetime-local" class="form-input" id="settingStartAt" style="max-width:300px">
          </div>
          <div class="form-group">
            <label class="form-label">æ¨å¹¿ç»“æŸæ—¶é—´</label>
            <input type="datetime-local" class="form-input" id="settingEndAt" style="max-width:300px">
          </div>
          <div style="display:flex;gap:12px;margin-top:24px">
            <button class="btn btn-primary" onclick="savePromoConfig()">ä¿å­˜è®¾ç½®</button>
            <button class="btn btn-danger" onclick="clearPromoConfig()">åœæ­¢æ¨å¹¿ï¼ˆæ¢å¤1æ¬¡ï¼‰</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal-overlay" id="editCreditsModal">
    <div class="modal">
      <h3 class="modal-title">ä¿®æ”¹ç”¨æˆ·æ¬¡æ•°</h3>
      <div class="form-group">
        <label class="form-label">ç”¨æˆ·</label>
        <input type="text" class="form-input" id="editUserEmail" readonly>
        <input type="hidden" id="editUserId">
      </div>
      <div class="form-group">
        <label class="form-label">å½“å‰æ¬¡æ•°</label>
        <input type="text" class="form-input" id="editCurrentCredits" readonly>
      </div>
      <div class="form-group">
        <label class="form-label">æ“ä½œ</label>
        <select class="form-select" id="editCreditAction">
          <option value="set">ç›´æ¥è®¾ç½®ä¸º</option>
          <option value="add">å¢åŠ </option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">æ¬¡æ•°</label>
        <input type="number" class="form-input" id="editCreditsValue" min="0" value="0">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('editCreditsModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="submitEditCredits()">ç¡®è®¤</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="generatePromoModal">
    <div class="modal">
      <h3 class="modal-title">ç”Ÿæˆä¼˜æƒ ç </h3>
      <div class="form-group">
        <label class="form-label">æŠ˜æ‰£ç±»å‹</label>
        <select class="form-select" id="promoType">
          <option value="HALF">äº”æŠ˜ (Hå¼€å¤´)</option>
          <option value="TWENTY">å…«æŠ˜ (Eå¼€å¤´)</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ç”Ÿæˆæ•°é‡</label>
        <input type="number" class="form-input" id="promoCount" min="1" max="100" value="5">
      </div>
      <div class="form-group">
        <label class="form-label">æœ‰æ•ˆå¤©æ•°</label>
        <input type="number" class="form-input" id="promoDays" min="1" max="365" value="30">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('generatePromoModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="submitGeneratePromo()">ç”Ÿæˆ</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="promoResultModal">
    <div class="modal">
      <h3 class="modal-title">ç”ŸæˆæˆåŠŸ</h3>
      <div class="form-group">
        <label class="form-label">ç”Ÿæˆçš„ä¼˜æƒ ç  (ç‚¹å‡»å¤åˆ¶)</label>
        <textarea class="form-input" id="promoResultCodes" rows="10" readonly style="font-family:monospace"></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="copyPromoCodes()">å¤åˆ¶å…¨éƒ¨</button>
        <button class="btn btn-secondary" onclick="closeModal('promoResultModal')">å…³é—­</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    let token = localStorage.getItem('nc_auth_token');  // ä¸ generate.html ä¿æŒä¸€è‡´
    let currentPage = { users: 1, orders: 1, promo: 1 };

    // Check login
    async function checkAuth() {
      if (!token) {
        window.location.href = '/generate.html?redirect=admin';
        return false;
      }
      
      try {
        const res = await fetch(`${API_BASE}/auth?action=me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        
        if (!data.success) {
          throw new Error('Auth failed');
        }
        
        document.getElementById('adminEmail').textContent = data.user.email;
        return true;
      } catch (e) {
        localStorage.removeItem('nc_auth_token');
        localStorage.removeItem('nc_auth_user');
        window.location.href = '/generate.html?redirect=admin';
        return false;
      }
    }

    function logout() {
      localStorage.removeItem('nc_auth_token');
      localStorage.removeItem('nc_auth_user');
      window.location.href = '/';
    }

    function showError(msg) {
      const box = document.getElementById('errorBox');
      box.textContent = msg;
      box.style.display = 'block';
      setTimeout(() => box.style.display = 'none', 5000);
    }

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`panel-${tab.dataset.tab}`).classList.add('active');
      });
    });

    // API Helpers
    async function apiGet(action, params = {}) {
      const url = new URL(`${API_BASE}/admin`, window.location.origin);
      url.searchParams.set('action', action);
      Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
      
      const res = await fetch(url, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      return res.json();
    }

    async function apiPost(action, body) {
      const res = await fetch(`${API_BASE}/admin?action=${action}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      return res.json();
    }

    async function apiPut(action, body) {
      const res = await fetch(`${API_BASE}/admin?action=${action}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      return res.json();
    }

    async function apiDelete(action, params) {
      const url = new URL(`${API_BASE}/admin`, window.location.origin);
      url.searchParams.set('action', action);
      Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
      
      const res = await fetch(url, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      return res.json();
    }

    // Load Stats
    async function loadStats() {
      try {
        const data = await apiGet('stats');
        if (data.success) {
          const s = data.stats;
          document.getElementById('stat-users').textContent = s.users.total_users || 0;
          document.getElementById('stat-revenue').textContent = `Â¥${parseFloat(s.orders.total_revenue || 0).toFixed(2)}`;
          document.getElementById('stat-usage').textContent = s.usage.total_usage || 0;
          document.getElementById('stat-usage-detail').textContent = `MBTI: ${s.usage.mbti_count || 0} / KUDER: ${s.usage.kuder_count || 0}`;
          document.getElementById('stat-promo').textContent = s.promoCodes.total_codes || 0;
          document.getElementById('stat-promo-detail').textContent = `å·²ç”¨: ${s.promoCodes.used_codes || 0} / æœ‰æ•ˆ: ${s.promoCodes.active_codes || 0}`;
        }
      } catch (e) {
        console.error('Load stats error:', e);
      }
    }

    // Load Users
    async function loadUsers(page = 1, search = '') {
      currentPage.users = page;
      const tbody = document.getElementById('usersTable');
      tbody.innerHTML = '<tr><td colspan="6" class="loading">åŠ è½½ä¸­...</td></tr>';
      
      try {
        const data = await apiGet('users', { page, search, limit: 20 });
        if (data.success) {
          if (data.users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="loading">æ— æ•°æ®</td></tr>';
            return;
          }
          
          tbody.innerHTML = data.users.map(u => `
            <tr>
              <td>${u.id}</td>
              <td>${u.email}${u.is_admin ? ' <span class="badge badge-green">ç®¡ç†å‘˜</span>' : ''}</td>
              <td><span class="badge ${u.remaining_credits > 0 ? 'badge-green' : 'badge-red'}">${u.remaining_credits}</span></td>
              <td>${u.total_purchased}</td>
              <td>${new Date(u.created_at).toLocaleString('zh-CN')}</td>
              <td>
                <button class="btn btn-secondary btn-sm" onclick="showEditCreditsModal(${u.id}, '${u.email}', ${u.remaining_credits})">ä¿®æ”¹æ¬¡æ•°</button>
              </td>
            </tr>
          `).join('');
          
          renderPagination('usersPagination', data.pagination, (p) => loadUsers(p, search));
        }
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="6" class="error">åŠ è½½å¤±è´¥</td></tr>';
      }
    }

    function searchUsers() {
      const search = document.getElementById('userSearch').value;
      loadUsers(1, search);
    }

    // Load Promo Codes
    async function loadPromoCodes(page = 1) {
      currentPage.promo = page;
      const status = document.getElementById('promoFilter').value;
      const tbody = document.getElementById('promoTable');
      tbody.innerHTML = '<tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>';
      
      try {
        const data = await apiGet('promo-list', { page, status, limit: 50 });
        if (data.success) {
          if (data.promoCodes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="loading">æ— æ•°æ®</td></tr>';
            return;
          }
          
          tbody.innerHTML = data.promoCodes.map(p => {
            const isExpired = new Date(p.expires_at) < new Date();
            let statusBadge;
            if (p.is_used) {
              statusBadge = '<span class="badge badge-blue">å·²ä½¿ç”¨</span>';
            } else if (isExpired) {
              statusBadge = '<span class="badge badge-red">å·²è¿‡æœŸ</span>';
            } else {
              statusBadge = '<span class="badge badge-green">æœ‰æ•ˆ</span>';
            }
            
            return `
              <tr>
                <td><code>${p.code}</code></td>
                <td>${p.discount_type === 'HALF' ? 'äº”æŠ˜' : 'å…«æŠ˜'}</td>
                <td>${p.discount_percent}% off</td>
                <td>${statusBadge}</td>
                <td>${p.used_by_email || '-'}</td>
                <td>${new Date(p.expires_at).toLocaleDateString('zh-CN')}</td>
                <td>
                  ${!p.is_used ? `<button class="btn btn-danger btn-sm" onclick="deletePromo(${p.id}, '${p.code}')">ä½œåºŸ</button>` : ''}
                </td>
              </tr>
            `;
          }).join('');
          
          renderPagination('promoPagination', data.pagination, loadPromoCodes);
        }
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="7" class="error">åŠ è½½å¤±è´¥</td></tr>';
      }
    }

    function renderPagination(containerId, pagination, callback) {
      const container = document.getElementById(containerId);
      if (pagination.totalPages <= 1) {
        container.innerHTML = '';
        return;
      }
      
      let html = '';
      for (let i = 1; i <= pagination.totalPages; i++) {
        html += `<button class="page-btn ${i === pagination.page ? 'active' : ''}" onclick="(${callback.toString()})(${i})">${i}</button>`;
      }
      container.innerHTML = html;
    }

    // Modals
    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
    }

    function showEditCreditsModal(userId, email, credits) {
      document.getElementById('editUserId').value = userId;
      document.getElementById('editUserEmail').value = email;
      document.getElementById('editCurrentCredits').value = credits;
      document.getElementById('editCreditsValue').value = 0;
      document.getElementById('editCreditsModal').classList.add('show');
    }

    async function submitEditCredits() {
      const userId = document.getElementById('editUserId').value;
      const action = document.getElementById('editCreditAction').value;
      const credits = parseInt(document.getElementById('editCreditsValue').value);
      
      try {
        const data = await apiPut('update-credits', { userId, credits, action });
        if (data.success) {
          closeModal('editCreditsModal');
          loadUsers(currentPage.users);
          alert(`æ¬¡æ•°å·²æ›´æ–°ä¸º: ${data.newCredits}`);
        } else {
          showError(data.error || 'æ“ä½œå¤±è´¥');
        }
      } catch (e) {
        showError('æ“ä½œå¤±è´¥: ' + e.message);
      }
    }

    function showGeneratePromoModal() {
      document.getElementById('promoType').value = 'HALF';
      document.getElementById('promoCount').value = 5;
      document.getElementById('promoDays').value = 30;
      document.getElementById('generatePromoModal').classList.add('show');
    }

    async function submitGeneratePromo() {
      const discountType = document.getElementById('promoType').value;
      const count = parseInt(document.getElementById('promoCount').value);
      const expiresInDays = parseInt(document.getElementById('promoDays').value);
      
      try {
        const data = await apiPost('generate-promo', { discountType, count, expiresInDays });
        if (data.success) {
          closeModal('generatePromoModal');
          document.getElementById('promoResultCodes').value = data.codes.join('\n');
          document.getElementById('promoResultModal').classList.add('show');
          loadPromoCodes();
        } else {
          showError(data.error || 'ç”Ÿæˆå¤±è´¥');
        }
      } catch (e) {
        showError('ç”Ÿæˆå¤±è´¥: ' + e.message);
      }
    }

    function copyPromoCodes() {
      const textarea = document.getElementById('promoResultCodes');
      textarea.select();
      document.execCommand('copy');
      alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }

    async function deletePromo(id, code) {
      if (!confirm(`ç¡®å®šè¦ä½œåºŸä¼˜æƒ ç  ${code} å—ï¼Ÿ`)) return;
      
      try {
        const data = await apiDelete('delete-promo', { id });
        if (data.success) {
          loadPromoCodes(currentPage.promo);
        } else {
          showError(data.error || 'åˆ é™¤å¤±è´¥');
        }
      } catch (e) {
        showError('åˆ é™¤å¤±è´¥: ' + e.message);
      }
    }

    // ==================== Promo Config ====================
    
    async function loadPromoConfig() {
      try {
        const data = await apiGet('promo-config');
        if (data.success) {
          const config = data.config;
          document.getElementById('settingFreeCredits').value = config.freeCredits || 1;
          
          // Format datetime for input
          if (config.startAt) {
            document.getElementById('settingStartAt').value = formatDatetimeLocal(config.startAt);
          }
          if (config.endAt) {
            document.getElementById('settingEndAt').value = formatDatetimeLocal(config.endAt);
          }
          
          // Update status display
          const statusEl = document.getElementById('promoStatus');
          const iconEl = document.getElementById('promoStatusIcon');
          const textEl = document.getElementById('promoStatusText');
          
          if (config.isActive) {
            statusEl.style.background = 'rgba(0,255,157,0.1)';
            statusEl.style.border = '1px solid rgba(0,255,157,0.3)';
            iconEl.textContent = 'âœ…';
            textEl.textContent = `æ¨å¹¿è¿›è¡Œä¸­ï¼šæ–°ç”¨æˆ·æ³¨å†Œè·å¾— ${config.freeCredits} æ¬¡å…è´¹`;
            textEl.style.color = '#00ff9d';
          } else if (config.startAt && config.endAt) {
            const now = new Date();
            const endAt = new Date(config.endAt);
            if (now > endAt) {
              statusEl.style.background = 'rgba(239,68,68,0.1)';
              statusEl.style.border = '1px solid rgba(239,68,68,0.3)';
              iconEl.textContent = 'â°';
              textEl.textContent = 'æ¨å¹¿å·²ç»“æŸï¼Œæ–°ç”¨æˆ·è·å¾— 1 æ¬¡å…è´¹';
              textEl.style.color = '#fca5a5';
            } else {
              statusEl.style.background = 'rgba(234,179,8,0.1)';
              statusEl.style.border = '1px solid rgba(234,179,8,0.3)';
              iconEl.textContent = 'â³';
              textEl.textContent = 'æ¨å¹¿æœªå¼€å§‹ï¼Œç­‰å¾…å¼€å§‹æ—¶é—´';
              textEl.style.color = '#eab308';
            }
          } else {
            statusEl.style.background = 'rgba(107,114,128,0.1)';
            statusEl.style.border = '1px solid rgba(107,114,128,0.3)';
            iconEl.textContent = 'âŒ';
            textEl.textContent = 'æœªè®¾ç½®æ¨å¹¿æœŸï¼Œæ–°ç”¨æˆ·è·å¾— 1 æ¬¡å…è´¹';
            textEl.style.color = '#9ca3af';
          }
        }
      } catch (e) {
        console.error('Load promo config error:', e);
      }
    }

    function formatDatetimeLocal(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      return date.toISOString().slice(0, 16);
    }

    async function savePromoConfig() {
      const freeCredits = document.getElementById('settingFreeCredits').value;
      const startAt = document.getElementById('settingStartAt').value;
      const endAt = document.getElementById('settingEndAt').value;

      if (!startAt || !endAt) {
        showError('è¯·è®¾ç½®å¼€å§‹å’Œç»“æŸæ—¶é—´');
        return;
      }

      try {
        const data = await apiPut('update-promo-config', {
          freeCredits: parseInt(freeCredits),
          startAt: new Date(startAt).toISOString(),
          endAt: new Date(endAt).toISOString()
        });

        if (data.success) {
          alert('æ¨å¹¿è®¾ç½®å·²ä¿å­˜ï¼');
          loadPromoConfig();
        } else {
          showError(data.error || 'ä¿å­˜å¤±è´¥');
        }
      } catch (e) {
        showError('ä¿å­˜å¤±è´¥: ' + e.message);
      }
    }

    async function clearPromoConfig() {
      if (!confirm('ç¡®å®šè¦åœæ­¢æ¨å¹¿å—ï¼Ÿæ–°ç”¨æˆ·å°†æ¢å¤ä¸º 1 æ¬¡å…è´¹ã€‚')) return;

      try {
        const data = await apiPut('update-promo-config', {
          freeCredits: 1,
          startAt: null,
          endAt: null
        });

        if (data.success) {
          document.getElementById('settingFreeCredits').value = 1;
          document.getElementById('settingStartAt').value = '';
          document.getElementById('settingEndAt').value = '';
          alert('æ¨å¹¿å·²åœæ­¢ï¼Œæ–°ç”¨æˆ·æ¢å¤ä¸º 1 æ¬¡å…è´¹');
          loadPromoConfig();
        } else {
          showError(data.error || 'æ“ä½œå¤±è´¥');
        }
      } catch (e) {
        showError('æ“ä½œå¤±è´¥: ' + e.message);
      }
    }

    // ==================== Orders Management ====================

    async function loadOrders(page = 1) {
      currentPage.orders = page;
      const status = document.getElementById('orderFilter').value;
      const search = document.getElementById('orderSearch').value;
      const tbody = document.getElementById('ordersTable');
      tbody.innerHTML = '<tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>';

      try {
        const data = await apiGet('orders', { page, status, search, limit: 20 });
        if (data.success) {
          if (data.orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="loading">æ— æ•°æ®</td></tr>';
            return;
          }

          const packageNames = { PACK_6: '6æ¬¡å¥—é¤', PACK_20: '20æ¬¡å¥—é¤' };

          tbody.innerHTML = data.orders.map(o => {
            let statusBadge;
            switch (o.status) {
              case 'paid':
                statusBadge = '<span class="badge badge-green">å·²æ”¯ä»˜</span>';
                break;
              case 'pending':
                statusBadge = '<span class="badge badge-yellow">å¾…æ”¯ä»˜</span>';
                break;
              case 'expired':
                statusBadge = '<span class="badge badge-red">å·²è¿‡æœŸ</span>';
                break;
              case 'failed':
                statusBadge = '<span class="badge badge-red">å¤±è´¥</span>';
                break;
              default:
                statusBadge = `<span class="badge">${o.status}</span>`;
            }

            return `
              <tr>
                <td><code style="font-size:12px">${o.order_no}</code></td>
                <td>${o.user_email || '-'}</td>
                <td>${packageNames[o.package_type] || o.package_type}</td>
                <td>Â¥${parseFloat(o.final_price).toFixed(2)}</td>
                <td>${o.promo_code || '-'}</td>
                <td>${statusBadge}</td>
                <td>${new Date(o.created_at).toLocaleString('zh-CN')}</td>
              </tr>
            `;
          }).join('');

          renderPagination('ordersPagination', data.pagination, loadOrders);
        }
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="7" class="error">åŠ è½½å¤±è´¥</td></tr>';
        console.error('Load orders error:', e);
      }
    }

    // Init
    async function init() {
      if (await checkAuth()) {
        loadStats();
        loadUsers();
        loadOrders();
        loadPromoCodes();
        loadPromoConfig();
      }
    }

    init();
  </script>
</body>
</html>
