# 需求规格说明书

# NatalCodex 软件需求规格说明书 (Software Requirements Specification)

**版本**: 1.0

**日期**: 2023-10-27

**项目名称**: NatalCodex

**产品口号**: Unlock the Source Code of Your Soul

***

## 1. 引言 (Introduction)

### 1.1 目的

本文档旨在详细描述 NatalCodex 产品的软件需求，包括功能需求、非功能需求、技术架构与实施方案。该文档将作为开发团队、测试团队及项目干系人的主要参考依据，确保最终交付的产品符合 "Unlock the Source Code of Your Soul" 的品牌愿景及商业目标。

### 1.2 产品范围

NatalCodex 是一个面向全球市场(特别是北美、欧洲、东南亚)的数字化身心灵(Spiritual)产品。核心功能是基于用户的出生信息,利用传统八字命理学(重构为 "The Four Pillars of Energy")推演 MBTI 性格类型,并生成 "Soulprint Card"(灵魂指纹卡)。

产品采用 Freemium 模式:

* **免费层**: 基础性格分析、带水印的社交分享卡片。
* **付费层**: 解锁 Vertex AI 生成的深度个性化报告(2000字+)、高清无水印卡片。

### 1.3 术语定义

* **Soulprint Card**: 产品的核心输出物,包含用户能量画像的可视化卡片。
* **The Four Pillars of Energy**: 对传统"生辰八字"的去魅化、科学化包装术语。
* **Cyber-Zen**: 产品视觉风格,结合赛博朋克与禅宗美学。
* **BaZi (Eight Characters)**: 中国传统命理学计算方法。

***

## 2. 总体描述 (Overall Description)

### 2.1 产品愿景

打造一款融合东方古老智慧与现代 AI 技术的自我探索工具,通过极其简化的交互和极具冲击力的视觉体验,帮助 Z 世代用户探索自我。

### 2.2 用户特征

* **年龄**: 18-35 岁。
* **地域**: 北美、欧洲、东南亚。
* **兴趣**: 占星、塔罗、MBTI、自我成长、身心灵疗愈。
* **行为**: 习惯在 TikTok/Instagram 分享个性化内容,从众心理强,愿意为"情绪价值"付费。

### 2.3 假设与依赖

* 用户能够提供准确的出生日期和时间。
* Google Vertex AI API 服务稳定可用。
* Creem.io 支付网关支持目标市场的信用卡/借记卡支付。

***

## 3. 技术方案 (Technical Solution)

本章节详述系统的技术实现细节,作为开发实施的核心指导。

### 3.1 系统架构设计

采用 **Serverless Architecture** 以降低运维成本并支持高并发弹性伸缩。

* **前端/应用层**: Next.js 14+ (App Router),负责页面渲染、路由、API Routes。
* **计算层**:
  * Edge Functions (Vercel): 处理轻量级逻辑(如八字排盘、简单的 MBTI 映射)。
  * Serverless Functions (Vercel/Node.js): 处理支付回调、AI 报告生成请求等长耗时任务。
* **AI 服务层**: Google Vertex AI (PaLM 2 或 Gemini Pro),通过 REST API 进行非流式调用。
* **数据/存储层**:
  * **Client-side**: LocalStorage/IndexedDB 存储用户临时输入和生成的卡片数据(隐私优先,无强制登录)。
  * **Payment State**: 依赖 Creem.io 提供的 webhook 和 metadata 验证支付状态。
* **CDN/Edge**: Vercel Edge Network。

### 3.2 技术栈选型 (Tech Stack)

| 模块            | 技术选型                     | 选型理由                                                     |
| ------------- | ------------------------ | -------------------------------------------------------- |
| **Framework** | **Next.js 14+**          | React 生态标准,App Router 提供优秀的 SEO 和服务器组件性能,且与 Vercel 完美集成。 |
| **Language**  | **TypeScript**           | 强类型约束,减少运行时错误,利于维护复杂的计算逻辑。                               |
| **Styling**   | **Tailwind CSS**         | 快速构建 Cyber-Zen 风格 UI,配合 Framer Motion 实现流畅动效。            |
| **Logic Lib** | **lunar-javascript**     | 成熟的开源库,支持公历/农历转换及八字排盘,准确度高。                              |
| **AI Model**  | **Vertex AI**            | Google Cloud 的企业级 AI 服务,响应速度快,数据合规性好。                    |
| **Payment**   | **Creem.io**             | 专为数字产品设计的支付网关,集成极其简单,适合 MVP 快速验证。                        |
| **Image Gen** | **html2canvas / satori** | 前端或 Edge 端动态生成社交分享卡片图片。                                  |

### 3.3 核心算法实现

#### 3.3.1 八字排盘 (The Four Pillars Calculation)

使用 `lunar-javascript` 库将用户输入的公历时间转换为农历及干支(天干地支)。

```javascript
// 示例伪代码
import { Solar, Lunar } from 'lunar-javascript';

function calculateFourPillars(dateStr, hour) {
  const solar = Solar.fromYmdHms(year, month, day, hour, 0, 0);
  const lunar = solar.getLunar();
  return {
    yearPillar: lunar.getYearInGanZhi(),  // 年柱
    monthPillar: lunar.getMonthInGanZhi(), // 月柱
    dayPillar: lunar.getDayInGanZhi(),    // 日柱
    hourPillar: lunar.getTimeInGanZhi()   // 时柱
  };
}
```

#### 3.3.2 八字到 MBTI 映射逻辑 (Mapping Algorithm)

*注意:此映射为"产品逻辑"而非严格科学,需在代码中维护映射表。*

1. **提取五行能量**: 计算四柱中金、木、水、火、土的强弱比例(得令、得地、得势)。
2. **维度映射**:
   * **E/I (外向/内向)**: 依据"日主"强弱及"食伤/财星" vs "印星/比劫"的比例。食伤财旺倾向 E,印比旺倾向 I。
   * **S/N (实感/直觉)**: 依据"土/金"元素(稳重、现实) vs "水/火"元素(灵动、虚幻)的比例。
   * **T/F (思考/情感)**: 依据"官杀" (规则、逻辑) vs "食伤" (情绪、感受) 的强度。
   * **J/P (判断/感知)**: 依据八字格局的稳定性,如正官格倾向 J,偏财/七杀倾向 P。

### 3.4 前端状态管理

由于 MVP 阶段无强制用户账户体系,主要依赖 **React Context + LocalStorage**。

* `UserContext`: 存储 `birthDate`, `birthTime`, `gender`, `calculatedData`。
* `PaymentContext`: 存储 `paymentStatus`, `transactionId`。
* **持久化**: 使用 `zustand` 或自定义 hook 将关键状态同步至 LocalStorage,防止刷新丢失。

### 3.5 性能优化

* **Code Splitting**: 路由懒加载。
* **Image Optimization**: 使用 `next/image` 优化卡片背景图和资源。
* **Edge Caching**: 对静态资源和公共 API 响应设置 `Cache-Control`。
* **Bundle Size**: 仅引入 `lunar-javascript` 中必要的模块,避免引入过大的全量包。

***

## 4. 系统功能需求 (System Features)

### 4.1 核心体验流程 (The "Unlock" Flow)

#### 4.1.1 出生信息输入模块

* **用户故事**: 作为用户,我希望输入我的出生日期和时间,以便系统计算我的灵魂代码。
* **输入**: 出生年、月、日、时(精确到小时)、出生地(用于真太阳时校正,MVP 可选)、性别。
* **处理**: 前端校验格式,调用 `calculateFourPillars`。
* **输出**: 存储计算结果至 Context,跳转至结果页。
* **验收标准**:
  1. 必须校验非法的日期(如 2月30日),并给出即时提示。
  2. 提交后 Context 中必须包含准确的四柱数据(年/月/日/时柱)。
  3. 移动端软键盘交互顺畅,无遮挡。

#### 4.1.2 免费结果展示与卡片生成

* **用户故事**: 作为用户,我希望立即看到我的 MBTI 类型和一张酷炫的卡片,以便我发到 Instagram。
* **功能点**:
  * **MBTI 结果**: 显示 4 字母代码(如 INFJ)及核心关键词("The Mystic")。
  * **Soulprint Card 预览**: 动态渲染 HTML/Canvas,包含八字图形化符号、MBTI、Slogan。
  * **水印**: 免费版卡片右下角添加 "NatalCodex" 水印。
  * **下载/分享**: 只有"保存带水印图片"选项。
* **验收标准**:
  1. 卡片生成时间 < 500ms。
  2. 免费用户下载的图片必须包含清晰可读的水印。
  3. 生成的图片在 iOS/Android 相册中保存正常,无黑边或截断。

#### 4.1.3 支付集成 (Payment Gateway)

* **用户故事**: 作为用户,我希望支付 $12.90 解锁完整报告。
* **处理**:
  * 点击 "Unlock Full Report"。
  * 调用 Creem.io Checkout API 创建支付会话。
  * 重定向用户至 Creem.io 支付页。
  * 支付成功后回调至 `/result?paid=true` 或通过 Webhook 更新状态。
* **验收标准**:
  1. 点击支付按钮后,能在 2秒内跳转至 Creem.io 收银台。
  2. 支付成功后,页面自动刷新或跳转,显示"已解锁"状态。
  3. 支付失败或取消时,能优雅地返回产品页并提示重试。

#### 4.1.4 AI 深度报告生成 (The Source Code Report)

* **用户故事**: 付费后,我希望获得一份关于我性格、事业、爱情的深度分析。
* **输入**: 用户八字结构、MBTI 类型、性别。
* **处理**:
  * 后端组装 Prompt (提示词工程):包含"赛博禅意"语气要求、八字特征解释、性格优劣势分析。
  * 调用 **Vertex AI API** (非流式,为了生成完整 Markdown 文档)。
  * **Prompt 示例**: "Analyze the following BaZi structure \[Data] and MBTI \[Type]. Act as a Cyber-Zen master. Generate a 2000-word report covering: 1. Core Energy (Soul source), 2. Career Matrix, 3. Love Algorithms. Tone: Mystical yet scientific."
* **输出**: 结构化的 Markdown 文本,前端渲染为精美排版的文章。
* **验收标准**:
  1. 生成的报告字数不少于 1500 单词(英文)或 2000 字(中文)。
  2. 内容必须包含 Career, Love, Core Energy 三个指定板块。
  3. 报告生成过程中必须展示动态 Loading 效果,若超过 20s 需提示用户耐心等待。
  4. 排版渲染正确,Markdown 标题和列表显示清晰。

***

## 5. 接口规范 (Interface Specifications)

### 5.1 基础规范

* **Protocol**: HTTPS
* **Format**: JSON
* **Auth**: 无(MVP 阶段),部分敏感接口通过 Creem.io 签名验证。

### 5.2 API Endpoints

#### `POST /api/generate-report`

* **描述**: 调用 Vertex AI 生成深度报告(仅限付费验证通过后)。
* **请求 (Request)**:
  ```json
  {
    "birthData": { ... },
    "paymentId": "creem_tx_123456", // 用于后端二次验证
    "mbti": "INFJ"
  }
  ```
* **响应 (Response)**:
  ```json
  {
    "success": true,
    "data": {
      "reportContent": "# Your Soul Code...\n\n..."
    }
  }
  ```
* **错误处理**: 500 (AI Service Error), 403 (Payment Required).

#### `POST /api/webhook/creem`

* **描述**: 接收 Creem.io 的支付成功通知。
* **处理**: 验证签名,更新订单状态(如需后端存单),或触发邮件发送(Phase 2)。

***

## 6. 数据设计 (Data Design)

### 6.1 数据流图 (DFD) - 简化版

1. **User Input** -> **Frontend Logic** (lunar.js) -> **BaZi Data**
2. **BaZi Data** -> **Mapping Logic** -> **MBTI Result**
3. **Payment Request** -> **Creem.io** -> **Payment Confirmation**
4. **Confirmed Data** -> **Next.js API** -> **Vertex AI** -> **Report Content**

### 6.2 存储方案

* **LocalStorage**:
  * Key: `natal_user_session`
  * Value: `{ birthDate: '...', paid: false, reportCache: '...' }`
* **无需传统数据库**: MVP 阶段不保存用户 PII(个人敏感信息)到服务器,确保 GDPR 最小化合规。所有数据在用户浏览器端闭环,或仅在生成报告的短暂请求中传输。

### 6.3 数据安全

* **API Key 安全**: Vertex AI 和 Creem.io 的 API Keys 存储在 Vercel Environment Variables 中,绝不暴露给前端。
* **输入清洗**: 防止 Prompt Injection 攻击,对传递给 AI 的参数进行严格校验。

***

## 7. 非功能需求 (Non-functional Requirements)

1. **响应时间**:
   * 八字计算与卡片预览: < 200ms (纯前端/Edge)。
   * AI 报告生成: < 15s (需在前端设计 Loading 动画/进度条,提示 "Decoding your soul...")。
2. **兼容性**:
   * Mobile First 设计,完美适配 iOS Safari 和 Android Chrome。
   * 桌面端支持宽屏响应式布局。
3. **多语言**:
   * MVP 仅支持英文 (English),但代码结构需预留 i18n 字段。
4. **可用性**:
   * UI 需符合 WCAG 2.1 AA 标准(考虑到高对比度的 Cyber-Zen 风格)。

***

## 8. 部署方案 (Deployment)

### 8.1 生产环境

* **平台**: Vercel Pro。
* **域名**: `www.natalcodex.com` (示例)。
* **CI/CD**: GitHub Repository 关联 Vercel,Push to main 自动部署。

### 8.2 环境配置

在 Vercel 后台配置以下环境变量:

* `GOOGLE_VERTEX_API_KEY`
* `GOOGLE_PROJECT_ID`
* `CREEM_PRODUCT_ID`
* `CREEM_API_KEY`
* `NEXT_PUBLIC_BASE_URL`

***

## 9. 实施路线图 (Implementation Roadmap)

### Phase 1: MVP Core (Week 1-6)

* 搭建 Next.js 框架。
* 实现 `lunar-javascript` 排盘与 MBTI 映射逻辑。
* 完成 Soulprint Card 的 CSS/Canvas 渲染。
* 集成 Creem.io 支付流程。
* 集成 Vertex AI 生成基础文本报告。

### Phase 2: Enhanced Experience (Week 6-8)

* 优化 AI Prompt,增加报告的准确性和文学性。
* 添加 PDF 导出功能。
* 增加邮件订阅功能(收集 Leads)。

### Phase 3: Community & Growth (Month 3+)

* 引入用户账户系统 (Supabase/Clerk)。
* "合盘"功能 (Compatibility Match)。
* Affiliate/Referral 机制实现。

重要：input要启用cookie，避免用户多次输入。
input页面要加入出生地址选择，
地址需要手动输入后自动补全，纬度，时区，参考下面文件：
时去和地点选择组件完整代码.md
然后要给到prompt结合去 分析。所以prompt一定要有出生日期，时间，地点，时区，经纬度的信息输入。