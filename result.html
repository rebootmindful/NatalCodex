<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NatalCodex - Result</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#0a0e27 0%,#1a1f4d 50%,#2d1f4d 100%);color:#fff;min-height:100vh}
    .wrap{max-width:1000px;margin:0 auto;padding:32px 20px}
    .logo{font-size:32px;font-weight:600;color:#00ff9d;text-shadow:0 0 14px rgba(0,255,157,.5);letter-spacing:-.2px;margin-bottom:4px}
    .title{font-family:'Playfair Display',serif;font-size:28px;margin-bottom:12px;color:#e5e7eb}
    .desc{font-size:14px;color:#cbd5e1;margin-bottom:18px}
    .grid{display:grid;grid-template-columns:420px 1fr;gap:20px}
    .card,.panel{background:rgba(10,14,39,.55);backdrop-filter:blur(8px);border:1px solid rgba(0,255,157,.3);border-radius:16px;padding:18px;box-shadow:0 10px 28px rgba(0,255,157,.18)}
    .img{width:100%;height:720px;background:rgba(2,6,23,.65) url('soulprint-card.webp.png') center/cover no-repeat;border-radius:12px;filter:drop-shadow(0 12px 42px rgba(0,255,157,.28))}
    .actions{display:flex;gap:12px;margin-top:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 16px;border-radius:12px;border:1px solid rgba(0,255,157,.35);background:linear-gradient(135deg,#00ff9d 0%,#00d4aa 100%);color:#0a0e27;font-weight:700;letter-spacing:.2px;box-shadow:0 10px 26px rgba(0,255,157,.4);cursor:pointer;transition:transform .2s ease}
    .btn:hover{transform:translateY(-2px)}
    .ghost{background:rgba(10,14,39,.45);color:#e5e7eb;border:1px solid rgba(0,255,157,.35)}
    .pre{white-space:pre-wrap;line-height:1.8;color:#d4d4d8;font-size:14px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}.img{height:520px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="logo">NatalCodex</div>
    <div class="title">Your Soul Codex</div>
    <div class="desc">Below is your generated Soul Codex Card and the in-depth report. This demo simulates generation.</div>
    <div id="summary" class="panel" style="margin-bottom:12px">
      <div id="summaryText" class="pre"></div>
      <div class="actions" style="margin-top:8px">
        <button id="edit" class="btn ghost">Edit Info</button>
      </div>
    </div>
    <div class="grid">
      <div class="card">
        <div id="card" class="img"></div>
        <div class="actions">
          <button id="regenCard" class="btn">Regenerate Card</button>
          <button id="downloadCard" class="btn ghost">Download</button>
          <button id="genViaKie" class="btn ghost">Generate via KIE</button>
        </div>
        <div id="kieStatus" class="pre" style="margin-top:8px"></div>
      </div>
      <div class="panel">
        <div class="actions" style="margin-bottom:8px">
          <button id="generate" class="btn">Generate Report</button>
          <button id="copy" class="btn ghost">Copy</button>
        </div>
        <div id="report" class="pre">Preparing...</div>
      </div>
    </div>
  </div>
  <script>
    function getParam(k){var u=new URL(window.location.href);return u.searchParams.get(k)}
    function setCookie(name,value,days){var d=new Date();d.setTime(d.getTime()+days*24*60*60*1000);document.cookie=name+'='+encodeURIComponent(value)+';expires='+d.toUTCString()+';path=/'}
    function getCookie(name){var v=document.cookie.split('; ').find(function(r){return r.startsWith(name+'=')});return v?decodeURIComponent(v.split('=')[1]):null}
    var orderId=getParam('order_id')||localStorage.getItem('nc_order_id')||getCookie('nc_order_id');
    var testMode=(getParam('test')==='1')||(localStorage.getItem('nc_test_mode')==='1');
    if(!orderId){if(testMode){orderId='test-'+Math.random().toString(36).slice(2)} else {window.location.href='checkout.html'}}
    var session=localStorage.getItem('natal_user_session');
    function renderSummary(d){var s=document.getElementById('summaryText');if(!d||!d.date){s.textContent='No birth information found. Please return to input page.';return}var t='Name: '+(d.name||'')+'\nGender: '+(d.gender||'')+'\nBirth: '+(d.date||'')+' '+(d.time||'')+'\nLocation: '+(d.location||'')+'\nLatitude: '+(d.lat||'')+'\nLongitude: '+(d.lon||'')+'\nTimezone: '+(d.timezone||'');s.textContent=t}
    try{var d=JSON.parse(session||'{}');renderSummary(d)}catch(e){renderSummary(null)}
    function mockReport(d){return '# Soul Codex Report\n\nOrder: '+orderId+'\n\nBirth: '+(d.date||'')+' '+(d.time||'')+'\nLocation: '+(d.location||'')+' ('+(d.lat||'')+','+(d.lon||'')+') '+(d.timezone||'')+'\n\n## Core Energy\nYour chart blends Eastern metaphysics with modern psychology.\n\n## Career Matrix\nInsights tailored to your dominant elements.\n\n## Love Algorithms\nPatterns derived from cognitive functions and elemental balance.'}
    async function tryGenerate(d){
      try{
        var resp=await fetch('/api/reports/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({orderId:orderId,birthData:d})});
        if(resp.ok){var data=await resp.json();if(data&&data.success&&data.reportContent){return data.reportContent}}
      }catch(e){}
      return mockReport(d);
    }
    function download(node){var a=document.createElement('a');a.href='soulprint-card.webp.png';a.download='natalcodex-card.png';a.click()}
    document.getElementById('downloadCard').addEventListener('click',function(){download()})
    document.getElementById('regenCard').addEventListener('click',function(){var c=document.getElementById('card');c.style.opacity='0.6';setTimeout(function(){c.style.opacity='1'},600)})
    async function genCardViaKIE(){
      var statusEl=document.getElementById('kieStatus');
      statusEl.textContent='Creating task...';
      try{
        var d=JSON.parse(session||'{}');
        var prompt='Soulprint card, MBTI fusion, birth '+(d.date||'')+' '+(d.time||'')+', '+(d.location||'')+' ('+(d.lat||'')+','+(d.lon||'')+') '+(d.timezone||'')+'; Cyber-Zen style, neon jade glow, 9:16, 2K, PNG.';
        var payload={prompt:prompt,aspect_ratio:'9:16',resolution:'2K',output_format:'png'};
        var epsCreate=['/api/kie/createTask','http://localhost:5502/api/kie/createTask'];
        var taskId='';
        for(var i=0;i<epsCreate.length;i++){
          try{
            var r=await fetch(epsCreate[i],{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
            var j=await r.json();
            if(j&&j.success&&j.taskId){taskId=j.taskId;break}
          }catch(_){}
        }
        if(!taskId){statusEl.textContent='KIE error: unable to create task';return}
        statusEl.textContent='Task '+taskId+' started. Polling...';
        var ok=await pollKieTask(taskId,statusEl);
        if(!ok){statusEl.textContent='Polling finished with no result'}
      }catch(e){statusEl.textContent='Failed: '+(e&&e.message||'unknown')}
    }
    async function pollKieTask(taskId,statusEl){
      var card=document.getElementById('card');
      var epsQuery=['/api/kie/queryTask?taskId='+encodeURIComponent(taskId),'http://localhost:5502/api/kie/queryTask?taskId='+encodeURIComponent(taskId)];
      var deadline=Date.now()+60000;
      while(Date.now()<deadline){
        var data=null;
        for(var i=0;i<epsQuery.length;i++){
          try{
            var r=await fetch(epsQuery[i]);
            data=await r.json();
            break;
          }catch(_){}
        }
        if(data){
          var state=(data.state)||((data.raw&&data.raw.data&&data.raw.data.state)||'');
          if(state==='success'){
            var url=data.resultUrl||'';
            if(!url){
              try{var p=JSON.parse((data.raw&&data.raw.data&&data.raw.data.resultJson)||'{}');url=(p.resultUrls&&p.resultUrls[0])||''}catch(_){}
            }
            if(url){
              card.style.backgroundImage='url("'+url+'")';
              statusEl.textContent='Generated';
              return true;
            }
            statusEl.textContent='Success with empty url';
            return false;
          }
          if(state==='fail'){statusEl.textContent='Task failed';return false}
        }
        await new Promise(function(r){setTimeout(r,2000)});
      }
      statusEl.textContent='Timeout';
      return false;
    }
    document.getElementById('genViaKie').addEventListener('click',function(){genCardViaKIE()})
    document.getElementById('edit').addEventListener('click',function(){var next='input.html?order_id='+encodeURIComponent(orderId);if(testMode){next+='&test=1'};window.location.href=next})
    document.getElementById('generate').addEventListener('click',async function(){try{var d=JSON.parse(session||'{}');var el=document.getElementById('report');el.textContent='Generating...';var r=await tryGenerate(d);el.textContent=r}catch(e){}})
    document.getElementById('copy').addEventListener('click',function(){var t=document.getElementById('report').textContent||'';navigator.clipboard.writeText(t)})
    setTimeout(function(){document.getElementById('generate').click()},300)
  </script>
</body>
</html>
