<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…è´¹å…«å­—æ’ç›˜ä¸MBTIäººæ ¼åˆ†æ - NatalCodex | åœ¨çº¿ç”Ÿæˆçµé­‚å¥‘åˆå¡</title>

  <!-- SEO Meta Tags -->
  <meta name="description" content="å…è´¹åœ¨çº¿å…«å­—æ’ç›˜å·¥å…·ï¼ŒAIæ™ºèƒ½åˆ†æå…«å­—å‘½ç†ä¸MBTIäººæ ¼ï¼Œç”Ÿæˆ3000å­—æ·±åº¦æŠ¥å‘Šå’Œç²¾ç¾çµé­‚å¥‘åˆå¡ã€‚æ”¯æŒçœŸå¤ªé˜³æ—¶è®¡ç®—ï¼Œå…¨çƒ200+åŸå¸‚æ—¶åŒºè‡ªåŠ¨è¯†åˆ«ã€‚">
  <meta name="keywords" content="å…«å­—æ’ç›˜, å…è´¹å…«å­—æ’ç›˜, åœ¨çº¿å…«å­—æ’ç›˜, å…«å­—æµ‹ç®—, å…«å­—å‘½ç†åˆ†æ, MBTIæµ‹è¯•, MBTIäººæ ¼åˆ†æ, AIç®—å‘½, çµé­‚å¥‘åˆå¡, èŒä¸šæµ‹è¯„, ç”Ÿè¾°å…«å­—æŸ¥è¯¢">
  <meta name="author" content="NatalCodex">
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
  <link rel="canonical" href="https://natalcodex.com/generate.html">

  <!-- Hreflang for multilingual -->
  <link rel="alternate" hreflang="zh-CN" href="https://natalcodex.com/generate.html">
  <link rel="alternate" hreflang="en" href="https://natalcodex.com/generate.html?lang=en">
  <link rel="alternate" hreflang="x-default" href="https://natalcodex.com/generate.html">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://natalcodex.com/generate.html">
  <meta property="og:title" content="å…è´¹å…«å­—æ’ç›˜ä¸MBTIäººæ ¼åˆ†æ - NatalCodex">
  <meta property="og:description" content="AIæ™ºèƒ½åˆ†æå…«å­—å‘½ç†ä¸MBTIäººæ ¼ï¼Œç”Ÿæˆæ·±åº¦æŠ¥å‘Šå’Œç²¾ç¾çµé­‚å¥‘åˆå¡ã€‚å®Œå…¨å…è´¹ï¼">
  <meta property="og:image" content="https://natalcodex.com/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:site_name" content="NatalCodex">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:locale:alternate" content="en_US">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://natalcodex.com/generate.html">
  <meta name="twitter:title" content="å…è´¹å…«å­—æ’ç›˜ä¸MBTIäººæ ¼åˆ†æ - NatalCodex">
  <meta name="twitter:description" content="AIæ™ºèƒ½åˆ†æå…«å­—å‘½ç†ä¸MBTIäººæ ¼ï¼Œç”Ÿæˆæ·±åº¦æŠ¥å‘Šå’Œç²¾ç¾çµé­‚å¥‘åˆå¡ã€‚å®Œå…¨å…è´¹ï¼">
  <meta name="twitter:image" content="https://natalcodex.com/og-image.png">

  <!-- JSON-LD Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "NatalCodex å…«å­—æ’ç›˜ç”Ÿæˆå™¨",
    "url": "https://natalcodex.com/generate.html",
    "applicationCategory": "LifestyleApplication",
    "operatingSystem": "All",
    "browserRequirements": "Requires JavaScript",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "description": "å…è´¹åœ¨çº¿å…«å­—æ’ç›˜å·¥å…·ï¼ŒAIæ™ºèƒ½åˆ†æå…«å­—å‘½ç†ä¸MBTIäººæ ¼ï¼Œç”Ÿæˆæ·±åº¦æŠ¥å‘Šå’Œçµé­‚å¥‘åˆå¡",
    "featureList": [
      "å…«å­—æ’ç›˜è®¡ç®—",
      "çœŸå¤ªé˜³æ—¶ç²¾ç®—",
      "MBTIäººæ ¼åˆ†æ",
      "åº“å¾·å°”èŒä¸šæµ‹è¯„",
      "AIç”Ÿæˆçµé­‚å¡ç‰‡",
      "3000å­—æ·±åº¦æŠ¥å‘Š",
      "å…¨çƒ200+åŸå¸‚æ”¯æŒ"
    ],
    "screenshot": "https://natalcodex.com/soulprint-card.webp.png"
  }
  </script>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <!-- Theme Color -->
  <meta name="theme-color" content="#0a0e27">
  <meta name="msapplication-TileColor" content="#0a0e27">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
  <style>
    * {margin:0;padding:0;box-sizing:border-box}
    body {
      font-family:'Inter',sans-serif;
      background:linear-gradient(135deg,#0a0e27 0%,#1a1f4d 50%,#2d1f4d 100%);
      color:#fff;
      min-height:100vh;
      padding:40px 20px;
    }
    .container {
      max-width:900px;
      margin:0 auto;
    }
    .header {
      text-align:center;
      margin-bottom:48px;
    }
    .logo {
      font-size:36px;
      font-weight:600;
      color:#00ff9d;
      text-shadow:0 0 18px rgba(0,255,157,.55);
      margin-bottom:12px;
    }
    .subtitle {
      font-size:16px;
      color:#d4d4d8;
    }

    .form-section {
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(0,255,157,0.2);
      border-radius:16px;
      padding:40px;
      margin-bottom:32px;
      backdrop-filter:blur(10px);
    }
    .form-grid {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:24px;
      margin-bottom:24px;
    }
    .form-group {
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .form-group.full {
      grid-column:1 / -1;
    }
    label {
      font-size:14px;
      font-weight:600;
      color:#e5e7eb;
    }
    input, select {
      padding:12px 16px;
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(0,255,157,0.3);
      border-radius:8px;
      color:#fff;
      font-size:15px;
      font-family:'Inter',sans-serif;
      transition:all 0.3s ease;
    }
    input:focus, select:focus {
      outline:none;
      border-color:#00ff9d;
      background:rgba(255,255,255,0.12);
      box-shadow:0 0 0 3px rgba(0,255,157,0.1);
    }
    input::placeholder {
      color:#9ca3af;
    }

    .btn {
      width:100%;
      padding:16px;
      background:linear-gradient(135deg,#00ff9d 0%,#00d4aa 100%);
      color:#0a0e27;
      font-size:16px;
      font-weight:700;
      border:none;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.25s ease;
      box-shadow:0 6px 22px rgba(0,255,157,0.42);
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .btn:hover:not(:disabled) {
      transform:translateY(-2px);
      box-shadow:0 10px 30px rgba(0,255,157,0.6);
    }
    .btn:disabled {
      opacity:0.6;
      cursor:not-allowed;
    }

    .result-section {
      display:none;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(0,255,157,0.2);
      border-radius:16px;
      padding:40px;
      backdrop-filter:blur(10px);
    }
    .result-section.active {
      display:block;
    }
    .result-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:24px;
      padding-bottom:16px;
      border-bottom:1px solid rgba(0,255,157,0.2);
    }
    .result-title {
      font-size:24px;
      font-weight:700;
      color:#00ff9d;
    }
    .copy-btn {
      padding:10px 20px;
      background:rgba(0,255,157,0.2);
      border:1px solid #00ff9d;
      border-radius:8px;
      color:#00ff9d;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.3s ease;
    }
    .copy-btn:hover {
      background:#00ff9d;
      color:#0a0e27;
    }
    .copy-btn.copied {
      background:#00ff9d;
      color:#0a0e27;
    }

    .report-content {
      line-height:1.8;
      color:#e5e7eb;
    }
    .report-content h1 {
      font-size:28px;
      color:#00ff9d;
      margin:32px 0 16px;
      font-weight:700;
    }
    .report-content h2 {
      font-size:22px;
      color:#00d4aa;
      margin:28px 0 14px;
      font-weight:700;
    }
    .report-content h3 {
      font-size:18px;
      color:#00ff9d;
      margin:24px 0 12px;
      font-weight:600;
    }
    .report-content p {
      margin:12px 0;
    }
    .report-content ul, .report-content ol {
      margin:12px 0;
      padding-left:24px;
    }
    .report-content li {
      margin:8px 0;
    }
    .report-content strong {
      color:#fff;
      font-weight:600;
    }
    .report-content hr {
      border:none;
      border-top:1px solid rgba(0,255,157,0.2);
      margin:32px 0;
    }
    .report-content code {
      background:rgba(0,255,157,0.1);
      padding:2px 6px;
      border-radius:4px;
      color:#00ff9d;
      font-size:0.95em;
    }

    .loading {
      text-align:center;
      padding:40px;
      display:none;
    }
    .loading.active {
      display:block;
    }
    .spinner {
      width:60px;
      height:60px;
      border:4px solid rgba(0,255,157,0.2);
      border-top-color:#00ff9d;
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin:0 auto 20px;
    }
    @keyframes spin {
      to {transform:rotate(360deg)}
    }
    .loading-text {
      font-size:16px;
      color:#d4d4d8;
    }

    .error {
      display:none;
      padding:16px;
      background:rgba(239,68,68,0.1);
      border:1px solid rgba(239,68,68,0.3);
      border-radius:8px;
      color:#fca5a5;
      margin-bottom:24px;
    }
    .error.active {
      display:block;
    }

    .help-text {
      font-size:13px;
      color:#9ca3af;
      margin-top:4px;
    }
    .back-link {
      display:inline-block;
      margin-bottom:24px;
      padding:8px 16px;
      background:rgba(0,255,157,0.1);
      border:1px solid rgba(0,255,157,0.3);
      border-radius:8px;
      color:#00ff9d;
      text-decoration:none;
      font-size:14px;
      transition:all 0.3s ease;
    }
    .back-link:hover {
      background:rgba(0,255,157,0.2);
      border-color:#00ff9d;
    }

    @media (max-width:768px) {
      .container {
        padding:20px 16px;
      }
      .header {
        margin-bottom:32px;
      }
      .logo {
        font-size:28px;
      }
      .subtitle {
        font-size:14px;
      }
      .form-grid {
        grid-template-columns:1fr;
        gap:20px;
      }
      .form-section {
        padding:24px 20px;
      }
      .result-section {
        padding:24px 20px;
      }
      .result-header {
        flex-direction:column;
        gap:12px;
        align-items:flex-start;
      }
      .result-header > div {
        width:100%;
      }
      .copy-btn {
        width:100%;
        padding:12px 16px;
      }
      .report-content h1 {
        font-size:22px;
      }
      .report-content h2 {
        font-size:18px;
      }
      .report-content h3 {
        font-size:16px;
      }
      .report-type-container {
        flex-direction:column !important;
        gap:12px !important;
      }
      .report-type-option {
        padding:14px 16px !important;
      }
    }

    /* Auth Modal Styles */
    .auth-overlay {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.8);
      backdrop-filter:blur(8px);
      z-index:1000;
      align-items:center;
      justify-content:center;
    }
    .auth-overlay.active {
      display:flex;
    }
    .auth-modal {
      background:linear-gradient(135deg,#0a0e27 0%,#1a1f4d 100%);
      border:1px solid rgba(0,255,157,0.3);
      border-radius:20px;
      padding:40px;
      max-width:420px;
      width:90%;
      position:relative;
      box-shadow:0 20px 60px rgba(0,255,157,0.2);
    }
    .auth-close {
      position:absolute;
      top:16px;
      right:16px;
      background:none;
      border:none;
      color:#9ca3af;
      font-size:24px;
      cursor:pointer;
      transition:color 0.2s;
    }
    .auth-close:hover {
      color:#fff;
    }
    .auth-title {
      font-size:28px;
      font-weight:700;
      color:#00ff9d;
      text-align:center;
      margin-bottom:8px;
    }
    .auth-subtitle {
      color:#9ca3af;
      text-align:center;
      margin-bottom:32px;
      font-size:14px;
    }
    .auth-form {
      display:flex;
      flex-direction:column;
      gap:20px;
    }
    .auth-input {
      padding:14px 16px;
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(0,255,157,0.3);
      border-radius:10px;
      color:#fff;
      font-size:15px;
      transition:all 0.3s ease;
    }
    .auth-input:focus {
      outline:none;
      border-color:#00ff9d;
      background:rgba(255,255,255,0.12);
    }
    .auth-input::placeholder {
      color:#6b7280;
    }
    .auth-btn {
      padding:16px;
      background:linear-gradient(135deg,#00ff9d 0%,#00d4aa 100%);
      color:#0a0e27;
      font-size:16px;
      font-weight:700;
      border:none;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.25s ease;
      box-shadow:0 6px 22px rgba(0,255,157,0.42);
    }
    .auth-btn:hover:not(:disabled) {
      transform:translateY(-2px);
      box-shadow:0 10px 30px rgba(0,255,157,0.6);
    }
    .auth-btn:disabled {
      opacity:0.6;
      cursor:not-allowed;
    }
    .auth-switch {
      text-align:center;
      margin-top:20px;
      color:#9ca3af;
      font-size:14px;
    }
    .auth-switch a {
      color:#00ff9d;
      text-decoration:none;
      font-weight:600;
      cursor:pointer;
    }
    .auth-switch a:hover {
      text-decoration:underline;
    }
    .auth-error {
      display:none;
      padding:12px;
      background:rgba(239,68,68,0.1);
      border:1px solid rgba(239,68,68,0.3);
      border-radius:8px;
      color:#fca5a5;
      font-size:14px;
      text-align:center;
    }
    .auth-error.active {
      display:block;
    }
    .auth-divider {
      display:flex;
      align-items:center;
      margin:24px 0;
      color:#6b7280;
      font-size:13px;
    }
    .auth-divider::before,
    .auth-divider::after {
      content:'';
      flex:1;
      height:1px;
      background:rgba(255,255,255,0.1);
    }
    .auth-divider span {
      padding:0 16px;
    }
    .google-btn {
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      padding:14px;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.2);
      border-radius:10px;
      color:#fff;
      font-size:15px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.3s ease;
    }
    .google-btn:hover {
      background:rgba(255,255,255,0.1);
      border-color:rgba(255,255,255,0.3);
    }
    .google-btn:disabled {
      opacity:0.5;
      cursor:not-allowed;
    }
    .google-icon {
      width:20px;
      height:20px;
    }
    /* User menu styles */
    .user-menu {
      position:relative;
    }
    .user-avatar-btn {
      width:36px;
      height:36px;
      border-radius:50%;
      background:linear-gradient(135deg, #00ff9d 0%, #00d4aa 100%);
      border:2px solid rgba(0,255,157,0.5);
      color:#0a0e27;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
      transition:all 0.3s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      text-transform:uppercase;
    }
    .user-avatar-btn:hover {
      transform:scale(1.1);
      box-shadow:0 0 15px rgba(0,255,157,0.5);
    }
    .user-dropdown {
      display:none;
      position:absolute;
      top:100%;
      right:0;
      margin-top:8px;
      background:#0a0e27;
      border:1px solid rgba(0,255,157,0.3);
      border-radius:8px;
      padding:8px 0;
      min-width:200px;
      box-shadow:0 10px 30px rgba(0,0,0,0.5);
      z-index:1000;
    }
    .user-dropdown.active {
      display:block;
    }
    .user-dropdown-email {
      padding:10px 16px;
      color:#00ff9d;
      font-size:13px;
      border-bottom:none;
      word-break:break-all;
    }
    .user-dropdown-divider {
      height:1px;
      background:rgba(0,255,157,0.2);
      margin:4px 12px;
    }
    .user-dropdown-item {
      padding:10px 16px;
      color:#d4d4d8;
      font-size:14px;
      cursor:pointer;
      transition:background 0.2s;
    }
    .user-dropdown-item:hover {
      background:rgba(0,255,157,0.1);
      color:#00ff9d;
    }

    /* Credits Display */
    .credits-section {
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .credits-badge {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 14px;
      background:rgba(0,255,157,0.1);
      border:1px solid rgba(0,255,157,0.3);
      border-radius:20px;
      color:#00ff9d;
      font-size:14px;
      font-weight:600;
      transition:all 0.2s;
    }
    .credits-badge .credit-icon {
      font-size:16px;
    }
    .credits-buy-btn {
      padding:6px 14px;
      background:linear-gradient(135deg, #00ff9d, #00d4ff);
      border:none;
      border-radius:20px;
      color:#0a0a0a;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
    }
    .credits-buy-btn:hover {
      transform:scale(1.05);
      box-shadow:0 0 15px rgba(0,255,157,0.4);
    }

    /* Purchase Modal */
    .purchase-overlay {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.85);
      backdrop-filter:blur(8px);
      z-index:1000;
      align-items:center;
      justify-content:center;
    }
    .purchase-overlay.active {
      display:flex;
    }
    .purchase-modal {
      background:linear-gradient(135deg,#0a0e27 0%,#1a1f4d 100%);
      border:1px solid rgba(0,255,157,0.3);
      border-radius:24px;
      padding:40px;
      max-width:520px;
      width:90%;
      position:relative;
      box-shadow:0 20px 60px rgba(0,255,157,0.2);
    }
    .purchase-close {
      position:absolute;
      top:16px;
      right:16px;
      background:none;
      border:none;
      color:#9ca3af;
      font-size:24px;
      cursor:pointer;
    }
    .purchase-close:hover {
      color:#fff;
    }
    .purchase-title {
      font-size:26px;
      font-weight:700;
      color:#00ff9d;
      text-align:center;
      margin-bottom:8px;
    }
    .purchase-subtitle {
      color:#9ca3af;
      text-align:center;
      margin-bottom:28px;
      font-size:14px;
    }
    .purchase-credits-display {
      text-align:center;
      padding:16px;
      background:rgba(239,68,68,0.1);
      border:1px solid rgba(239,68,68,0.3);
      border-radius:12px;
      margin-bottom:24px;
    }
    .purchase-credits-display.has-credits {
      background:rgba(0,255,157,0.1);
      border-color:rgba(0,255,157,0.3);
    }
    .purchase-credits-display .value {
      font-size:32px;
      font-weight:700;
      color:#fff;
    }
    .purchase-credits-display .label {
      color:#9ca3af;
      font-size:14px;
    }
    .package-grid {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
      margin-bottom:24px;
    }
    .package-card {
      padding:20px;
      background:rgba(255,255,255,0.03);
      border:2px solid rgba(255,255,255,0.1);
      border-radius:16px;
      cursor:pointer;
      transition:all 0.2s;
      text-align:center;
    }
    .package-card:hover {
      border-color:rgba(0,255,157,0.5);
    }
    .package-card.selected {
      border-color:#00ff9d;
      background:rgba(0,255,157,0.08);
    }
    .package-card.recommended {
      position:relative;
    }
    .package-card.recommended::before {
      content:'æ¨è';
      position:absolute;
      top:-10px;
      right:-10px;
      padding:4px 10px;
      background:#00ff9d;
      color:#0a0e27;
      font-size:12px;
      font-weight:700;
      border-radius:20px;
    }
    .package-credits {
      font-size:28px;
      font-weight:700;
      color:#fff;
    }
    .package-credits span {
      font-size:14px;
      color:#9ca3af;
      font-weight:400;
    }
    .package-price {
      font-size:22px;
      font-weight:700;
      color:#00ff9d;
      margin-top:8px;
    }
    .package-price.discounted {
      color:#eab308;
    }
    .package-original {
      font-size:14px;
      color:#6b7280;
      text-decoration:line-through;
    }
    .package-unit {
      font-size:12px;
      color:#6b7280;
      margin-top:4px;
    }
    .promo-section {
      margin-bottom:24px;
    }
    .promo-row {
      display:flex;
      gap:12px;
    }
    .promo-input {
      flex:1;
      padding:12px 16px;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.2);
      border-radius:10px;
      color:#fff;
      font-size:14px;
      text-transform:uppercase;
    }
    .promo-input:focus {
      outline:none;
      border-color:#00ff9d;
    }
    .promo-btn {
      padding:12px 20px;
      background:rgba(0,255,157,0.2);
      border:1px solid #00ff9d;
      border-radius:10px;
      color:#00ff9d;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
    }
    .promo-btn:hover {
      background:#00ff9d;
      color:#0a0e27;
    }
    .promo-result {
      margin-top:12px;
      padding:10px 14px;
      border-radius:8px;
      font-size:13px;
    }
    .promo-result.success {
      background:rgba(0,255,157,0.1);
      border:1px solid rgba(0,255,157,0.3);
      color:#00ff9d;
    }
    .promo-result.error {
      background:rgba(239,68,68,0.1);
      border:1px solid rgba(239,68,68,0.3);
      color:#fca5a5;
    }
    .purchase-btn {
      width:100%;
      padding:16px;
      background:linear-gradient(135deg,#00ff9d 0%,#00d4aa 100%);
      color:#0a0e27;
      font-size:16px;
      font-weight:700;
      border:none;
      border-radius:12px;
      cursor:pointer;
      transition:all 0.25s ease;
      box-shadow:0 6px 22px rgba(0,255,157,0.42);
    }
    .purchase-btn:hover:not(:disabled) {
      transform:translateY(-2px);
      box-shadow:0 10px 30px rgba(0,255,157,0.6);
    }
    .purchase-btn:disabled {
      opacity:0.6;
      cursor:not-allowed;
    }
    .purchase-note {
      text-align:center;
      margin-top:16px;
      color:#6b7280;
      font-size:12px;
    }

    /* QR Code Payment Modal */
    .qrcode-overlay {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.85);
      backdrop-filter:blur(8px);
      z-index:1100;
      align-items:center;
      justify-content:center;
    }
    .qrcode-overlay.active {
      display:flex;
    }
    .qrcode-modal {
      background:linear-gradient(135deg,#0a0e27 0%,#1a1f4d 100%);
      border:1px solid rgba(0,255,157,0.3);
      border-radius:24px;
      padding:40px;
      max-width:400px;
      width:90%;
      position:relative;
      box-shadow:0 20px 60px rgba(0,255,157,0.2);
      text-align:center;
    }
    .qrcode-close {
      position:absolute;
      top:16px;
      right:16px;
      background:none;
      border:none;
      color:#9ca3af;
      font-size:24px;
      cursor:pointer;
    }
    .qrcode-close:hover {
      color:#fff;
    }
    .qrcode-title {
      font-size:22px;
      font-weight:700;
      color:#00ff9d;
      margin-bottom:8px;
    }
    .qrcode-subtitle {
      color:#9ca3af;
      font-size:14px;
      margin-bottom:24px;
    }
    .qrcode-image-container {
      background:#fff;
      border-radius:16px;
      padding:16px;
      margin-bottom:20px;
      display:inline-block;
    }
    .qrcode-image-container img {
      width:200px;
      height:200px;
      display:block;
    }
    .qrcode-amount {
      font-size:28px;
      font-weight:700;
      color:#00ff9d;
      margin-bottom:8px;
    }
    .qrcode-package {
      color:#d4d4d8;
      font-size:14px;
      margin-bottom:16px;
    }
    .qrcode-status {
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:12px;
      background:rgba(251,191,36,0.1);
      border:1px solid rgba(251,191,36,0.3);
      border-radius:10px;
      color:#fbbf24;
      font-size:14px;
    }
    .qrcode-status.success {
      background:rgba(0,255,157,0.1);
      border-color:rgba(0,255,157,0.3);
      color:#00ff9d;
    }
    .qrcode-status .spinner-small {
      width:16px;
      height:16px;
      border:2px solid rgba(251,191,36,0.3);
      border-top-color:#fbbf24;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    .qrcode-timer {
      margin-top:12px;
      color:#6b7280;
      font-size:12px;
    }
    .qrcode-error {
      display:none;
      flex-direction:column;
      align-items:center;
      gap:16px;
      padding:20px;
    }
    .qrcode-error.active {
      display:flex;
    }
    .qrcode-error-icon {
      font-size:48px;
    }
    .qrcode-error-msg {
      color:#f87171;
      font-size:14px;
      text-align:center;
    }
    .qrcode-retry-btn {
      padding:12px 32px;
      background:linear-gradient(135deg,#00ff9d 0%,#00d4aa 100%);
      color:#0a0e27;
      font-size:14px;
      font-weight:600;
      border:none;
      border-radius:8px;
      cursor:pointer;
      transition:all 0.2s ease;
    }
    .qrcode-retry-btn:hover:not(:disabled) {
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(0,255,157,0.4);
    }
    .qrcode-retry-btn:disabled {
      opacity:0.6;
      cursor:not-allowed;
    }
    .qrcode-content {
      /* Container for normal QR code display */
    }
  </style>
</head>
<body>
  <!-- Auth Modal -->
  <div class="auth-overlay" id="authOverlay">
    <div class="auth-modal">
      <button class="auth-close" id="authClose">&times;</button>
      
      <!-- Login Form -->
      <div id="loginForm">
        <h2 class="auth-title" data-i18n="authLoginTitle">ç™»å½•</h2>
        <p class="auth-subtitle" data-i18n="authLoginSubtitle">ç™»å½•åå³å¯ç”ŸæˆæŠ¥å‘Šå’Œå¡ç‰‡</p>
        
        <div class="auth-error" id="loginError"></div>
        
        <form class="auth-form" id="loginFormEl">
          <input type="email" class="auth-input" id="loginEmail" data-i18n-placeholder="authEmail" placeholder="é‚®ç®±åœ°å€" required>
          <input type="password" class="auth-input" id="loginPassword" data-i18n-placeholder="authPassword" placeholder="å¯†ç " required>
          <button type="submit" class="auth-btn" id="loginBtn" data-i18n="authLoginBtn">ç™»å½•</button>
        </form>
        
        <div class="auth-divider"><span data-i18n="authOr">æˆ–</span></div>
        
        <button class="google-btn" id="googleLoginBtn">
          <svg class="google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          <span data-i18n="authGoogleBtn">Google ç™»å½•</span>
        </button>
        
        <p class="auth-switch">
          <span data-i18n="authNoAccount">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span>
          <a id="showRegister" data-i18n="authRegisterLink">ç«‹å³æ³¨å†Œ</a>
        </p>
      </div>
      
      <!-- Register Form -->
      <div id="registerForm" style="display:none">
        <h2 class="auth-title" data-i18n="authRegisterTitle">æ³¨å†Œ</h2>
        <p class="auth-subtitle" data-i18n="authRegisterSubtitle">åˆ›å»ºè´¦å·å¼€å§‹æ¢ç´¢ä½ çš„çµé­‚å¯†ç </p>
        
        <div class="auth-error" id="registerError"></div>
        
        <form class="auth-form" id="registerFormEl">
          <input type="email" class="auth-input" id="registerEmail" data-i18n-placeholder="authEmail" placeholder="é‚®ç®±åœ°å€" required>
          <input type="password" class="auth-input" id="registerPassword" data-i18n-placeholder="authPassword" placeholder="å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" required minlength="6">
          <input type="password" class="auth-input" id="registerConfirm" data-i18n-placeholder="authConfirmPassword" placeholder="ç¡®è®¤å¯†ç " required minlength="6">
          <button type="submit" class="auth-btn" id="registerBtn" data-i18n="authRegisterBtn">æ³¨å†Œ</button>
        </form>
        
        <p class="auth-switch">
          <span data-i18n="authHasAccount">å·²æœ‰è´¦å·ï¼Ÿ</span>
          <a id="showLogin" data-i18n="authLoginLink">ç«‹å³ç™»å½•</a>
        </p>
      </div>
    </div>
  </div>

  <!-- Purchase Modal -->
  <div class="purchase-overlay" id="purchaseOverlay">
    <div class="purchase-modal">
      <button class="purchase-close" id="purchaseClose">&times;</button>
      <h2 class="purchase-title" data-i18n="purchaseTitle">è´­ä¹°æ¬¡æ•°</h2>
      <p class="purchase-subtitle" data-i18n="purchaseSubtitle">ä¸€æ¬¡å¯ç”Ÿæˆä¸€ä»½æŠ¥å‘ŠåŠå…¶é…å¥—å¡ç‰‡</p>
      
      <div class="purchase-credits-display" id="purchaseCreditsDisplay">
        <div class="value" id="purchaseCreditsValue">0</div>
        <div class="label" data-i18n="purchaseCreditsLabel">å‰©ä½™æ¬¡æ•°</div>
      </div>

      <div class="package-grid">
        <div class="package-card recommended selected" data-package="PACK_6">
          <div class="package-credits">6<span>æ¬¡</span></div>
          <div class="package-price" id="price6">Â¥29</div>
          <div class="package-original" id="original6" style="display:none">Â¥29</div>
          <div class="package-unit">Â¥4.83/æ¬¡</div>
        </div>
        <div class="package-card" data-package="PACK_20">
          <div class="package-credits">20<span>æ¬¡</span></div>
          <div class="package-price" id="price20">Â¥89</div>
          <div class="package-original" id="original20" style="display:none">Â¥89</div>
          <div class="package-unit">Â¥4.45/æ¬¡</div>
        </div>
      </div>

      <div class="promo-section">
        <div class="promo-row">
          <input type="text" class="promo-input" id="promoInput" placeholder="ä¼˜æƒ ç ï¼ˆå¯é€‰ï¼‰" maxlength="6">
          <button type="button" class="promo-btn" id="promoValidateBtn">éªŒè¯</button>
        </div>
        <div class="promo-result" id="promoResult" style="display:none"></div>
      </div>

      <button class="purchase-btn" id="purchaseBtn">æ”¯ä»˜å®æ”¯ä»˜</button>
      <p class="purchase-note" data-i18n="purchaseNote">æ”¯ä»˜å®Œæˆåæ¬¡æ•°è‡ªåŠ¨åˆ°è´¦</p>
    </div>
  </div>

  <!-- QR Code Payment Modal -->
  <div class="qrcode-overlay" id="qrcodeOverlay">
    <div class="qrcode-modal">
      <button class="qrcode-close" id="qrcodeClose">&times;</button>
      <!-- æ­£å¸¸æ”¯ä»˜çŠ¶æ€ -->
      <div class="qrcode-content" id="qrcodeContent">
        <h3 class="qrcode-title">æ”¯ä»˜å®æ‰«ç æ”¯ä»˜</h3>
        <p class="qrcode-subtitle">è¯·ä½¿ç”¨æ”¯ä»˜å®æ‰«æä¸‹æ–¹äºŒç»´ç </p>
        <div class="qrcode-image-container">
          <img id="qrcodeImage" src="" alt="æ”¯ä»˜äºŒç»´ç ">
        </div>
        <div class="qrcode-amount" id="qrcodeAmount">Â¥0</div>
        <div class="qrcode-package" id="qrcodePackage">å¥—é¤åç§°</div>
        <div class="qrcode-status" id="qrcodeStatus">
          <div class="spinner-small"></div>
          <span>ç­‰å¾…æ”¯ä»˜ä¸­...</span>
        </div>
        <div class="qrcode-timer" id="qrcodeTimer">å‰©ä½™æ”¯ä»˜æ—¶é—´ï¼š5:00</div>
      </div>
      <!-- è¶…æ—¶/é”™è¯¯çŠ¶æ€ -->
      <div class="qrcode-error" id="qrcodeError">
        <div class="qrcode-error-icon" id="qrcodeErrorIcon">â°</div>
        <div class="qrcode-error-msg" id="qrcodeErrorMsg">æ”¯ä»˜è¶…æ—¶ï¼ŒäºŒç»´ç å·²å¤±æ•ˆ</div>
        <button class="qrcode-retry-btn" id="qrcodeRetryBtn">åˆ·æ–°äºŒç»´ç </button>
        <p style="color:#6b7280;font-size:12px;margin-top:8px">åŸè®¢å•é‡‘é¢ä¿æŒä¸å˜</p>
      </div>
    </div>
  </div>

  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <a href="index.html" class="back-link">â† <span data-i18n="backHome">è¿”å›é¦–é¡µ</span></a>
      <div style="display:flex;gap:12px;align-items:center">
        <!-- Credits Badge (shown when logged in) -->
        <div class="credits-section" id="creditsBadge" style="display:none">
          <div class="credits-badge">
            <span class="credit-icon">ğŸ«</span>
            <span data-i18n="creditsRemaining">å‰©ä½™</span>:
            <span id="creditsCount">0</span>
            <span data-i18n="creditsUnit">æ¬¡</span>
          </div>
          <button class="credits-buy-btn" id="creditsBuyBtn" data-i18n="creditsBuy">è´­ä¹°</button>
        </div>
        <!-- User Menu (shown when logged in) -->
        <div class="user-menu" id="userMenu" style="display:none">
          <button class="user-avatar-btn" id="userBtn" title="">
            <span id="userInitial">U</span>
          </button>
          <div class="user-dropdown" id="userDropdown">
            <div class="user-dropdown-email" id="userEmail">user@example.com</div>
            <div class="user-dropdown-divider"></div>
            <div class="user-dropdown-item" id="logoutBtn" data-i18n="authLogout">é€€å‡ºç™»å½•</div>
          </div>
        </div>
        <!-- Login Button (shown when not logged in) -->
        <button id="loginTrigger" class="copy-btn" style="border:1px solid rgba(0,255,157,0.3);background:transparent;cursor:pointer;display:none">
          <span>ğŸ”</span> <span data-i18n="authLoginBtn">ç™»å½•</span>
        </button>
        <button id="langSwitch" class="copy-btn" style="border:1px solid rgba(0,255,157,0.3);background:transparent;cursor:pointer">
          <span id="langIcon">ğŸŒ</span> <span id="langText">EN</span>
        </button>
      </div>
    </div>

    <div class="header">
      <div class="logo">NatalCodex</div>
      <div class="subtitle" data-i18n="subtitle">å¡«å†™å‡ºç”Ÿä¿¡æ¯ â†’ ç‚¹å‡»ç”ŸæˆæŠ¥å‘Š â†’ åœ¨æŠ¥å‘Šä¸‹æ–¹ç”Ÿæˆå›¾ç‰‡</div>
    </div>

    <div class="form-section">
      <form id="generateForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="name" data-i18n="labelName">å§“å</label>
            <input type="text" id="name" name="name" data-i18n-placeholder="placeholderName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required>
          </div>

          <div class="form-group">
            <label for="gender" data-i18n="labelGender">æ€§åˆ«</label>
            <select id="gender" name="gender" required>
              <option value="" data-i18n="selectGender">è¯·é€‰æ‹©</option>
              <option value="ç”·" data-i18n="male">ç”·</option>
              <option value="å¥³" data-i18n="female">å¥³</option>
            </select>
          </div>

          <div class="form-group">
            <label for="date" data-i18n="labelDate">å‡ºç”Ÿæ—¥æœŸ</label>
            <input type="date" id="date" name="date" required max="">
          </div>

          <div class="form-group">
            <label for="time" data-i18n="labelTime">å‡ºç”Ÿæ—¶é—´</label>
            <input type="time" id="time" name="time" placeholder="14:30" required>
            <div class="help-text" data-i18n="helpTime">è¯·å°½é‡ç²¾ç¡®åˆ°åˆ†é’Ÿï¼Œç”¨äºè®¡ç®—çœŸå¤ªé˜³æ—¶</div>
          </div>

          <div class="form-group full" style="position:relative">
            <label for="location" data-i18n="labelLocation">å‡ºç”Ÿåœ°ç‚¹</label>
            <input type="text" id="location" name="location" data-i18n-placeholder="placeholderLocation" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬å¸‚æµ·æ·€åŒº" required autocomplete="off">
            <div class="help-text" data-i18n="helpLocation">å…·ä½“åˆ°åŸå¸‚æˆ–åŒºå¿å³å¯ï¼Œç”¨äºçœŸå¤ªé˜³æ—¶ä¿®æ­£</div>
            <!-- City suggestions dropdown -->
            <div id="citySuggestions" style="display:none;position:absolute;left:0;right:0;z-index:20;background:#0a0e27;border:1px solid rgba(0,255,157,0.5);border-radius:8px;margin-top:4px;max-height:200px;overflow-y:auto;top:100%"></div>
          </div>

          <div class="form-group full" id="timezoneGroup" style="display:none">
            <label for="timezone" data-i18n="labelTimezone">æ—¶åŒº</label>
            <input type="text" id="timezone" name="timezone" readonly style="background:rgba(255,255,255,0.05);cursor:not-allowed">
            <div class="help-text" data-i18n="helpTimezone">æ ¹æ®æ‚¨é€‰æ‹©çš„åŸå¸‚è‡ªåŠ¨æ£€æµ‹</div>
          </div>
        </div>

        <div class="error" id="error"></div>

        <div class="form-group full" style="margin-bottom:20px">
          <label data-i18n="labelReportType">æŠ¥å‘Šç±»å‹</label>
          <div class="report-type-container" style="display:flex;gap:16px;margin-top:8px">
            <label class="report-type-option" style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:12px 20px;background:rgba(0,255,157,0.15);border:2px solid #00ff9d;border-radius:8px;flex:1;justify-content:center" id="typeOptionMbti">
              <input type="radio" name="reportType" value="mbti" checked style="accent-color:#00ff9d;width:18px;height:18px">
              <span style="font-weight:600">ğŸ§  <span data-i18n="reportTypeMbti">MBTIäººæ ¼åˆ†æ</span></span>
            </label>
            <label class="report-type-option" style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:12px 20px;background:rgba(255,255,255,0.05);border:2px solid rgba(0,255,157,0.3);border-radius:8px;flex:1;justify-content:center" id="typeOptionKuder">
              <input type="radio" name="reportType" value="kuder" style="accent-color:#00ff9d;width:18px;height:18px">
              <span style="font-weight:600">ğŸ’¼ <span data-i18n="reportTypeKuder">KUDERèŒä¸šæ¨ç®—</span></span>
            </label>
          </div>
          <div class="help-text" data-i18n="helpReportType">é€‰æ‹©MBTIè·å–äººæ ¼åˆ†æ+çµé­‚å¥‘åˆå¡ï¼Œé€‰æ‹©KUDERè·å–èŒä¸šåˆ†æ+å®¿å‘½èŒä¸šå¡</div>
        </div>

        <button type="submit" class="btn" id="submitBtn">
          ğŸ”® <span data-i18n="btnGenerate">ç”ŸæˆæŠ¥å‘Š</span>
        </button>

        <div style="text-align:center;margin-top:16px">
          <button type="button" class="copy-btn" id="fillDemoBtn" style="background:transparent;border:1px solid rgba(0,255,157,0.3)">
            ğŸ“ <span data-i18n="btnDemo">å¡«å……ç¤ºä¾‹æ•°æ®</span>
          </button>
        </div>
      </form>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div class="loading-text" data-i18n="loadingText">AIæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆä¸“å±æŠ¥å‘Šï¼Œè¯·ç¨å€™...</div>
    </div>

    <div class="result-section" id="resultSection">
      <div class="result-header">
        <div class="result-title" data-i18n="resultTitle">æ‚¨çš„ä¸“å±æŠ¥å‘Š</div>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <button class="copy-btn" id="copyBtn">ğŸ“‹ <span data-i18n="btnCopy">å¤åˆ¶æŠ¥å‘Š</span></button>
          <button class="copy-btn" id="downloadBtn">ğŸ’¾ <span data-i18n="btnDownload">ä¸‹è½½TXT</span></button>
        </div>
      </div>

      <!-- Privacy Notice -->
      <div style="background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:8px;padding:12px 16px;margin-bottom:20px;display:flex;align-items:center;gap:10px">
        <span style="font-size:18px">ğŸ”’</span>
        <span style="color:#fbbf24;font-size:13px" data-i18n="privacyNotice">æœ¬ç«™ä¸å­˜å‚¨æ‚¨çš„ä»»ä½•ä¿¡æ¯ï¼Œè¯·åŠæ—¶ä¸‹è½½ä¿å­˜æŠ¥å‘Šå’Œå›¾ç‰‡ã€‚</span>
      </div>

      <div class="report-content" id="reportContent"></div>

      <!-- Generate Card Button - At bottom of report for better UX -->
      <div style="margin-top:32px;padding-top:24px;border-top:1px solid rgba(0,255,157,0.2);text-align:center">
        <button class="btn" id="generateCardBtn" style="max-width:400px;margin:0 auto">
          ğŸ´ <span data-i18n="btnCard">ç”Ÿæˆçµé­‚å¥‘åˆå¡</span>
        </button>
        <p style="color:#9ca3af;font-size:12px;margin-top:12px" data-i18n="cardHint">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ï¼ŒAIå°†ä¸ºæ‚¨ç”Ÿæˆä¸“å±å¡ç‰‡</p>
      </div>

      <!-- Soul Card Section -->
      <div id="cardSection" style="display:none;margin-top:32px;padding-top:24px;border-top:1px solid rgba(0,255,157,0.2)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px">
          <div style="font-size:20px;font-weight:700;color:#00ff9d" data-i18n="cardTitle">æ‚¨çš„çµé­‚å¥‘åˆå¡</div>
          <button class="copy-btn" id="downloadCardBtn">ğŸ’¾ <span data-i18n="btnDownloadCard">ä¸‹è½½å›¾ç‰‡</span></button>
        </div>
        <div id="cardLoading" style="display:none;text-align:center;padding:40px">
          <div class="spinner"></div>
          <div class="loading-text" data-i18n="cardLoading">AIæ­£åœ¨ç”Ÿæˆæ‚¨çš„çµé­‚å¥‘åˆå¡...</div>
          <div id="progressContainer" style="margin-top:20px;max-width:300px;margin-left:auto;margin-right:auto">
            <div style="background:rgba(0,255,157,0.1);border-radius:10px;height:8px;overflow:hidden">
              <div id="progressBar" style="background:linear-gradient(90deg,#00ff9d,#00d4aa);height:100%;width:0%;transition:width 0.3s ease;border-radius:10px"></div>
            </div>
            <div id="progressText" style="margin-top:8px;font-size:12px;color:#9ca3af">0%</div>
            <div id="progressTip" style="margin-top:12px;font-size:13px;color:#d4d4d8" data-i18n="cardProgressTip">å›¾ç‰‡ç”Ÿæˆé€šå¸¸éœ€è¦30-60ç§’...</div>
          </div>
        </div>
        <div id="cardImage" style="text-align:center">
          <img id="soulCardImg" src="" alt="Soul Card" style="max-width:100%;border-radius:12px;box-shadow:0 8px 32px rgba(0,255,157,0.3)">
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    // ========== Translation System ==========
    const translations = {
      zh: {
        backHome: 'è¿”å›é¦–é¡µ',
        subtitle: 'å¡«å†™å‡ºç”Ÿä¿¡æ¯ â†’ ç‚¹å‡»ç”ŸæˆæŠ¥å‘Š â†’ åœ¨æŠ¥å‘Šä¸‹æ–¹ç”Ÿæˆå›¾ç‰‡',
        labelName: 'å§“å',
        placeholderName: 'è¯·è¾“å…¥æ‚¨çš„å§“å',
        labelGender: 'æ€§åˆ«',
        selectGender: 'è¯·é€‰æ‹©',
        male: 'ç”·',
        female: 'å¥³',
        labelDate: 'å‡ºç”Ÿæ—¥æœŸ',
        labelTime: 'å‡ºç”Ÿæ—¶é—´',
        helpTime: 'è¯·å°½é‡ç²¾ç¡®åˆ°åˆ†é’Ÿï¼Œç”¨äºè®¡ç®—çœŸå¤ªé˜³æ—¶',
        labelLocation: 'å‡ºç”Ÿåœ°ç‚¹',
        placeholderLocation: 'æœç´¢åŸå¸‚ï¼ˆä¾‹å¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€New Yorkï¼‰',
        helpLocation: 'è¾“å…¥åŸå¸‚åç§°æœç´¢ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«æ—¶åŒº',
        labelTimezone: 'æ—¶åŒº',
        helpTimezone: 'æ ¹æ®æ‚¨é€‰æ‹©çš„åŸå¸‚è‡ªåŠ¨æ£€æµ‹',
        btnGenerate: 'ç”ŸæˆæŠ¥å‘Š',
        btnDemo: 'å¡«å……ç¤ºä¾‹æ•°æ®',
        loadingText: 'AIæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆä¸“å±æŠ¥å‘Šï¼Œè¯·ç¨å€™...',
        resultTitle: 'æ‚¨çš„ä¸“å±æŠ¥å‘Š',
        btnCopy: 'å¤åˆ¶æŠ¥å‘Š',
        btnDownload: 'ä¸‹è½½TXT',
        btnCopied: 'å·²å¤åˆ¶',
        btnDownloaded: 'å·²ä¸‹è½½',
        errorGenerate: 'ç”Ÿæˆå¤±è´¥ï¼š',
        errorCopy: 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶',
        searching: 'æœç´¢ä¸­...',
        demoFilled: 'å·²å¡«å……',
        btnCard: 'ç”Ÿæˆçµé­‚å¥‘åˆå¡',
        cardTitle: 'æ‚¨çš„çµé­‚å¥‘åˆå¡',
        btnDownloadCard: 'ä¸‹è½½å›¾ç‰‡',
        cardLoading: 'AIæ­£åœ¨ç”Ÿæˆæ‚¨çš„çµé­‚å¥‘åˆå¡...',
        cardGenerating: 'ç”Ÿæˆä¸­...',
        cardError: 'å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼š',
        cardProgressTip: 'å›¾ç‰‡ç”Ÿæˆé€šå¸¸éœ€è¦30-60ç§’...',
        cardProgressTips: ['æ­£åœ¨åˆ†æå…«å­—ä¿¡æ¯...', 'æ­£åœ¨è®¾è®¡å¡ç‰‡å¸ƒå±€...', 'æ­£åœ¨æ¸²æŸ“äº”è¡Œå…ƒç´ ...', 'æ­£åœ¨ç”ŸæˆMBTIå›¾è¡¨...', 'å³å°†å®Œæˆ...'],
        labelReportType: 'æŠ¥å‘Šç±»å‹',
        helpReportType: 'é€‰æ‹©MBTIè·å–äººæ ¼åˆ†æ+çµé­‚å¥‘åˆå¡ï¼Œé€‰æ‹©KUDERè·å–èŒä¸šåˆ†æ+å®¿å‘½èŒä¸šå¡',
        reportTypeMbti: 'MBTIäººæ ¼åˆ†æ',
        reportTypeKuder: 'KUDERèŒä¸šæ¨ç®—',
        btnCardKuder: 'ç”Ÿæˆå®¿å‘½èŒä¸šå¡',
        cardTitleKuder: 'æ‚¨çš„å®¿å‘½èŒä¸šå¡',
        cardLoadingKuder: 'AIæ­£åœ¨ç”Ÿæˆæ‚¨çš„å®¿å‘½èŒä¸šå¡...',
        cardProgressTipsKuder: ['æ­£åœ¨åˆ†æå…«å­—ä¿¡æ¯...', 'æ­£åœ¨åŒ¹é…èŒä¸šé¢†åŸŸ...', 'æ­£åœ¨æ¸²æŸ“åº“å¾·å°”å›¾è¡¨...', 'æ­£åœ¨ç”ŸæˆèŒä¸šå¡...', 'å³å°†å®Œæˆ...'],
        privacyNotice: 'æœ¬ç«™ä¸å­˜å‚¨æ‚¨çš„ä»»ä½•ä¿¡æ¯ï¼Œè¯·åŠæ—¶ä¸‹è½½ä¿å­˜æŠ¥å‘Šå’Œå›¾ç‰‡ã€‚',
        cardHint: 'ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ï¼ŒAIå°†ä¸ºæ‚¨ç”Ÿæˆä¸“å±å¡ç‰‡',
        authLoginTitle: 'ç™»å½•',
        authLoginSubtitle: 'ç™»å½•åå³å¯ç”ŸæˆæŠ¥å‘Šå’Œå¡ç‰‡',
        authRegisterTitle: 'æ³¨å†Œ',
        authRegisterSubtitle: 'åˆ›å»ºè´¦å·å¼€å§‹æ¢ç´¢ä½ çš„çµé­‚å¯†ç ',
        authEmail: 'é‚®ç®±åœ°å€',
        authPassword: 'å¯†ç ',
        authConfirmPassword: 'ç¡®è®¤å¯†ç ',
        authLoginBtn: 'ç™»å½•',
        authRegisterBtn: 'æ³¨å†Œ',
        authOr: 'æˆ–',
        authGoogleBtn: 'Google ç™»å½•',
        authNoAccount: 'è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ',
        authRegisterLink: 'ç«‹å³æ³¨å†Œ',
        authHasAccount: 'å·²æœ‰è´¦å·ï¼Ÿ',
        authLoginLink: 'ç«‹å³ç™»å½•',
        authLogout: 'é€€å‡ºç™»å½•',
        authLoginRequired: 'è¯·å…ˆç™»å½•åå†ç”ŸæˆæŠ¥å‘Š',
        authLoginRequiredCard: 'è¯·å…ˆç™»å½•åå†ç”Ÿæˆå¡ç‰‡',
        authPasswordMismatch: 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´',
        authLoggingIn: 'ç™»å½•ä¸­...',
        authRegistering: 'æ³¨å†Œä¸­...',
        creditsRemaining: 'å‰©ä½™',
        creditsUnit: 'æ¬¡',
        creditsBuy: 'è´­ä¹°'
      },
      en: {
        backHome: 'Back Home',
        subtitle: 'Fill in birth info â†’ Generate report â†’ Create card below report',
        labelName: 'Name',
        placeholderName: 'Enter your name',
        labelGender: 'Gender',
        selectGender: 'Select',
        male: 'Male',
        female: 'Female',
        labelDate: 'Birth Date',
        labelTime: 'Birth Time',
        helpTime: 'Accurate to the minute for true solar time calculation',
        labelLocation: 'Birth Location',
        placeholderLocation: 'Search city (e.g., Beijing, Shanghai, New York)',
        helpLocation: 'Enter city name to search, timezone will be auto-detected',
        labelTimezone: 'Timezone',
        helpTimezone: 'Auto-detected based on your selected city',
        btnGenerate: 'Generate Report',
        btnDemo: 'Fill Demo Data',
        loadingText: 'AI is generating your personalized report, please wait...',
        resultTitle: 'Your Personalized Report',
        btnCopy: 'Copy Report',
        btnDownload: 'Download TXT',
        btnCopied: 'Copied',
        btnDownloaded: 'Downloaded',
        errorGenerate: 'Generation failed: ',
        errorCopy: 'Copy failed, please copy manually',
        searching: 'Searching...',
        demoFilled: 'Filled',
        btnCard: 'Generate Soul Card',
        cardTitle: 'Your Soul Card',
        btnDownloadCard: 'Download Image',
        cardLoading: 'AI is generating your Soul Card...',
        cardGenerating: 'Generating...',
        cardError: 'Image generation failed: ',
        cardProgressTip: 'Image generation usually takes 30-60 seconds...',
        cardProgressTips: ['Analyzing BaZi data...', 'Designing card layout...', 'Rendering Five Elements...', 'Generating MBTI chart...', 'Almost done...'],
        labelReportType: 'Report Type',
        helpReportType: 'Choose MBTI for personality analysis + Soul Card, or KUDER for career analysis + Destiny Career Card',
        reportTypeMbti: 'MBTI Personality',
        reportTypeKuder: 'KUDER Career',
        btnCardKuder: 'Generate Destiny Card',
        cardTitleKuder: 'Your Destiny Career Card',
        cardLoadingKuder: 'AI is generating your Destiny Career Card...',
        cardProgressTipsKuder: ['Analyzing BaZi data...', 'Matching career domains...', 'Rendering Kuder chart...', 'Generating career card...', 'Almost done...'],
        privacyNotice: 'This site does not store your information. Please download and save your reports and images promptly.',
        cardHint: 'Click the button above to generate your exclusive card',
        authLoginTitle: 'Login',
        authLoginSubtitle: 'Login to generate reports and cards',
        authRegisterTitle: 'Register',
        authRegisterSubtitle: 'Create an account to explore your soul code',
        authEmail: 'Email address',
        authPassword: 'Password',
        authConfirmPassword: 'Confirm password',
        authLoginBtn: 'Login',
        authRegisterBtn: 'Register',
        authOr: 'or',
        authGoogleBtn: 'Sign in with Google',
        authNoAccount: "Don't have an account?",
        authRegisterLink: 'Register now',
        authHasAccount: 'Already have an account?',
        authLoginLink: 'Login now',
        authLogout: 'Logout',
        authLoginRequired: 'Please login to generate reports',
        authLoginRequiredCard: 'Please login to generate cards',
        authPasswordMismatch: 'Passwords do not match',
        authLoggingIn: 'Logging in...',
        authRegistering: 'Registering...',
        creditsRemaining: 'Remaining',
        creditsUnit: 'credits',
        creditsBuy: 'Buy'
      }
    };

    let currentLang = localStorage.getItem('nc_language') || 'zh';
    let selectedCity = null;
    let selectedTimezone = null;

    function updateLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('nc_language', lang);

      // Update all elements with data-i18n
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[lang][key]) {
          el.textContent = translations[lang][key];
        }
      });

      // Update placeholders
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (translations[lang][key]) {
          el.placeholder = translations[lang][key];
        }
      });

      // Update language button
      document.getElementById('langText').textContent = lang === 'zh' ? 'EN' : 'ä¸­æ–‡';
    }

    // Initialize language
    updateLanguage(currentLang);

    // Set max date to today (can't select future dates)
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').setAttribute('max', today);

    // Language switcher
    document.getElementById('langSwitch').addEventListener('click', () => {
      const newLang = currentLang === 'zh' ? 'en' : 'zh';
      updateLanguage(newLang);
    });

    // ========== Form Data Persistence (localStorage) ==========
    const STORAGE_KEY = 'nc_form_data';

    // Save form data to localStorage
    function saveFormData() {
      const formData = {
        name: document.getElementById('name').value,
        gender: document.getElementById('gender').value,
        date: document.getElementById('date').value,
        time: document.getElementById('time').value,
        location: document.getElementById('location').value,
        timezone: document.getElementById('timezone').value,
        selectedCity: selectedCity,
        selectedTimezone: selectedTimezone,
        savedAt: Date.now()
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
    }

    // Restore form data from localStorage
    function restoreFormData() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return false;

        const formData = JSON.parse(saved);

        // Check if data is older than 30 days
        const thirtyDays = 30 * 24 * 60 * 60 * 1000;
        if (Date.now() - formData.savedAt > thirtyDays) {
          localStorage.removeItem(STORAGE_KEY);
          return false;
        }

        // Restore form fields
        if (formData.name) document.getElementById('name').value = formData.name;
        if (formData.gender) document.getElementById('gender').value = formData.gender;
        if (formData.date) document.getElementById('date').value = formData.date;
        if (formData.time) document.getElementById('time').value = formData.time;
        if (formData.location) document.getElementById('location').value = formData.location;

        // Restore city and timezone selection
        if (formData.selectedCity) {
          selectedCity = formData.selectedCity;
          selectedTimezone = formData.selectedTimezone;
          if (formData.timezone) {
            document.getElementById('timezone').value = formData.timezone;
            document.getElementById('timezoneGroup').style.display = 'block';
          }
        }

        return true;
      } catch (e) {
        console.error('Failed to restore form data:', e);
        return false;
      }
    }

    // Add event listeners to save form data on input change
    function setupFormPersistence() {
      const fields = ['name', 'gender', 'date', 'time', 'location'];
      fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('change', saveFormData);
          field.addEventListener('blur', saveFormData);
        }
      });
    }

    // Initialize form persistence
    restoreFormData();
    setupFormPersistence();

    // ========== Report Type Selection Visual Feedback ==========
    const typeOptionMbti = document.getElementById('typeOptionMbti');
    const typeOptionKuder = document.getElementById('typeOptionKuder');
    const reportTypeRadios = document.querySelectorAll('input[name="reportType"]');

    function updateReportTypeStyles() {
      const selectedType = document.querySelector('input[name="reportType"]:checked')?.value || 'mbti';
      if (selectedType === 'mbti') {
        typeOptionMbti.style.background = 'rgba(0,255,157,0.15)';
        typeOptionMbti.style.borderColor = '#00ff9d';
        typeOptionKuder.style.background = 'rgba(255,255,255,0.05)';
        typeOptionKuder.style.borderColor = 'rgba(0,255,157,0.3)';
      } else {
        typeOptionKuder.style.background = 'rgba(0,255,157,0.15)';
        typeOptionKuder.style.borderColor = '#00ff9d';
        typeOptionMbti.style.background = 'rgba(255,255,255,0.05)';
        typeOptionMbti.style.borderColor = 'rgba(0,255,157,0.3)';
      }
    }

    reportTypeRadios.forEach(radio => {
      radio.addEventListener('change', (e) => {
        updateReportTypeStyles();
        
        // Update card button text based on selected type
        const selectedType = e.target.value;
        updateCardButtonText(selectedType);
        
        // Check if there's existing report data with different type
        if (lastAnalysisData && lastAnalysisData.reportType) {
          const newType = e.target.value;
          const existingType = lastAnalysisData.reportType;
          
          if (newType !== existingType) {
            const existingTypeName = existingType === 'kuder' ? 'KUDERèŒä¸šåˆ†æ' : 'MBTIäººæ ¼åˆ†æ';
            const newTypeName = newType === 'kuder' ? 'KUDERèŒä¸šåˆ†æ' : 'MBTIäººæ ¼åˆ†æ';
            
            const msg = currentLang === 'zh' 
              ? `âš ï¸ æç¤ºï¼šå½“å‰å·²ç”Ÿæˆ${existingTypeName}æŠ¥å‘Šã€‚\n\nå¦‚æœæ‚¨è¦ç”Ÿæˆ${newTypeName}æŠ¥å‘Šï¼Œè¯·æ³¨æ„ï¼š\n1. å…ˆä¿å­˜å½“å‰æŠ¥å‘Šï¼ˆä¸‹è½½PDF/TXTï¼‰\n2. å†ç‚¹å‡»"ç”ŸæˆæŠ¥å‘Š"æŒ‰é’®\n3. ç”Ÿæˆå¡ç‰‡å‰è¯·ç¡®ä¿å·²ç”Ÿæˆå¯¹åº”ç±»å‹çš„æŠ¥å‘Š`
              : `âš ï¸ Note: You have an existing ${existingType.toUpperCase()} report.\n\nIf you want to generate a ${newType.toUpperCase()} report:\n1. Save current report first (download PDF/TXT)\n2. Click "Generate Report" button\n3. Make sure to generate the matching report before creating cards`;
            
            alert(msg);
          }
        }
      });
    });

    // ========== City Database with Timezone ==========
    const cityDatabase = [
      // ä¸­å›½ä¸»è¦åŸå¸‚
      { zh: 'åŒ—äº¬', en: 'Beijing', pinyin: 'beijing', lat: 39.9042, lon: 116.4074, tz: 'Asia/Shanghai' },
      { zh: 'ä¸Šæµ·', en: 'Shanghai', pinyin: 'shanghai', lat: 31.2304, lon: 121.4737, tz: 'Asia/Shanghai' },
      { zh: 'å¹¿å·', en: 'Guangzhou', pinyin: 'guangzhou', lat: 23.1291, lon: 113.2644, tz: 'Asia/Shanghai' },
      { zh: 'æ·±åœ³', en: 'Shenzhen', pinyin: 'shenzhen', lat: 22.5431, lon: 114.0579, tz: 'Asia/Shanghai' },
      { zh: 'æ­å·', en: 'Hangzhou', pinyin: 'hangzhou', lat: 30.2741, lon: 120.1551, tz: 'Asia/Shanghai' },
      { zh: 'å—äº¬', en: 'Nanjing', pinyin: 'nanjing', lat: 32.0603, lon: 118.7969, tz: 'Asia/Shanghai' },
      { zh: 'æˆéƒ½', en: 'Chengdu', pinyin: 'chengdu', lat: 30.5728, lon: 104.0668, tz: 'Asia/Shanghai' },
      { zh: 'é‡åº†', en: 'Chongqing', pinyin: 'chongqing', lat: 29.4316, lon: 106.9123, tz: 'Asia/Shanghai' },
      { zh: 'æ­¦æ±‰', en: 'Wuhan', pinyin: 'wuhan', lat: 30.5928, lon: 114.3055, tz: 'Asia/Shanghai' },
      { zh: 'è¥¿å®‰', en: "Xi'an", pinyin: 'xian', lat: 34.3416, lon: 108.9398, tz: 'Asia/Shanghai' },
      { zh: 'å¤©æ´¥', en: 'Tianjin', pinyin: 'tianjin', lat: 39.3434, lon: 117.3616, tz: 'Asia/Shanghai' },
      { zh: 'è‹å·', en: 'Suzhou', pinyin: 'suzhou', lat: 31.2990, lon: 120.5853, tz: 'Asia/Shanghai' },
      { zh: 'é’å²›', en: 'Qingdao', pinyin: 'qingdao', lat: 36.0671, lon: 120.3826, tz: 'Asia/Shanghai' },
      { zh: 'å¤§è¿', en: 'Dalian', pinyin: 'dalian', lat: 38.9140, lon: 121.6147, tz: 'Asia/Shanghai' },
      { zh: 'å¦é—¨', en: 'Xiamen', pinyin: 'xiamen', lat: 24.4798, lon: 118.0894, tz: 'Asia/Shanghai' },
      { zh: 'é•¿æ²™', en: 'Changsha', pinyin: 'changsha', lat: 28.2282, lon: 112.9388, tz: 'Asia/Shanghai' },
      { zh: 'éƒ‘å·', en: 'Zhengzhou', pinyin: 'zhengzhou', lat: 34.7466, lon: 113.6253, tz: 'Asia/Shanghai' },
      { zh: 'æ²ˆé˜³', en: 'Shenyang', pinyin: 'shenyang', lat: 41.8057, lon: 123.4315, tz: 'Asia/Shanghai' },
      { zh: 'å“ˆå°”æ»¨', en: 'Harbin', pinyin: 'haerbin', lat: 45.8038, lon: 126.5350, tz: 'Asia/Shanghai' },
      { zh: 'æµå—', en: 'Jinan', pinyin: 'jinan', lat: 36.6512, lon: 117.1201, tz: 'Asia/Shanghai' },
      { zh: 'ç¦å·', en: 'Fuzhou', pinyin: 'fuzhou', lat: 26.0745, lon: 119.2965, tz: 'Asia/Shanghai' },
      { zh: 'æ˜†æ˜', en: 'Kunming', pinyin: 'kunming', lat: 25.0389, lon: 102.7183, tz: 'Asia/Shanghai' },
      { zh: 'æ— é”¡', en: 'Wuxi', pinyin: 'wuxi', lat: 31.4912, lon: 120.3119, tz: 'Asia/Shanghai' },
      { zh: 'å®æ³¢', en: 'Ningbo', pinyin: 'ningbo', lat: 29.8683, lon: 121.5440, tz: 'Asia/Shanghai' },
      { zh: 'åˆè‚¥', en: 'Hefei', pinyin: 'hefei', lat: 31.8206, lon: 117.2272, tz: 'Asia/Shanghai' },
      { zh: 'å—æ˜Œ', en: 'Nanchang', pinyin: 'nanchang', lat: 28.6820, lon: 115.8579, tz: 'Asia/Shanghai' },
      { zh: 'é•¿æ˜¥', en: 'Changchun', pinyin: 'changchun', lat: 43.8171, lon: 125.3235, tz: 'Asia/Shanghai' },
      { zh: 'çŸ³å®¶åº„', en: 'Shijiazhuang', pinyin: 'shijiazhuang', lat: 38.0428, lon: 114.5149, tz: 'Asia/Shanghai' },
      { zh: 'è´µé˜³', en: 'Guiyang', pinyin: 'guiyang', lat: 26.6470, lon: 106.6302, tz: 'Asia/Shanghai' },
      { zh: 'å—å®', en: 'Nanning', pinyin: 'nanning', lat: 22.8170, lon: 108.3665, tz: 'Asia/Shanghai' },
      { zh: 'å¤ªåŸ', en: 'Taiyuan', pinyin: 'taiyuan', lat: 37.8706, lon: 112.5489, tz: 'Asia/Shanghai' },
      { zh: 'ä¹Œé²æœ¨é½', en: 'Urumqi', pinyin: 'wulumuqi', lat: 43.8256, lon: 87.6168, tz: 'Asia/Urumqi' },
      { zh: 'å…°å·', en: 'Lanzhou', pinyin: 'lanzhou', lat: 36.0611, lon: 103.8343, tz: 'Asia/Shanghai' },
      { zh: 'æµ·å£', en: 'Haikou', pinyin: 'haikou', lat: 20.0440, lon: 110.1999, tz: 'Asia/Shanghai' },
      { zh: 'å‘¼å’Œæµ©ç‰¹', en: 'Hohhot', pinyin: 'huhehaote', lat: 40.8424, lon: 111.7490, tz: 'Asia/Shanghai' },
      { zh: 'é“¶å·', en: 'Yinchuan', pinyin: 'yinchuan', lat: 38.4872, lon: 106.2309, tz: 'Asia/Shanghai' },
      { zh: 'è¥¿å®', en: 'Xining', pinyin: 'xining', lat: 36.6171, lon: 101.7782, tz: 'Asia/Shanghai' },
      { zh: 'æ‹‰è¨', en: 'Lhasa', pinyin: 'lasa', lat: 29.6500, lon: 91.1000, tz: 'Asia/Shanghai' },
      // æ¸¯æ¾³å°
      { zh: 'é¦™æ¸¯', en: 'Hong Kong', pinyin: 'xianggang', lat: 22.3193, lon: 114.1694, tz: 'Asia/Hong_Kong' },
      { zh: 'æ¾³é—¨', en: 'Macau', pinyin: 'aomen', lat: 22.1987, lon: 113.5439, tz: 'Asia/Macau' },
      { zh: 'å°åŒ—', en: 'Taipei', pinyin: 'taibei', lat: 25.0330, lon: 121.5654, tz: 'Asia/Taipei' },
      { zh: 'é«˜é›„', en: 'Kaohsiung', pinyin: 'gaoxiong', lat: 22.6273, lon: 120.3014, tz: 'Asia/Taipei' },
      // äºšæ´²å…¶ä»–
      { zh: 'ä¸œäº¬', en: 'Tokyo', pinyin: 'dongjing', lat: 35.6762, lon: 139.6503, tz: 'Asia/Tokyo' },
      { zh: 'å¤§é˜ª', en: 'Osaka', pinyin: 'daban', lat: 34.6937, lon: 135.5023, tz: 'Asia/Tokyo' },
      { zh: 'é¦–å°”', en: 'Seoul', pinyin: 'shouer', lat: 37.5665, lon: 126.9780, tz: 'Asia/Seoul' },
      { zh: 'æ–°åŠ å¡', en: 'Singapore', pinyin: 'xinjiapo', lat: 1.3521, lon: 103.8198, tz: 'Asia/Singapore' },
      { zh: 'æ›¼è°·', en: 'Bangkok', pinyin: 'mangu', lat: 13.7563, lon: 100.5018, tz: 'Asia/Bangkok' },
      { zh: 'å‰éš†å¡', en: 'Kuala Lumpur', pinyin: 'jilongpo', lat: 3.1390, lon: 101.6869, tz: 'Asia/Kuala_Lumpur' },
      { zh: 'é›…åŠ è¾¾', en: 'Jakarta', pinyin: 'yajiade', lat: -6.2088, lon: 106.8456, tz: 'Asia/Jakarta' },
      { zh: 'é©¬å°¼æ‹‰', en: 'Manila', pinyin: 'manila', lat: 14.5995, lon: 120.9842, tz: 'Asia/Manila' },
      { zh: 'æ²³å†…', en: 'Hanoi', pinyin: 'henei', lat: 21.0285, lon: 105.8542, tz: 'Asia/Ho_Chi_Minh' },
      { zh: 'èƒ¡å¿—æ˜å¸‚', en: 'Ho Chi Minh City', pinyin: 'huzhimingshi', lat: 10.8231, lon: 106.6297, tz: 'Asia/Ho_Chi_Minh' },
      { zh: 'å­Ÿä¹°', en: 'Mumbai', pinyin: 'mengmai', lat: 19.0760, lon: 72.8777, tz: 'Asia/Kolkata' },
      { zh: 'æ–°å¾·é‡Œ', en: 'New Delhi', pinyin: 'xindeli', lat: 28.6139, lon: 77.2090, tz: 'Asia/Kolkata' },
      { zh: 'è¿ªæ‹œ', en: 'Dubai', pinyin: 'dibai', lat: 25.2048, lon: 55.2708, tz: 'Asia/Dubai' },
      // æ¬§æ´²
      { zh: 'ä¼¦æ•¦', en: 'London', pinyin: 'lundun', lat: 51.5074, lon: -0.1278, tz: 'Europe/London' },
      { zh: 'å·´é»', en: 'Paris', pinyin: 'bali', lat: 48.8566, lon: 2.3522, tz: 'Europe/Paris' },
      { zh: 'æŸæ—', en: 'Berlin', pinyin: 'bolin', lat: 52.5200, lon: 13.4050, tz: 'Europe/Berlin' },
      { zh: 'ç½—é©¬', en: 'Rome', pinyin: 'luoma', lat: 41.9028, lon: 12.4964, tz: 'Europe/Rome' },
      { zh: 'é©¬å¾·é‡Œ', en: 'Madrid', pinyin: 'madeli', lat: 40.4168, lon: -3.7038, tz: 'Europe/Madrid' },
      { zh: 'é˜¿å§†æ–¯ç‰¹ä¸¹', en: 'Amsterdam', pinyin: 'amusitedan', lat: 52.3676, lon: 4.9041, tz: 'Europe/Amsterdam' },
      { zh: 'è«æ–¯ç§‘', en: 'Moscow', pinyin: 'mosike', lat: 55.7558, lon: 37.6173, tz: 'Europe/Moscow' },
      { zh: 'ç»´ä¹Ÿçº³', en: 'Vienna', pinyin: 'weiyena', lat: 48.2082, lon: 16.3738, tz: 'Europe/Vienna' },
      { zh: 'è‹é»ä¸–', en: 'Zurich', pinyin: 'sulishi', lat: 47.3769, lon: 8.5417, tz: 'Europe/Zurich' },
      { zh: 'æ…•å°¼é»‘', en: 'Munich', pinyin: 'munihei', lat: 48.1351, lon: 11.5820, tz: 'Europe/Berlin' },
      { zh: 'ç±³å…°', en: 'Milan', pinyin: 'milan', lat: 45.4642, lon: 9.1900, tz: 'Europe/Rome' },
      { zh: 'å·´å¡ç½—é‚£', en: 'Barcelona', pinyin: 'basailuona', lat: 41.3851, lon: 2.1734, tz: 'Europe/Madrid' },
      { zh: 'å¸ƒé²å¡å°”', en: 'Brussels', pinyin: 'bulusaier', lat: 50.8503, lon: 4.3517, tz: 'Europe/Brussels' },
      { zh: 'æ–¯å¾·å“¥å°”æ‘©', en: 'Stockholm', pinyin: 'sidegeermo', lat: 59.3293, lon: 18.0686, tz: 'Europe/Stockholm' },
      { zh: 'å“¥æœ¬å“ˆæ ¹', en: 'Copenhagen', pinyin: 'gebenhagen', lat: 55.6761, lon: 12.5683, tz: 'Europe/Copenhagen' },
      { zh: 'èµ«å°”è¾›åŸº', en: 'Helsinki', pinyin: 'heersiji', lat: 60.1699, lon: 24.9384, tz: 'Europe/Helsinki' },
      { zh: 'åæ²™', en: 'Warsaw', pinyin: 'huasha', lat: 52.2297, lon: 21.0122, tz: 'Europe/Warsaw' },
      { zh: 'å¸ƒæ‹‰æ ¼', en: 'Prague', pinyin: 'bulage', lat: 50.0755, lon: 14.4378, tz: 'Europe/Prague' },
      { zh: 'å¸ƒè¾¾ä½©æ–¯', en: 'Budapest', pinyin: 'budapeisi', lat: 47.4979, lon: 19.0402, tz: 'Europe/Budapest' },
      { zh: 'é›…å…¸', en: 'Athens', pinyin: 'yadian', lat: 37.9838, lon: 23.7275, tz: 'Europe/Athens' },
      { zh: 'é‡Œæ–¯æœ¬', en: 'Lisbon', pinyin: 'lisiben', lat: 38.7223, lon: -9.1393, tz: 'Europe/Lisbon' },
      { zh: 'éƒ½æŸæ—', en: 'Dublin', pinyin: 'dubolin', lat: 53.3498, lon: -6.2603, tz: 'Europe/Dublin' },
      { zh: 'çˆ±ä¸å ¡', en: 'Edinburgh', pinyin: 'aidingbao', lat: 55.9533, lon: -3.1883, tz: 'Europe/London' },
      // åŒ—ç¾
      { zh: 'çº½çº¦', en: 'New York', pinyin: 'niuyue', lat: 40.7128, lon: -74.0060, tz: 'America/New_York' },
      { zh: 'æ´›æ‰çŸ¶', en: 'Los Angeles', pinyin: 'luosanji', lat: 34.0522, lon: -118.2437, tz: 'America/Los_Angeles' },
      { zh: 'èŠåŠ å“¥', en: 'Chicago', pinyin: 'zhijiage', lat: 41.8781, lon: -87.6298, tz: 'America/Chicago' },
      { zh: 'æ—§é‡‘å±±', en: 'San Francisco', pinyin: 'jiujinshan', lat: 37.7749, lon: -122.4194, tz: 'America/Los_Angeles' },
      { zh: 'è¥¿é›…å›¾', en: 'Seattle', pinyin: 'xiyatu', lat: 47.6062, lon: -122.3321, tz: 'America/Los_Angeles' },
      { zh: 'æ³¢å£«é¡¿', en: 'Boston', pinyin: 'boshidun', lat: 42.3601, lon: -71.0589, tz: 'America/New_York' },
      { zh: 'åç››é¡¿', en: 'Washington D.C.', pinyin: 'huashengdun', lat: 38.9072, lon: -77.0369, tz: 'America/New_York' },
      { zh: 'è¿ˆé˜¿å¯†', en: 'Miami', pinyin: 'maiami', lat: 25.7617, lon: -80.1918, tz: 'America/New_York' },
      { zh: 'ä¼‘æ–¯é¡¿', en: 'Houston', pinyin: 'xiusidun', lat: 29.7604, lon: -95.3698, tz: 'America/Chicago' },
      { zh: 'è¾¾æ‹‰æ–¯', en: 'Dallas', pinyin: 'dalasi', lat: 32.7767, lon: -96.7970, tz: 'America/Chicago' },
      { zh: 'ä¸¹ä½›', en: 'Denver', pinyin: 'danfo', lat: 39.7392, lon: -104.9903, tz: 'America/Denver' },
      { zh: 'æ‹‰æ–¯ç»´åŠ æ–¯', en: 'Las Vegas', pinyin: 'lasiweijisi', lat: 36.1699, lon: -115.1398, tz: 'America/Los_Angeles' },
      { zh: 'å¤šä¼¦å¤š', en: 'Toronto', pinyin: 'duolunduo', lat: 43.6532, lon: -79.3832, tz: 'America/Toronto' },
      { zh: 'æ¸©å“¥å', en: 'Vancouver', pinyin: 'wengehua', lat: 49.2827, lon: -123.1207, tz: 'America/Vancouver' },
      { zh: 'è’™ç‰¹åˆ©å°”', en: 'Montreal', pinyin: 'mengtelier', lat: 45.5017, lon: -73.5673, tz: 'America/Montreal' },
      { zh: 'å¢¨è¥¿å“¥åŸ', en: 'Mexico City', pinyin: 'moxigecheng', lat: 19.4326, lon: -99.1332, tz: 'America/Mexico_City' },
      // å¤§æ´‹æ´²
      { zh: 'æ‚‰å°¼', en: 'Sydney', pinyin: 'xini', lat: -33.8688, lon: 151.2093, tz: 'Australia/Sydney' },
      { zh: 'å¢¨å°”æœ¬', en: 'Melbourne', pinyin: 'moerben', lat: -37.8136, lon: 144.9631, tz: 'Australia/Melbourne' },
      { zh: 'å¸ƒé‡Œæ–¯ç­', en: 'Brisbane', pinyin: 'bulisiban', lat: -27.4698, lon: 153.0251, tz: 'Australia/Brisbane' },
      { zh: 'ç€æ–¯', en: 'Perth', pinyin: 'posi', lat: -31.9505, lon: 115.8605, tz: 'Australia/Perth' },
      { zh: 'å¥¥å…‹å…°', en: 'Auckland', pinyin: 'aokelan', lat: -36.8509, lon: 174.7645, tz: 'Pacific/Auckland' },
      // å—ç¾
      { zh: 'åœ£ä¿ç½—', en: 'SÃ£o Paulo', pinyin: 'shengbaoluo', lat: -23.5505, lon: -46.6333, tz: 'America/Sao_Paulo' },
      { zh: 'é‡Œçº¦çƒ­å†…å¢', en: 'Rio de Janeiro', pinyin: 'liyuereneilu', lat: -22.9068, lon: -43.1729, tz: 'America/Sao_Paulo' },
      { zh: 'å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯', en: 'Buenos Aires', pinyin: 'buyinuosiailisi', lat: -34.6037, lon: -58.3816, tz: 'America/Argentina/Buenos_Aires' },
      // éæ´²
      { zh: 'å¼€ç½—', en: 'Cairo', pinyin: 'kailuo', lat: 30.0444, lon: 31.2357, tz: 'Africa/Cairo' },
      { zh: 'çº¦ç¿°å†…æ–¯å ¡', en: 'Johannesburg', pinyin: 'yuehanneisibao', lat: -26.2041, lon: 28.0473, tz: 'Africa/Johannesburg' },
      { zh: 'å¼€æ™®æ•¦', en: 'Cape Town', pinyin: 'kaipudun', lat: -33.9249, lon: 18.4241, tz: 'Africa/Johannesburg' }
    ];

    // ========== City Search with Autocomplete ==========
    const locationInput = document.getElementById('location');
    const citySuggestions = document.getElementById('citySuggestions');
    const timezoneInput = document.getElementById('timezone');
    const timezoneGroup = document.getElementById('timezoneGroup');

    // Debounce timer for API calls
    let searchDebounceTimer = null;

    // Detect if input is Chinese
    function isChinese(str) {
      return /[\u4e00-\u9fa5]/.test(str);
    }

    // Search cities locally - instant response
    function searchCitiesLocal(query) {
      if (!query || query.length === 0) return [];

      const q = query.toLowerCase().trim();
      const isZh = isChinese(q);

      return cityDatabase.filter(city => {
        if (isZh) {
          // Chinese input: match Chinese name
          return city.zh.includes(q);
        } else {
          // English/Pinyin input: match English name or pinyin
          return city.en.toLowerCase().startsWith(q) ||
                 city.pinyin.startsWith(q) ||
                 city.en.toLowerCase().includes(q);
        }
      }).slice(0, 8); // Max 8 results
    }

    // Search cities via OpenStreetMap Nominatim API (fallback)
    async function searchCitiesOnline(query) {
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=8&addressdetails=1`,
          {
            headers: {
              'User-Agent': 'NatalCodex-App/1.0',
              'Accept-Language': currentLang === 'zh' ? 'zh-CN,zh' : 'en'
            }
          }
        );

        if (!response.ok) return [];

        const data = await response.json();

        // Convert OSM results to our format
        return data.map(place => {
          const lat = parseFloat(place.lat);
          const lon = parseFloat(place.lon);
          const displayName = place.display_name.split(',').slice(0, 2).join(',');
          const tz = guessTimezoneFromCoords(lat, lon);

          return {
            lat,
            lon,
            zh: displayName,
            en: displayName,
            tz,
            isOnline: true
          };
        });
      } catch (error) {
        console.error('Online city search failed:', error);
        return [];
      }
    }

    // Guess timezone from coordinates (approximate)
    function guessTimezoneFromCoords(lat, lon) {
      // Rough timezone estimation based on longitude
      // Each timezone is approximately 15 degrees wide
      const offset = Math.round(lon / 15);

      // Common timezone mappings by region
      if (lat >= 20 && lat <= 55 && lon >= 73 && lon <= 135) {
        // China region
        return 'Asia/Shanghai';
      } else if (lat >= 24 && lat <= 46 && lon >= 122 && lon <= 154) {
        // Japan region
        return 'Asia/Tokyo';
      } else if (lat >= 33 && lat <= 43 && lon >= 124 && lon <= 132) {
        // Korea region
        return 'Asia/Seoul';
      } else if (lat >= -10 && lat <= 10 && lon >= 95 && lon <= 141) {
        // Southeast Asia
        return 'Asia/Singapore';
      } else if (lat >= 35 && lat <= 72 && lon >= -10 && lon <= 40) {
        // Europe
        if (lon < 0) return 'Europe/London';
        if (lon < 15) return 'Europe/Paris';
        if (lon < 25) return 'Europe/Berlin';
        return 'Europe/Moscow';
      } else if (lat >= 25 && lat <= 50 && lon >= -130 && lon <= -60) {
        // North America
        if (lon < -115) return 'America/Los_Angeles';
        if (lon < -100) return 'America/Denver';
        if (lon < -85) return 'America/Chicago';
        return 'America/New_York';
      } else if (lat >= -45 && lat <= -10 && lon >= 110 && lon <= 155) {
        // Australia
        return 'Australia/Sydney';
      }

      // Fallback: calculate UTC offset
      if (offset >= 0) {
        return `Etc/GMT-${offset}`;
      } else {
        return `Etc/GMT+${Math.abs(offset)}`;
      }
    }

    // Render city suggestions
    function renderSuggestions(cities, query, isLoading = false) {
      if (isLoading) {
        citySuggestions.innerHTML = `<div style="padding:12px;text-align:center;color:#9ca3af">
          <span style="display:inline-block;animation:spin 1s linear infinite">â³</span>
          ${currentLang === 'zh' ? 'æœç´¢ä¸­...' : 'Searching...'}
        </div>`;
        citySuggestions.style.display = 'block';
        return;
      }

      if (cities.length === 0) {
        citySuggestions.innerHTML = `<div style="padding:12px;text-align:center;color:#9ca3af">${currentLang === 'zh' ? 'æœªæ‰¾åˆ°åŒ¹é…åŸå¸‚' : 'No matching city found'}</div>`;
        citySuggestions.style.display = 'block';
        return;
      }

      citySuggestions.innerHTML = cities.map(city => {
        const displayName = city.isOnline
          ? city.en
          : (currentLang === 'zh' ? `${city.zh} (${city.en})` : `${city.en} (${city.zh})`);
        const icon = city.isOnline ? 'ğŸŒ' : 'ğŸ“';
        return `
          <div class="city-option"
               data-lat="${city.lat}"
               data-lon="${city.lon}"
               data-zh="${city.zh}"
               data-en="${city.en}"
               data-tz="${city.tz}"
               style="padding:12px;cursor:pointer;border-bottom:1px solid rgba(0,255,157,0.1);color:#d4d4d8;transition:background 0.2s">
            ${icon} ${displayName}
            <span style="float:right;color:#6b7280;font-size:12px">${city.tz}</span>
          </div>
        `;
      }).join('');

      // Add click handlers
      document.querySelectorAll('.city-option').forEach(option => {
        option.addEventListener('mouseenter', () => {
          option.style.background = 'rgba(0,255,157,0.15)';
        });
        option.addEventListener('mouseleave', () => {
          option.style.background = 'transparent';
        });
        option.addEventListener('click', () => {
          selectCity({
            lat: parseFloat(option.dataset.lat),
            lon: parseFloat(option.dataset.lon),
            zh: option.dataset.zh,
            en: option.dataset.en,
            tz: option.dataset.tz
          });
        });
      });

      citySuggestions.style.display = 'block';
    }

    // Handle input - local search first, then online fallback
    locationInput.addEventListener('input', async (e) => {
      const query = e.target.value.trim();

      // Clear previous debounce timer
      if (searchDebounceTimer) {
        clearTimeout(searchDebounceTimer);
      }

      if (query.length === 0) {
        citySuggestions.style.display = 'none';
        return;
      }

      // First, try local search (instant)
      const localResults = searchCitiesLocal(query);

      if (localResults.length > 0) {
        // Local results found - show immediately
        renderSuggestions(localResults, query);
      } else if (query.length >= 2) {
        // No local results and query is long enough - try online search
        renderSuggestions([], query, true); // Show loading

        // Debounce the API call (500ms)
        searchDebounceTimer = setTimeout(async () => {
          const onlineResults = await searchCitiesOnline(query);
          renderSuggestions(onlineResults, query);
        }, 500);
      } else {
        // Query too short for online search
        renderSuggestions([], query);
      }
    });

    // Select city and auto-fill timezone
    function selectCity(city) {
      selectedCity = {
        lat: city.lat,
        lon: city.lon,
        displayName: currentLang === 'zh' ? city.zh : city.en
      };
      selectedTimezone = city.tz;

      locationInput.value = currentLang === 'zh' ? `${city.zh} (${city.en})` : `${city.en} (${city.zh})`;
      timezoneInput.value = city.tz;
      timezoneGroup.style.display = 'block';
      citySuggestions.style.display = 'none';

      // Save form data after city selection
      saveFormData();
    }

    // Close suggestions when clicking outside
    document.addEventListener('click', (e) => {
      if (!locationInput.contains(e.target) && !citySuggestions.contains(e.target)) {
        citySuggestions.style.display = 'none';
      }
    });

    // Handle keyboard navigation
    locationInput.addEventListener('keydown', (e) => {
      const options = citySuggestions.querySelectorAll('.city-option');
      if (options.length === 0) return;

      let currentIndex = Array.from(options).findIndex(opt => opt.style.background.includes('0,255,157'));

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (currentIndex >= 0) options[currentIndex].style.background = 'transparent';
        currentIndex = (currentIndex + 1) % options.length;
        options[currentIndex].style.background = 'rgba(0,255,157,0.15)';
        options[currentIndex].scrollIntoView({ block: 'nearest' });
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (currentIndex >= 0) options[currentIndex].style.background = 'transparent';
        currentIndex = currentIndex <= 0 ? options.length - 1 : currentIndex - 1;
        options[currentIndex].style.background = 'rgba(0,255,157,0.15)';
        options[currentIndex].scrollIntoView({ block: 'nearest' });
      } else if (e.key === 'Enter' && currentIndex >= 0) {
        e.preventDefault();
        options[currentIndex].click();
      } else if (e.key === 'Escape') {
        citySuggestions.style.display = 'none';
      }
    });

    // ========== Form Handling ==========
    const form = document.getElementById('generateForm');
    const submitBtn = document.getElementById('submitBtn');
    const loading = document.getElementById('loading');
    const resultSection = document.getElementById('resultSection');
    const reportContent = document.getElementById('reportContent');
    const copyBtn = document.getElementById('copyBtn');
    const errorDiv = document.getElementById('error');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Check login status first
      if (!isLoggedIn()) {
        showAuthModal('report');
        return;
      }

      // Check credits before generating
      if (userCredits < 1) {
        showPurchaseModal();
        return;
      }

      // Hide error and result
      errorDiv.classList.remove('active');
      resultSection.classList.remove('active');

      // Show loading
      loading.classList.add('active');
      submitBtn.disabled = true;

      // Get form data
      const formData = new FormData(form);
      const reportType = formData.get('reportType') || 'mbti';
      const birthData = {
        name: formData.get('name'),
        gender: formData.get('gender'),
        date: formData.get('date'),
        time: formData.get('time'),
        location: selectedCity ? selectedCity.displayName : formData.get('location'),
        timezone: selectedTimezone || Intl.DateTimeFormat().resolvedOptions().timeZone,
        coordinates: selectedCity ? { lat: selectedCity.lat, lon: selectedCity.lon } : null,
        language: currentLang
      };

      // Store current report type for card generation
      window.currentReportType = reportType;

      // Update card button text based on report type
      updateCardButtonText(reportType);

      // Variable to track deducted reportId for potential refund
      let deductedReportId = null;

      try {
        // Step 1: Deduct credit before generating
        const token = getAuthToken();
        const deductResponse = await fetch('/api/user?action=deduct', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ reportType })
        });

        const deductData = await deductResponse.json();

        if (!deductResponse.ok || !deductData.success) {
          if (deductData.needPurchase) {
            showPurchaseModal();
            return;
          }
          throw new Error(deductData.error || 'Failed to deduct credit');
        }

        // Store reportId for potential refund
        deductedReportId = deductData.reportId;

        // Update local credit count
        userCredits = deductData.remainingCredits;
        updateCreditsDisplay();
        console.log('[Credits] Deducted, remaining:', userCredits);

        // Step 2: Generate report
        // Choose API endpoint based on report type
        const apiEndpoint = reportType === 'kuder'
          ? '/api/reports/generateKuder'
          : '/api/reports/generateWithAPImart';

        const response = await fetch(apiEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            orderId: deductedReportId,
            birthData
          })
        });

        console.log('[Report] Response status:', response.status);
        console.log('[Report] Content-Type:', response.headers.get('content-type'));

        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('[Report] Non-JSON response:', text.substring(0, 500));
          throw new Error('Server returned an error page instead of JSON. Please check Vercel function logs.');
        }

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(data.error || 'Report generation failed');
        }

        // Clean markdown - remove ALL special formatting markers
        let cleanReport = data.reportContent
          // Remove bold markers
          .replace(/\*\*(.+?)\*\*/g, '$1')
          // Remove italic markers
          .replace(/\*(.+?)\*/g, '$1')
          // Remove underscore emphasis
          .replace(/__(.+?)__/g, '$1')
          .replace(/_(.+?)_/g, '$1')
          // Remove strikethrough
          .replace(/~~(.+?)~~/g, '$1')
          // Remove inline code backticks but keep content
          .replace(/`(.+?)`/g, '$1')
          // Clean up any remaining asterisks
          .replace(/\*/g, '')
          .replace(/_/g, '')
          // Remove extra blank lines
          .replace(/\n{3,}/g, '\n\n');

        // Store clean text for copying
        window.cleanReportText = cleanReport;

        // Store data for soul card generation
        lastAnalysisData = {
          name: birthData.name,
          gender: birthData.gender,
          reportContent: cleanReport,
          rawAnalysis: data.analysis?.raw_content || cleanReport,
          reportType: reportType
        };

        // Render markdown to HTML
        reportContent.innerHTML = marked.parse(cleanReport);

        // Show result
        loading.classList.remove('active');
        resultSection.classList.add('active');

        // Scroll to result after DOM renders
        setTimeout(() => {
          resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);

      } catch (error) {
        console.error('Error:', error);
        errorDiv.textContent = translations[currentLang].errorGenerate + error.message;
        errorDiv.classList.add('active');
        loading.classList.remove('active');

        // Refund credit if report generation failed
        if (deductedReportId) {
          try {
            const refundToken = getAuthToken();
            const refundResponse = await fetch('/api/user?action=refund', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${refundToken}`
              },
              body: JSON.stringify({ reportId: deductedReportId })
            });

            const refundData = await refundResponse.json();
            if (refundData.success) {
              userCredits = refundData.remainingCredits;
              updateCreditsDisplay();
              console.log('[Credits] Refunded due to error, remaining:', userCredits);
            }
          } catch (refundError) {
            console.error('[Credits] Refund failed:', refundError);
          }
        }
      } finally {
        submitBtn.disabled = false;
      }
    });

    // Copy button
    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(window.cleanReportText || reportContent.innerText);
        const originalHTML = copyBtn.innerHTML;
        copyBtn.innerHTML = `âœ… <span data-i18n="btnCopied">${translations[currentLang].btnCopied}</span>`;
        copyBtn.classList.add('copied');

        setTimeout(() => {
          copyBtn.innerHTML = `ğŸ“‹ <span data-i18n="btnCopy">${translations[currentLang].btnCopy}</span>`;
          copyBtn.classList.remove('copied');
        }, 2000);
      } catch (error) {
        console.error('Copy failed:', error);
        alert(translations[currentLang].errorCopy);
      }
    });

    // Download button
    const downloadBtn = document.getElementById('downloadBtn');
    downloadBtn.addEventListener('click', () => {
      const text = window.cleanReportText || reportContent.innerText;
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      // Use correct filename based on report type
      const reportTypeLabel = lastAnalysisData?.reportType === 'kuder' ? 'BaZi-KUDER-Report' : 'BaZi-MBTI-Report';
      a.download = `${reportTypeLabel}_${document.getElementById('name').value}_${new Date().toLocaleDateString()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      downloadBtn.innerHTML = `âœ… <span data-i18n="btnDownloaded">${translations[currentLang].btnDownloaded}</span>`;
      downloadBtn.classList.add('copied');
      setTimeout(() => {
        downloadBtn.innerHTML = `ğŸ’¾ <span data-i18n="btnDownload">${translations[currentLang].btnDownload}</span>`;
        downloadBtn.classList.remove('copied');
      }, 2000);
    });

    // Fill demo data button
    const fillDemoBtn = document.getElementById('fillDemoBtn');
    fillDemoBtn.addEventListener('click', () => {
      if (currentLang === 'zh') {
        document.getElementById('name').value = 'ææ¢…';
        document.getElementById('gender').value = 'å¥³';
        document.getElementById('date').value = '1999-08-08';
        document.getElementById('time').value = '14:30';
        // Set Shanghai city data
        const shanghaiCity = cityDatabase.find(c => c.zh === 'ä¸Šæµ·');
        if (shanghaiCity) {
          selectedCity = { lat: shanghaiCity.lat, lon: shanghaiCity.lon, displayName: shanghaiCity.zh };
          selectedTimezone = shanghaiCity.tz;
          document.getElementById('location').value = `${shanghaiCity.zh} (${shanghaiCity.en})`;
          document.getElementById('timezone').value = shanghaiCity.tz;
          document.getElementById('timezoneGroup').style.display = 'block';
        }
      } else {
        document.getElementById('name').value = 'Emma Johnson';
        document.getElementById('gender').value = 'å¥³'; // Female
        document.getElementById('date').value = '1999-08-08';
        document.getElementById('time').value = '14:30';
        // Set New York city data
        const nyCity = cityDatabase.find(c => c.en === 'New York');
        if (nyCity) {
          selectedCity = { lat: nyCity.lat, lon: nyCity.lon, displayName: nyCity.en };
          selectedTimezone = nyCity.tz;
          document.getElementById('location').value = `${nyCity.en} (${nyCity.zh})`;
          document.getElementById('timezone').value = nyCity.tz;
          document.getElementById('timezoneGroup').style.display = 'block';
        }
      }

      fillDemoBtn.innerHTML = `âœ… <span data-i18n="demoFilled">${translations[currentLang].demoFilled}</span>`;
      setTimeout(() => {
        fillDemoBtn.innerHTML = `ğŸ“ <span data-i18n="btnDemo">${translations[currentLang].btnDemo}</span>`;
      }, 1500);
    });

    // ========== Soul Card Generation ==========
    const generateCardBtn = document.getElementById('generateCardBtn');
    const cardSection = document.getElementById('cardSection');
    const cardLoading = document.getElementById('cardLoading');
    const cardImage = document.getElementById('cardImage');
    const soulCardImg = document.getElementById('soulCardImg');
    const downloadCardBtn = document.getElementById('downloadCardBtn');

    // Store analysis data for card generation
    let lastAnalysisData = null;

    // Progress bar elements
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressTip = document.getElementById('progressTip');
    let progressInterval = null;

    // Simulated progress animation (since API doesn't provide real progress)
    function startProgressAnimation(isKuder = false) {
      let progress = 0;
      let tipIndex = 0;
      // Choose tips based on report type
      const tips = isKuder
        ? translations[currentLang].cardProgressTipsKuder
        : translations[currentLang].cardProgressTips;

      // Reset progress
      progressBar.style.width = '0%';
      progressText.textContent = '0%';
      progressTip.textContent = tips[0];

      progressInterval = setInterval(() => {
        // Slow progress that never quite reaches 100%
        if (progress < 90) {
          progress += Math.random() * 3 + 0.5;
          if (progress > 90) progress = 90;

          progressBar.style.width = `${progress}%`;
          progressText.textContent = `${Math.round(progress)}%`;

          // Update tip message at certain progress points
          const newTipIndex = Math.floor(progress / 20);
          if (newTipIndex !== tipIndex && newTipIndex < tips.length) {
            tipIndex = newTipIndex;
            progressTip.textContent = tips[tipIndex];
          }
        }
      }, 500);
    }

    // Update card button text based on report type
    function updateCardButtonText(reportType) {
      const isKuder = reportType === 'kuder';
      const btnText = isKuder ? translations[currentLang].btnCardKuder : translations[currentLang].btnCard;
      generateCardBtn.innerHTML = `ğŸ´ <span data-i18n="${isKuder ? 'btnCardKuder' : 'btnCard'}">${btnText}</span>`;
    }

    function stopProgressAnimation(success = true) {
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
      if (success) {
        progressBar.style.width = '100%';
        progressText.textContent = '100%';
      }
    }

    generateCardBtn.addEventListener('click', async () => {
      // Check login status first
      if (!isLoggedIn()) {
        showAuthModal('card');
        return;
      }

      if (!lastAnalysisData) {
        alert(currentLang === 'zh' ? 'è¯·å…ˆç”ŸæˆæŠ¥å‘Š' : 'Please generate report first');
        return;
      }

      // Get selected report type from UI
      const selectedType = document.querySelector('input[name="reportType"]:checked')?.value || 'mbti';
      // Get report type from stored data
      const dataReportType = lastAnalysisData.reportType || 'mbti';

      // Check if selected type matches the generated report type
      if (selectedType !== dataReportType) {
        const dataTypeName = dataReportType === 'kuder' ? 'KUDERèŒä¸šåˆ†æ' : 'MBTIäººæ ¼åˆ†æ';
        const selectedTypeName = selectedType === 'kuder' ? 'KUDERèŒä¸šå¡' : 'MBTIçµé­‚å¡';
        
        const msg = currentLang === 'zh'
          ? `âš ï¸ ç±»å‹ä¸åŒ¹é…ï¼\n\nå½“å‰æŠ¥å‘Šæ˜¯ï¼š${dataTypeName}\næ‚¨é€‰æ‹©ç”Ÿæˆï¼š${selectedTypeName}\n\nè¯·å…ˆç‚¹å‡»"ç”ŸæˆæŠ¥å‘Š"æŒ‰é’®ç”Ÿæˆå¯¹åº”ç±»å‹çš„æŠ¥å‘Šï¼Œå†ç”Ÿæˆå¡ç‰‡ã€‚`
          : `âš ï¸ Type mismatch!\n\nCurrent report: ${dataReportType.toUpperCase()}\nSelected card: ${selectedType.toUpperCase()}\n\nPlease click "Generate Report" first to create the matching report type.`;
        
        alert(msg);
        return;
      }

      // Determine report type
      const reportType = dataReportType;
      const isKuder = reportType === 'kuder';

      // Show loading with appropriate text
      generateCardBtn.disabled = true;
      generateCardBtn.innerHTML = `â³ <span>${translations[currentLang].cardGenerating}</span>`;
      cardSection.style.display = 'block';
      cardLoading.style.display = 'block';
      cardImage.style.display = 'none';

      // Update card section title
      const cardTitleEl = cardSection.querySelector('[data-i18n="cardTitle"], [data-i18n="cardTitleKuder"]');
      if (cardTitleEl) {
        cardTitleEl.textContent = isKuder
          ? translations[currentLang].cardTitleKuder
          : translations[currentLang].cardTitle;
        cardTitleEl.setAttribute('data-i18n', isKuder ? 'cardTitleKuder' : 'cardTitle');
      }

      // Update loading text
      const loadingTextEl = cardLoading.querySelector('.loading-text');
      if (loadingTextEl) {
        loadingTextEl.textContent = isKuder
          ? translations[currentLang].cardLoadingKuder
          : translations[currentLang].cardLoading;
      }

      // Start progress animation with appropriate tips
      startProgressAnimation(isKuder);

      // Scroll to card section immediately when starting generation
      setTimeout(() => {
        cardSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);

      try {
        // Choose API endpoint based on report type
        const cardApiEndpoint = isKuder
          ? '/api/reports/generateKuderCard'
          : '/api/reports/generateSoulCard';

        const response = await fetch(cardApiEndpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...lastAnalysisData,
            language: currentLang
          })
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(data.error || 'Card generation failed');
        }

        // Stop progress animation with success
        stopProgressAnimation(true);

        // Display the image
        soulCardImg.src = data.imageUrl;
        cardLoading.style.display = 'none';
        cardImage.style.display = 'block';

        // Scroll to card
        setTimeout(() => {
          cardSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);

      } catch (error) {
        console.error('Card generation error:', error);
        stopProgressAnimation(false);
        cardLoading.innerHTML = `<div style="color:#fca5a5">${translations[currentLang].cardError}${error.message}<br><button id="retryCardBtn" class="copy-btn" style="margin-top:16px">ğŸ”„ ${currentLang === 'zh' ? 'é‡è¯•' : 'Retry'}</button></div>`;

        // Add retry button listener
        document.getElementById('retryCardBtn')?.addEventListener('click', () => {
          generateCardBtn.click();
        });
      } finally {
        generateCardBtn.disabled = false;
        // Restore button text based on report type
        const btnText = isKuder ? translations[currentLang].btnCardKuder : translations[currentLang].btnCard;
        generateCardBtn.innerHTML = `ğŸ´ <span data-i18n="${isKuder ? 'btnCardKuder' : 'btnCard'}">${btnText}</span>`;
      }
    });

    // Download card image
    downloadCardBtn.addEventListener('click', async () => {
      const imgSrc = soulCardImg.src;
      if (!imgSrc) return;

      try {
        const response = await fetch(imgSrc);
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        // Use correct filename based on report type
        const cardTypeLabel = lastAnalysisData?.reportType === 'kuder' ? 'KuderDestinyCard' : 'SoulCard';
        a.download = `${cardTypeLabel}_${document.getElementById('name').value}_${new Date().toLocaleDateString()}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        downloadCardBtn.innerHTML = `âœ… <span>${translations[currentLang].btnDownloaded}</span>`;
        setTimeout(() => {
          downloadCardBtn.innerHTML = `ğŸ’¾ <span data-i18n="btnDownloadCard">${translations[currentLang].btnDownloadCard}</span>`;
        }, 2000);
      } catch (error) {
        console.error('Download failed:', error);
      }
    });

    // ========== Authentication System ==========
    const AUTH_TOKEN_KEY = 'nc_auth_token';
    const AUTH_USER_KEY = 'nc_auth_user';

    // Auth state
    let currentUser = null;
    let pendingAction = null; // 'report' or 'card'

    // DOM elements for auth
    const authOverlay = document.getElementById('authOverlay');
    const authClose = document.getElementById('authClose');
    const loginFormDiv = document.getElementById('loginForm');
    const registerFormDiv = document.getElementById('registerForm');
    const loginFormEl = document.getElementById('loginFormEl');
    const registerFormEl = document.getElementById('registerFormEl');
    const loginError = document.getElementById('loginError');
    const registerError = document.getElementById('registerError');
    const showRegisterLink = document.getElementById('showRegister');
    const showLoginLink = document.getElementById('showLogin');
    const loginTrigger = document.getElementById('loginTrigger');
    const userMenu = document.getElementById('userMenu');
    const userBtn = document.getElementById('userBtn');
    const userDropdown = document.getElementById('userDropdown');
    const userEmailSpan = document.getElementById('userEmail');
    const userInitialSpan = document.getElementById('userInitial');
    const logoutBtn = document.getElementById('logoutBtn');

    // Check if user is logged in
    function isLoggedIn() {
      return !!localStorage.getItem(AUTH_TOKEN_KEY);
    }

    // Get auth token
    function getAuthToken() {
      return localStorage.getItem(AUTH_TOKEN_KEY);
    }

    // Get stored user
    function getStoredUser() {
      const userData = localStorage.getItem(AUTH_USER_KEY);
      return userData ? JSON.parse(userData) : null;
    }

    // Save auth data
    function saveAuthData(token, user) {
      localStorage.setItem(AUTH_TOKEN_KEY, token);
      localStorage.setItem(AUTH_USER_KEY, JSON.stringify(user));
      currentUser = user;
    }

    // Clear auth data
    function clearAuthData() {
      localStorage.removeItem(AUTH_TOKEN_KEY);
      localStorage.removeItem(AUTH_USER_KEY);
      currentUser = null;
    }

    // Credits state
    let userCredits = 0;
    let selectedPackage = 'PACK_6';
    let validatedPromo = null;

    // Update UI based on auth state
    function updateAuthUI() {
      const creditsBadge = document.getElementById('creditsBadge');
      if (isLoggedIn()) {
        const user = getStoredUser();
        loginTrigger.style.display = 'none';
        userMenu.style.display = 'block';
        creditsBadge.style.display = 'flex';
        if (user && user.email) {
          const email = user.email;
          // Show first letter as avatar initial
          userInitialSpan.textContent = email.charAt(0).toUpperCase();
          // Show full email in dropdown
          userEmailSpan.textContent = email;
          // Set tooltip with full email
          userBtn.title = email;
        }
        // Load user credits
        loadUserCredits();
      } else {
        loginTrigger.style.display = 'flex';
        userMenu.style.display = 'none';
        creditsBadge.style.display = 'none';
      }
    }

    // Update credits display
    function updateCreditsDisplay() {
      document.getElementById('creditsCount').textContent = userCredits;
      // Update purchase modal display
      const displayEl = document.getElementById('purchaseCreditsDisplay');
      if (displayEl) {
        document.getElementById('purchaseCreditsValue').textContent = userCredits;
        if (userCredits > 0) {
          displayEl.classList.add('has-credits');
        } else {
          displayEl.classList.remove('has-credits');
        }
      }
    }

    // Load user credits from API
    async function loadUserCredits() {
      const token = getAuthToken();
      if (!token) {
        console.warn('[Credits] No auth token found');
        return;
      }

      try {
        const response = await fetch('/api/user?action=credits', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        console.log('[Credits] Response status:', response.status);
        console.log('[Credits] Response headers:', response.headers.get('content-type'));

        // æ£€æŸ¥æ˜¯å¦æ˜¯ JSON å“åº”
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('[Credits] âŒ Non-JSON response received!');
          console.error('[Credits] Response body:', text.substring(0, 500));
          console.error('[Credits] ğŸ”§ SOLUTION: Please check Vercel environment variables:');
          console.error('[Credits]    1. Go to https://vercel.com/dashboard');
          console.error('[Credits]    2. Select your project â†’ Settings â†’ Environment Variables');
          console.error('[Credits]    3. Ensure JWT_SECRET and DATABASE_URL are set');
          console.error('[Credits]    4. Redeploy the application');
          return;
        }

        const data = await response.json();
        console.log('[Credits] API response:', data);

        if (data.success && typeof data.credits === 'number') {
          userCredits = data.credits;
          document.getElementById('creditsCount').textContent = userCredits;
          // Update purchase modal display
          const displayEl = document.getElementById('purchaseCreditsDisplay');
          if (displayEl) {
            document.getElementById('purchaseCreditsValue').textContent = userCredits;
            if (userCredits > 0) {
              displayEl.classList.add('has-credits');
            } else {
              displayEl.classList.remove('has-credits');
            }
          }
          console.log('[Credits] âœ… Loaded successfully:', userCredits);
        } else {
          console.error('[Credits] âŒ API error:', data.error || 'Invalid response');
          if (data.details) {
            console.error('[Credits] Details:', data.details);
            console.error('[Credits] ğŸ”§ This means:', data.details);
          }
          // å¦‚æœæ˜¯ 401 é”™è¯¯ï¼Œæ¸…é™¤ token å¹¶é‡æ–°ç™»å½•
          if (response.status === 401) {
            console.warn('[Credits] Token invalid, logging out');
            logout();
          } else if (response.status === 500 && data.details) {
            console.error('[Credits] ğŸ”§ Configuration error detected!');
            console.error('[Credits] Please fix:', data.details);
          }
        }
      } catch (e) {
        console.error('[Credits] âŒ Failed to load credits:', e);
        console.error('[Credits] Error type:', e.name);
        console.error('[Credits] Error message:', e.message);
      }
    }

    // Check credits before generating
    async function checkCreditsBeforeGenerate() {
      if (userCredits < 1) {
        showPurchaseModal();
        return false;
      }
      return true;
    }

    // Show purchase modal
    function showPurchaseModal() {
      loadUserCredits(); // Refresh credits
      validatedPromo = null;
      document.getElementById('promoInput').value = '';
      document.getElementById('promoResult').style.display = 'none';
      resetPrices();
      document.getElementById('purchaseOverlay').classList.add('active');
    }

    // Hide purchase modal
    function hidePurchaseModal() {
      document.getElementById('purchaseOverlay').classList.remove('active');
    }

    // Reset prices to original
    function resetPrices() {
      document.getElementById('price6').textContent = 'Â¥29';
      document.getElementById('price6').classList.remove('discounted');
      document.getElementById('original6').style.display = 'none';
      document.getElementById('price20').textContent = 'Â¥89';
      document.getElementById('price20').classList.remove('discounted');
      document.getElementById('original20').style.display = 'none';
    }

    // Update prices with promo discount
    function updatePricesWithDiscount(discountPercent) {
      const prices = { PACK_6: 29, PACK_20: 89 };
      const multiplier = discountPercent === 50 ? 0.5 : 0.8;
      
      document.getElementById('price6').textContent = `Â¥${(prices.PACK_6 * multiplier).toFixed(1)}`;
      document.getElementById('price6').classList.add('discounted');
      document.getElementById('original6').style.display = 'block';
      
      document.getElementById('price20').textContent = `Â¥${(prices.PACK_20 * multiplier).toFixed(1)}`;
      document.getElementById('price20').classList.add('discounted');
      document.getElementById('original20').style.display = 'block';
    }

    // Show auth modal
    function showAuthModal(action = null) {
      pendingAction = action;
      authOverlay.classList.add('active');
      loginFormDiv.style.display = 'block';
      registerFormDiv.style.display = 'none';
      loginError.classList.remove('active');
      registerError.classList.remove('active');
      // Clear form fields
      loginFormEl.reset();
      registerFormEl.reset();
    }

    // Hide auth modal
    function hideAuthModal() {
      authOverlay.classList.remove('active');
      pendingAction = null;
    }

    // Switch between login and register forms
    showRegisterLink.addEventListener('click', () => {
      loginFormDiv.style.display = 'none';
      registerFormDiv.style.display = 'block';
      loginError.classList.remove('active');
    });

    showLoginLink.addEventListener('click', () => {
      registerFormDiv.style.display = 'none';
      loginFormDiv.style.display = 'block';
      registerError.classList.remove('active');
    });

    // Close modal
    authClose.addEventListener('click', hideAuthModal);
    authOverlay.addEventListener('click', (e) => {
      if (e.target === authOverlay) hideAuthModal();
    });

    // Login trigger button
    loginTrigger.addEventListener('click', () => showAuthModal());

    // User dropdown toggle
    userBtn.addEventListener('click', () => {
      userDropdown.classList.toggle('active');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!userMenu.contains(e.target)) {
        userDropdown.classList.remove('active');
      }
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
      clearAuthData();
      updateAuthUI();
      userDropdown.classList.remove('active');
    });

    // Login form submit
    loginFormEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const loginBtn = document.getElementById('loginBtn');
      
      loginBtn.disabled = true;
      loginBtn.textContent = translations[currentLang].authLoggingIn;
      loginError.classList.remove('active');

      try {
        const response = await fetch('/api/auth?action=login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(currentLang === 'zh' ? data.errorZh : data.error);
        }

        // Save auth data
        saveAuthData(data.token, data.user);
        updateAuthUI();
        hideAuthModal();

        // Execute pending action if any
        if (pendingAction === 'report') {
          form.dispatchEvent(new Event('submit'));
        } else if (pendingAction === 'card') {
          generateCardBtn.click();
        }

      } catch (error) {
        loginError.textContent = error.message;
        loginError.classList.add('active');
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = translations[currentLang].authLoginBtn;
      }
    });

    // Register form submit
    registerFormEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('registerConfirm').value;
      const registerBtn = document.getElementById('registerBtn');
      
      // Check password match
      if (password !== confirmPassword) {
        registerError.textContent = translations[currentLang].authPasswordMismatch;
        registerError.classList.add('active');
        return;
      }

      registerBtn.disabled = true;
      registerBtn.textContent = translations[currentLang].authRegistering;
      registerError.classList.remove('active');

      try {
        const response = await fetch('/api/auth?action=register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(currentLang === 'zh' ? data.errorZh : data.error);
        }

        // Save auth data
        saveAuthData(data.token, data.user);
        updateAuthUI();
        hideAuthModal();

        // Execute pending action if any
        if (pendingAction === 'report') {
          form.dispatchEvent(new Event('submit'));
        } else if (pendingAction === 'card') {
          generateCardBtn.click();
        }

      } catch (error) {
        registerError.textContent = error.message;
        registerError.classList.add('active');
      } finally {
        registerBtn.disabled = false;
        registerBtn.textContent = translations[currentLang].authRegisterBtn;
      }
    });

    // Google login button
    document.getElementById('googleLoginBtn').addEventListener('click', () => {
      // Store pending action before redirect
      if (pendingAction) {
        sessionStorage.setItem('pendingAuthAction', pendingAction);
      }
      // Redirect to Google OAuth
      window.location.href = '/api/auth?action=google';
    });

    // Handle OAuth callback parameters in URL
    function handleOAuthCallback() {
      const urlParams = new URLSearchParams(window.location.search);
      const authToken = urlParams.get('auth_token');
      const authEmail = urlParams.get('auth_email');
      const authError = urlParams.get('auth_error');

      // Clean up URL
      if (authToken || authError) {
        const cleanUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
      }

      if (authError) {
        const errorMessages = {
          'access_denied': currentLang === 'zh' ? 'æ‚¨å–æ¶ˆäº†Googleç™»å½•' : 'Google login cancelled',
          'no_code': currentLang === 'zh' ? 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•' : 'Login failed, please try again',
          'token_exchange_failed': currentLang === 'zh' ? 'Googleæˆæƒå¤±è´¥' : 'Google authorization failed',
          'no_email': currentLang === 'zh' ? 'æ— æ³•è·å–é‚®ç®±ä¿¡æ¯' : 'Could not get email info',
          'account_disabled': currentLang === 'zh' ? 'è´¦æˆ·å·²è¢«ç¦ç”¨' : 'Account is disabled',
          'server_error': currentLang === 'zh' ? 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·é‡è¯•' : 'Server error, please try again'
        };
        alert(errorMessages[authError] || authError);
        return false;
      }

      if (authToken && authEmail) {
        // Save auth data from Google OAuth
        const user = { email: decodeURIComponent(authEmail) };
        saveAuthData(authToken, user);
        updateAuthUI();

        // Check for pending action
        const pendingActionFromStorage = sessionStorage.getItem('pendingAuthAction');
        sessionStorage.removeItem('pendingAuthAction');

        if (pendingActionFromStorage === 'report') {
          setTimeout(() => form.dispatchEvent(new Event('submit')), 100);
        } else if (pendingActionFromStorage === 'card') {
          setTimeout(() => generateCardBtn.click(), 100);
        }

        return true;
      }

      return false;
    }

    // Check auth on page load
    async function checkAuthOnLoad() {
      // First check OAuth callback
      if (handleOAuthCallback()) {
        return;
      }

      const token = getAuthToken();
      if (!token) {
        updateAuthUI();
        return;
      }

      try {
        const response = await fetch('/api/auth?action=me', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();

        if (response.ok && data.success) {
          currentUser = data.user;
          localStorage.setItem(AUTH_USER_KEY, JSON.stringify(data.user));
        } else {
          // Token invalid, clear auth data
          clearAuthData();
        }
      } catch (error) {
        console.error('Auth check failed:', error);
      }

      updateAuthUI();
    }

    // Require login for report generation
    function requireLoginForReport() {
      if (!isLoggedIn()) {
        showAuthModal('report');
        return false;
      }
      return true;
    }

    // Require login for card generation
    function requireLoginForCard() {
      if (!isLoggedIn()) {
        showAuthModal('card');
        return false;
      }
      return true;
    }

    // Initialize auth on page load
    checkAuthOnLoad();

    // ==================== PURCHASE MODAL ====================

    // Credits buy button click
    document.getElementById('creditsBuyBtn').addEventListener('click', showPurchaseModal);
    
    // Close purchase modal
    document.getElementById('purchaseClose').addEventListener('click', hidePurchaseModal);
    document.getElementById('purchaseOverlay').addEventListener('click', (e) => {
      if (e.target === document.getElementById('purchaseOverlay')) hidePurchaseModal();
    });

    // Package selection
    document.querySelectorAll('.package-card').forEach(card => {
      card.addEventListener('click', () => {
        document.querySelectorAll('.package-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        selectedPackage = card.dataset.package;
      });
    });

    // Promo code validation
    document.getElementById('promoValidateBtn').addEventListener('click', async () => {
      const code = document.getElementById('promoInput').value.trim().toUpperCase();
      const resultEl = document.getElementById('promoResult');
      
      if (!code) {
        resultEl.className = 'promo-result error';
        resultEl.textContent = 'è¯·è¾“å…¥ä¼˜æƒ ç ';
        resultEl.style.display = 'block';
        return;
      }

      try {
        const response = await fetch('/api/pay?action=validate-promo', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getAuthToken()}`
          },
          body: JSON.stringify({ promoCode: code, packageType: selectedPackage })
        });
        
        const data = await response.json();
        
        if (data.success) {
          validatedPromo = { code, discountPercent: data.discountPercent };
          resultEl.className = 'promo-result success';
          resultEl.textContent = `âœ“ ${data.discountType === 'HALF' ? 'äº”æŠ˜' : 'å…«æŠ˜'}ä¼˜æƒ å·²ç”Ÿæ•ˆï¼`;
          resultEl.style.display = 'block';
          updatePricesWithDiscount(data.discountPercent);
        } else {
          validatedPromo = null;
          resultEl.className = 'promo-result error';
          resultEl.textContent = data.error || 'ä¼˜æƒ ç æ— æ•ˆ';
          resultEl.style.display = 'block';
          resetPrices();
        }
      } catch (e) {
        resultEl.className = 'promo-result error';
        resultEl.textContent = 'éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•';
        resultEl.style.display = 'block';
      }
    });

    // ==================== QR CODE PAYMENT ====================

    // QR Code modal state
    let currentOrderNo = null;
    let currentOrderAmount = null;
    let currentOrderPackage = null;
    let pollingTimer = null;
    let countdownTimer = null;
    let paymentTimeoutTimer = null;

    // Detect if mobile device
    function isMobile() {
      return /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
    }

    // Show normal QR code content, hide error
    function showQrCodeContent() {
      document.getElementById('qrcodeContent').style.display = 'block';
      document.getElementById('qrcodeError').classList.remove('active');
    }

    // Show error state with retry button
    function showQrCodeError(icon, message) {
      document.getElementById('qrcodeContent').style.display = 'none';
      document.getElementById('qrcodeErrorIcon').textContent = icon;
      document.getElementById('qrcodeErrorMsg').textContent = message;
      document.getElementById('qrcodeError').classList.add('active');
    }

    // Show QR code modal
    function showQrCodeModal(qrCodeUrl, orderNo, amount, packageName) {
      currentOrderNo = orderNo;
      currentOrderAmount = amount;
      currentOrderPackage = packageName;

      document.getElementById('qrcodeImage').src = qrCodeUrl;
      document.getElementById('qrcodeAmount').textContent = `Â¥${amount}`;
      document.getElementById('qrcodePackage').textContent = packageName;
      document.getElementById('qrcodeStatus').innerHTML = '<div class="spinner-small"></div><span>ç­‰å¾…æ”¯ä»˜ä¸­...</span>';
      document.getElementById('qrcodeStatus').classList.remove('success');

      showQrCodeContent();
      document.getElementById('qrcodeOverlay').classList.add('active');

      // Start countdown (5 minutes)
      startCountdown(5 * 60);

      // Start polling for payment status
      startPaymentPolling(orderNo);
    }

    // Hide QR code modal
    function hideQrCodeModal() {
      document.getElementById('qrcodeOverlay').classList.remove('active');
      stopPaymentPolling();
      stopCountdown();
      currentOrderNo = null;
      currentOrderAmount = null;
      currentOrderPackage = null;
    }

    // Start countdown timer
    function startCountdown(seconds) {
      let remaining = seconds;
      updateCountdownDisplay(remaining);

      countdownTimer = setInterval(() => {
        remaining--;
        updateCountdownDisplay(remaining);

        if (remaining <= 0) {
          stopCountdown();
          stopPaymentPolling();
          // Show error state with retry option instead of closing
          showQrCodeError('â°', currentLang === 'zh' ? 'æ”¯ä»˜è¶…æ—¶ï¼ŒäºŒç»´ç å·²å¤±æ•ˆ' : 'Payment timeout, QR code expired');
        }
      }, 1000);

      // Also set a hard timeout
      paymentTimeoutTimer = setTimeout(() => {
        stopPaymentPolling();
        stopCountdown();
        showQrCodeError('â°', currentLang === 'zh' ? 'æ”¯ä»˜è¶…æ—¶ï¼ŒäºŒç»´ç å·²å¤±æ•ˆ' : 'Payment timeout, QR code expired');
      }, seconds * 1000);
    }

    // Update countdown display
    function updateCountdownDisplay(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      document.getElementById('qrcodeTimer').textContent =
        `${currentLang === 'zh' ? 'å‰©ä½™æ”¯ä»˜æ—¶é—´' : 'Time remaining'}ï¼š${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Stop countdown
    function stopCountdown() {
      if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
      if (paymentTimeoutTimer) {
        clearTimeout(paymentTimeoutTimer);
        paymentTimeoutTimer = null;
      }
    }

    // Start polling for payment status
    function startPaymentPolling(orderNo) {
      pollingTimer = setInterval(async () => {
        try {
          // ğŸ”’ æ·»åŠ  Authorization å¤´ä»¥è·å–å®Œæ•´è®¢å•ä¿¡æ¯
          const res = await fetch(`/api/pay?action=status&order=${orderNo}`, {
            headers: {
              'Authorization': `Bearer ${getAuthToken()}`
            }
          });
          const data = await res.json();

          if (data.success && data.order.status === 'paid') {
            // Payment successful!
            stopPaymentPolling();
            stopCountdown();

            // Update status display
            document.getElementById('qrcodeStatus').innerHTML = 'âœ… æ”¯ä»˜æˆåŠŸï¼';
            document.getElementById('qrcodeStatus').classList.add('success');

            // Wait a moment then close
            setTimeout(() => {
              hideQrCodeModal();
              hidePurchaseModal();
              loadUserCredits();
              alert(currentLang === 'zh' ? 'ğŸ‰ æ”¯ä»˜æˆåŠŸï¼æ¬¡æ•°å·²åˆ°è´¦' : 'ğŸ‰ Payment successful! Credits added');
            }, 1500);
          } else if (data.order && data.order.status === 'expired') {
            // Order expired
            stopPaymentPolling();
            stopCountdown();
            showQrCodeError('â°', currentLang === 'zh' ? 'è®¢å•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç”ŸæˆäºŒç»´ç ' : 'Order expired, please refresh QR code');
          }
        } catch (e) {
          console.error('Polling error:', e);
        }
      }, 3000); // Poll every 3 seconds
    }

    // Stop polling
    function stopPaymentPolling() {
      if (pollingTimer) {
        clearInterval(pollingTimer);
        pollingTimer = null;
      }
    }

    // Retry payment - request new QR code for the same order
    async function retryPayment() {
      const retryBtn = document.getElementById('qrcodeRetryBtn');
      retryBtn.disabled = true;
      retryBtn.textContent = currentLang === 'zh' ? 'åˆ·æ–°ä¸­...' : 'Refreshing...';

      try {
        const response = await fetch('/api/pay?action=retry', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getAuthToken()}`
          },
          body: JSON.stringify({ orderNo: currentOrderNo })
        });

        const data = await response.json();

        if (data.success) {
          // Update QR code and restart
          document.getElementById('qrcodeImage').src = data.qrCodeUrl;
          showQrCodeContent();
          startCountdown(5 * 60);
          startPaymentPolling(data.orderNo);

          // Update order number if new order was created
          if (data.orderNo !== currentOrderNo) {
            currentOrderNo = data.orderNo;
          }
        } else {
          // Retry failed, show error
          showQrCodeError('âŒ', data.error || (currentLang === 'zh' ? 'åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡æ–°ä¸‹å•' : 'Refresh failed, please create new order'));
        }
      } catch (e) {
        console.error('Retry error:', e);
        showQrCodeError('âŒ', currentLang === 'zh' ? 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•' : 'Network error, please try again');
      } finally {
        retryBtn.disabled = false;
        retryBtn.textContent = currentLang === 'zh' ? 'åˆ·æ–°äºŒç»´ç ' : 'Refresh QR Code';
      }
    }

    // Close QR code modal
    document.getElementById('qrcodeClose').addEventListener('click', () => {
      if (confirm(currentLang === 'zh' ? 'ç¡®å®šè¦å…³é—­å—ï¼Ÿå¦‚å·²æ”¯ä»˜è¯·ç­‰å¾…ç³»ç»Ÿç¡®è®¤' : 'Are you sure? If paid, please wait for confirmation')) {
        hideQrCodeModal();
      }
    });

    // Retry button click
    document.getElementById('qrcodeRetryBtn').addEventListener('click', retryPayment);

    // Purchase button - Updated for QR code flow
    document.getElementById('purchaseBtn').addEventListener('click', async () => {
      const btn = document.getElementById('purchaseBtn');
      btn.disabled = true;
      btn.textContent = 'å¤„ç†ä¸­...';

      try {
        const response = await fetch('/api/pay?action=create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getAuthToken()}`
          },
          body: JSON.stringify({
            packageType: selectedPackage,
            promoCode: validatedPromo?.code || null
          })
        });

        const data = await response.json();

        if (data.success) {
          // Check device type
          if (isMobile() && data.mobileUrl) {
            // Mobile: redirect to Alipay
            window.location.href = data.mobileUrl;
          } else if (data.qrCodeUrl) {
            // PC: show QR code modal
            const packageNames = { PACK_6: '6æ¬¡å¥—é¤', PACK_20: '20æ¬¡å¥—é¤' };
            showQrCodeModal(
              data.qrCodeUrl,
              data.orderNo,
              data.priceInfo.finalPrice,
              packageNames[selectedPackage] || selectedPackage
            );
          } else {
            throw new Error('æ— æ³•è·å–æ”¯ä»˜ä¿¡æ¯');
          }
        } else {
          alert(data.error || 'åˆ›å»ºè®¢å•å¤±è´¥');
        }
      } catch (e) {
        console.error('Payment error:', e);
        alert('æ”¯ä»˜è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
      } finally {
        btn.disabled = false;
        btn.textContent = 'æ”¯ä»˜å®æ”¯ä»˜';
      }
    });

    // Check for payment result on page load
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('payment') === 'success') {
      loadUserCredits();
      alert('æ”¯ä»˜æˆåŠŸï¼æ¬¡æ•°å·²åˆ°è´¦');
      // Clean URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }

  </script>
</body>
</html>
