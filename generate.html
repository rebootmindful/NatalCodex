<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”ŸæˆæŠ¥å‘Š - NatalCodex | Generate Your Soul Report</title>

  <!-- SEO Meta Tags -->
  <meta name="description" content="Generate your personalized BaZi + MBTI soul analysis report. AI-powered insights combining ancient Chinese astrology with modern personality science. ç”Ÿæˆæ‚¨çš„å…«å­—MBTIå‘½ç†æŠ¥å‘Šå’Œçµé­‚å¥‘åˆå¡ã€‚">
  <meta name="keywords" content="BaZi report, å…«å­—æŠ¥å‘Š, MBTI analysis, soul card, çµé­‚å¥‘åˆå¡, personality report, å‘½ç†åˆ†æ">
  <meta name="author" content="NatalCodex">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://natalcodex.vercel.app/generate.html">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://natalcodex.vercel.app/generate.html">
  <meta property="og:title" content="Generate Your Soul Report - NatalCodex">
  <meta property="og:description" content="Create your personalized BaZi + MBTI soul analysis report and Soul Card with AI.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:locale:alternate" content="en_US">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://natalcodex.vercel.app/generate.html">
  <meta name="twitter:title" content="Generate Your Soul Report - NatalCodex">
  <meta name="twitter:description" content="Create your personalized BaZi + MBTI soul analysis report and Soul Card with AI.">

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <!-- Theme Color -->
  <meta name="theme-color" content="#0a0e27">
  <meta name="msapplication-TileColor" content="#0a0e27">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
  <style>
    * {margin:0;padding:0;box-sizing:border-box}
    body {
      font-family:'Inter',sans-serif;
      background:linear-gradient(135deg,#0a0e27 0%,#1a1f4d 50%,#2d1f4d 100%);
      color:#fff;
      min-height:100vh;
      padding:40px 20px;
    }
    .container {
      max-width:900px;
      margin:0 auto;
    }
    .header {
      text-align:center;
      margin-bottom:48px;
    }
    .logo {
      font-size:36px;
      font-weight:600;
      color:#00ff9d;
      text-shadow:0 0 18px rgba(0,255,157,.55);
      margin-bottom:12px;
    }
    .subtitle {
      font-size:16px;
      color:#d4d4d8;
    }

    .form-section {
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(0,255,157,0.2);
      border-radius:16px;
      padding:40px;
      margin-bottom:32px;
      backdrop-filter:blur(10px);
    }
    .form-grid {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:24px;
      margin-bottom:24px;
    }
    .form-group {
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .form-group.full {
      grid-column:1 / -1;
    }
    label {
      font-size:14px;
      font-weight:600;
      color:#e5e7eb;
    }
    input, select {
      padding:12px 16px;
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(0,255,157,0.3);
      border-radius:8px;
      color:#fff;
      font-size:15px;
      font-family:'Inter',sans-serif;
      transition:all 0.3s ease;
    }
    input:focus, select:focus {
      outline:none;
      border-color:#00ff9d;
      background:rgba(255,255,255,0.12);
      box-shadow:0 0 0 3px rgba(0,255,157,0.1);
    }
    input::placeholder {
      color:#9ca3af;
    }

    .btn {
      width:100%;
      padding:16px;
      background:linear-gradient(135deg,#00ff9d 0%,#00d4aa 100%);
      color:#0a0e27;
      font-size:16px;
      font-weight:700;
      border:none;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.25s ease;
      box-shadow:0 6px 22px rgba(0,255,157,0.42);
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .btn:hover:not(:disabled) {
      transform:translateY(-2px);
      box-shadow:0 10px 30px rgba(0,255,157,0.6);
    }
    .btn:disabled {
      opacity:0.6;
      cursor:not-allowed;
    }

    .result-section {
      display:none;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(0,255,157,0.2);
      border-radius:16px;
      padding:40px;
      backdrop-filter:blur(10px);
    }
    .result-section.active {
      display:block;
    }
    .result-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:24px;
      padding-bottom:16px;
      border-bottom:1px solid rgba(0,255,157,0.2);
    }
    .result-title {
      font-size:24px;
      font-weight:700;
      color:#00ff9d;
    }
    .copy-btn {
      padding:10px 20px;
      background:rgba(0,255,157,0.2);
      border:1px solid #00ff9d;
      border-radius:8px;
      color:#00ff9d;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.3s ease;
    }
    .copy-btn:hover {
      background:#00ff9d;
      color:#0a0e27;
    }
    .copy-btn.copied {
      background:#00ff9d;
      color:#0a0e27;
    }

    .report-content {
      line-height:1.8;
      color:#e5e7eb;
    }
    .report-content h1 {
      font-size:28px;
      color:#00ff9d;
      margin:32px 0 16px;
      font-weight:700;
    }
    .report-content h2 {
      font-size:22px;
      color:#00d4aa;
      margin:28px 0 14px;
      font-weight:700;
    }
    .report-content h3 {
      font-size:18px;
      color:#00ff9d;
      margin:24px 0 12px;
      font-weight:600;
    }
    .report-content p {
      margin:12px 0;
    }
    .report-content ul, .report-content ol {
      margin:12px 0;
      padding-left:24px;
    }
    .report-content li {
      margin:8px 0;
    }
    .report-content strong {
      color:#fff;
      font-weight:600;
    }
    .report-content hr {
      border:none;
      border-top:1px solid rgba(0,255,157,0.2);
      margin:32px 0;
    }
    .report-content code {
      background:rgba(0,255,157,0.1);
      padding:2px 6px;
      border-radius:4px;
      color:#00ff9d;
      font-size:0.95em;
    }

    .loading {
      text-align:center;
      padding:40px;
      display:none;
    }
    .loading.active {
      display:block;
    }
    .spinner {
      width:60px;
      height:60px;
      border:4px solid rgba(0,255,157,0.2);
      border-top-color:#00ff9d;
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin:0 auto 20px;
    }
    @keyframes spin {
      to {transform:rotate(360deg)}
    }
    .loading-text {
      font-size:16px;
      color:#d4d4d8;
    }

    .error {
      display:none;
      padding:16px;
      background:rgba(239,68,68,0.1);
      border:1px solid rgba(239,68,68,0.3);
      border-radius:8px;
      color:#fca5a5;
      margin-bottom:24px;
    }
    .error.active {
      display:block;
    }

    .help-text {
      font-size:13px;
      color:#9ca3af;
      margin-top:4px;
    }
    .back-link {
      display:inline-block;
      margin-bottom:24px;
      padding:8px 16px;
      background:rgba(0,255,157,0.1);
      border:1px solid rgba(0,255,157,0.3);
      border-radius:8px;
      color:#00ff9d;
      text-decoration:none;
      font-size:14px;
      transition:all 0.3s ease;
    }
    .back-link:hover {
      background:rgba(0,255,157,0.2);
      border-color:#00ff9d;
    }

    @media (max-width:768px) {
      .container {
        padding:20px 16px;
      }
      .header {
        margin-bottom:32px;
      }
      .logo {
        font-size:28px;
      }
      .subtitle {
        font-size:14px;
      }
      .form-grid {
        grid-template-columns:1fr;
        gap:20px;
      }
      .form-section {
        padding:24px 20px;
      }
      .result-section {
        padding:24px 20px;
      }
      .result-header {
        flex-direction:column;
        gap:12px;
        align-items:flex-start;
      }
      .result-header > div {
        width:100%;
      }
      .copy-btn {
        width:100%;
        padding:12px 16px;
      }
      .report-content h1 {
        font-size:22px;
      }
      .report-content h2 {
        font-size:18px;
      }
      .report-content h3 {
        font-size:16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <a href="index.html" class="back-link">â† <span data-i18n="backHome">è¿”å›é¦–é¡µ</span></a>
      <button id="langSwitch" class="copy-btn" style="border:1px solid rgba(0,255,157,0.3);background:transparent;cursor:pointer">
        <span id="langIcon">ğŸŒ</span> <span id="langText">EN</span>
      </button>
    </div>

    <div class="header">
      <div class="logo">NatalCodex</div>
      <div class="subtitle" data-i18n="subtitle">ç”Ÿæˆæ‚¨çš„å…«å­—å‘½ç†ä¸MBTIäººæ ¼åˆ†ææŠ¥å‘Š</div>
    </div>

    <div class="form-section">
      <form id="generateForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="name" data-i18n="labelName">å§“å</label>
            <input type="text" id="name" name="name" data-i18n-placeholder="placeholderName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required>
          </div>

          <div class="form-group">
            <label for="gender" data-i18n="labelGender">æ€§åˆ«</label>
            <select id="gender" name="gender" required>
              <option value="" data-i18n="selectGender">è¯·é€‰æ‹©</option>
              <option value="ç”·" data-i18n="male">ç”·</option>
              <option value="å¥³" data-i18n="female">å¥³</option>
            </select>
          </div>

          <div class="form-group">
            <label for="date" data-i18n="labelDate">å‡ºç”Ÿæ—¥æœŸ</label>
            <input type="date" id="date" name="date" required max="">
          </div>

          <div class="form-group">
            <label for="time" data-i18n="labelTime">å‡ºç”Ÿæ—¶é—´</label>
            <input type="time" id="time" name="time" placeholder="14:30" required>
            <div class="help-text" data-i18n="helpTime">è¯·å°½é‡ç²¾ç¡®åˆ°åˆ†é’Ÿï¼Œç”¨äºè®¡ç®—çœŸå¤ªé˜³æ—¶</div>
          </div>

          <div class="form-group full" style="position:relative">
            <label for="location" data-i18n="labelLocation">å‡ºç”Ÿåœ°ç‚¹</label>
            <input type="text" id="location" name="location" data-i18n-placeholder="placeholderLocation" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬å¸‚æµ·æ·€åŒº" required autocomplete="off">
            <div class="help-text" data-i18n="helpLocation">å…·ä½“åˆ°åŸå¸‚æˆ–åŒºå¿å³å¯ï¼Œç”¨äºçœŸå¤ªé˜³æ—¶ä¿®æ­£</div>
            <!-- City suggestions dropdown -->
            <div id="citySuggestions" style="display:none;position:absolute;left:0;right:0;z-index:20;background:#0a0e27;border:1px solid rgba(0,255,157,0.5);border-radius:8px;margin-top:4px;max-height:200px;overflow-y:auto;top:100%"></div>
          </div>

          <div class="form-group full" id="timezoneGroup" style="display:none">
            <label for="timezone" data-i18n="labelTimezone">æ—¶åŒº</label>
            <input type="text" id="timezone" name="timezone" readonly style="background:rgba(255,255,255,0.05);cursor:not-allowed">
            <div class="help-text" data-i18n="helpTimezone">æ ¹æ®æ‚¨é€‰æ‹©çš„åŸå¸‚è‡ªåŠ¨æ£€æµ‹</div>
          </div>
        </div>

        <div class="error" id="error"></div>

        <button type="submit" class="btn" id="submitBtn">
          ğŸ”® <span data-i18n="btnGenerate">ç”ŸæˆæŠ¥å‘Š</span>
        </button>

        <div style="text-align:center;margin-top:16px">
          <button type="button" class="copy-btn" id="fillDemoBtn" style="background:transparent;border:1px solid rgba(0,255,157,0.3)">
            ğŸ“ <span data-i18n="btnDemo">å¡«å……ç¤ºä¾‹æ•°æ®</span>
          </button>
        </div>
      </form>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div class="loading-text" data-i18n="loadingText">AIæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆä¸“å±æŠ¥å‘Šï¼Œè¯·ç¨å€™...</div>
    </div>

    <div class="result-section" id="resultSection">
      <div class="result-header">
        <div class="result-title" data-i18n="resultTitle">æ‚¨çš„ä¸“å±æŠ¥å‘Š</div>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <button class="copy-btn" id="copyBtn">ğŸ“‹ <span data-i18n="btnCopy">å¤åˆ¶æŠ¥å‘Š</span></button>
          <button class="copy-btn" id="downloadBtn">ğŸ’¾ <span data-i18n="btnDownload">ä¸‹è½½TXT</span></button>
          <button class="copy-btn" id="downloadPdfBtn">ğŸ“„ <span data-i18n="btnDownloadPdf">ä¸‹è½½PDF</span></button>
          <button class="copy-btn" id="generateCardBtn">ğŸ´ <span data-i18n="btnCard">ç”Ÿæˆçµé­‚å¥‘åˆå¡</span></button>
        </div>
      </div>
      <div class="report-content" id="reportContent"></div>

      <!-- Soul Card Section -->
      <div id="cardSection" style="display:none;margin-top:32px;padding-top:24px;border-top:1px solid rgba(0,255,157,0.2)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px">
          <div style="font-size:20px;font-weight:700;color:#00ff9d" data-i18n="cardTitle">æ‚¨çš„çµé­‚å¥‘åˆå¡</div>
          <button class="copy-btn" id="downloadCardBtn">ğŸ’¾ <span data-i18n="btnDownloadCard">ä¸‹è½½å›¾ç‰‡</span></button>
        </div>
        <div id="cardLoading" style="display:none;text-align:center;padding:40px">
          <div class="spinner"></div>
          <div class="loading-text" data-i18n="cardLoading">AIæ­£åœ¨ç”Ÿæˆæ‚¨çš„çµé­‚å¥‘åˆå¡...</div>
          <div id="progressContainer" style="margin-top:20px;max-width:300px;margin-left:auto;margin-right:auto">
            <div style="background:rgba(0,255,157,0.1);border-radius:10px;height:8px;overflow:hidden">
              <div id="progressBar" style="background:linear-gradient(90deg,#00ff9d,#00d4aa);height:100%;width:0%;transition:width 0.3s ease;border-radius:10px"></div>
            </div>
            <div id="progressText" style="margin-top:8px;font-size:12px;color:#9ca3af">0%</div>
            <div id="progressTip" style="margin-top:12px;font-size:13px;color:#d4d4d8" data-i18n="cardProgressTip">å›¾ç‰‡ç”Ÿæˆé€šå¸¸éœ€è¦30-60ç§’...</div>
          </div>
        </div>
        <div id="cardImage" style="text-align:center">
          <img id="soulCardImg" src="" alt="Soul Card" style="max-width:100%;border-radius:12px;box-shadow:0 8px 32px rgba(0,255,157,0.3)">
        </div>
      </div>
    </div>

    <!-- Report History Section -->
    <div class="form-section" id="historySection" style="display:none;margin-top:32px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <div style="font-size:20px;font-weight:700;color:#00ff9d">ğŸ“š <span data-i18n="historyTitle">å†å²æŠ¥å‘Š</span></div>
        <button class="copy-btn" id="clearHistoryBtn" style="background:rgba(239,68,68,0.2);border-color:rgba(239,68,68,0.5);color:#fca5a5">
          ğŸ—‘ï¸ <span data-i18n="btnClearHistory">æ¸…ç©ºå†å²</span>
        </button>
      </div>
      <div id="historyList"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    // ========== Translation System ==========
    const translations = {
      zh: {
        backHome: 'è¿”å›é¦–é¡µ',
        subtitle: 'ç”Ÿæˆæ‚¨çš„å…«å­—å‘½ç†ä¸MBTIäººæ ¼åˆ†ææŠ¥å‘Š',
        labelName: 'å§“å',
        placeholderName: 'è¯·è¾“å…¥æ‚¨çš„å§“å',
        labelGender: 'æ€§åˆ«',
        selectGender: 'è¯·é€‰æ‹©',
        male: 'ç”·',
        female: 'å¥³',
        labelDate: 'å‡ºç”Ÿæ—¥æœŸ',
        labelTime: 'å‡ºç”Ÿæ—¶é—´',
        helpTime: 'è¯·å°½é‡ç²¾ç¡®åˆ°åˆ†é’Ÿï¼Œç”¨äºè®¡ç®—çœŸå¤ªé˜³æ—¶',
        labelLocation: 'å‡ºç”Ÿåœ°ç‚¹',
        placeholderLocation: 'æœç´¢åŸå¸‚ï¼ˆä¾‹å¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€New Yorkï¼‰',
        helpLocation: 'è¾“å…¥åŸå¸‚åç§°æœç´¢ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«æ—¶åŒº',
        labelTimezone: 'æ—¶åŒº',
        helpTimezone: 'æ ¹æ®æ‚¨é€‰æ‹©çš„åŸå¸‚è‡ªåŠ¨æ£€æµ‹',
        btnGenerate: 'ç”ŸæˆæŠ¥å‘Š',
        btnDemo: 'å¡«å……ç¤ºä¾‹æ•°æ®',
        loadingText: 'AIæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆä¸“å±æŠ¥å‘Šï¼Œè¯·ç¨å€™...',
        resultTitle: 'æ‚¨çš„ä¸“å±æŠ¥å‘Š',
        btnCopy: 'å¤åˆ¶æŠ¥å‘Š',
        btnDownload: 'ä¸‹è½½TXT',
        btnDownloadPdf: 'ä¸‹è½½PDF',
        btnCopied: 'å·²å¤åˆ¶',
        btnDownloaded: 'å·²ä¸‹è½½',
        errorGenerate: 'ç”Ÿæˆå¤±è´¥ï¼š',
        errorCopy: 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶',
        searching: 'æœç´¢ä¸­...',
        demoFilled: 'å·²å¡«å……',
        btnCard: 'ç”Ÿæˆçµé­‚å¥‘åˆå¡',
        cardTitle: 'æ‚¨çš„çµé­‚å¥‘åˆå¡',
        btnDownloadCard: 'ä¸‹è½½å›¾ç‰‡',
        cardLoading: 'AIæ­£åœ¨ç”Ÿæˆæ‚¨çš„çµé­‚å¥‘åˆå¡...',
        cardGenerating: 'ç”Ÿæˆä¸­...',
        cardError: 'å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼š',
        cardProgressTip: 'å›¾ç‰‡ç”Ÿæˆé€šå¸¸éœ€è¦30-60ç§’...',
        cardProgressTips: ['æ­£åœ¨åˆ†æå…«å­—ä¿¡æ¯...', 'æ­£åœ¨è®¾è®¡å¡ç‰‡å¸ƒå±€...', 'æ­£åœ¨æ¸²æŸ“äº”è¡Œå…ƒç´ ...', 'æ­£åœ¨ç”ŸæˆMBTIå›¾è¡¨...', 'å³å°†å®Œæˆ...'],
        historyTitle: 'å†å²æŠ¥å‘Š',
        btnClearHistory: 'æ¸…ç©ºå†å²',
        historyEmpty: 'æš‚æ— å†å²æŠ¥å‘Š',
        historyView: 'æŸ¥çœ‹',
        historyDelete: 'åˆ é™¤',
        historyConfirmClear: 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²æŠ¥å‘Šå—ï¼Ÿ',
        historyConfirmDelete: 'ç¡®å®šè¦åˆ é™¤è¿™æ¡æŠ¥å‘Šå—ï¼Ÿ'
      },
      en: {
        backHome: 'Back Home',
        subtitle: 'Generate Your BaZi & MBTI Personality Analysis Report',
        labelName: 'Name',
        placeholderName: 'Enter your name',
        labelGender: 'Gender',
        selectGender: 'Select',
        male: 'Male',
        female: 'Female',
        labelDate: 'Birth Date',
        labelTime: 'Birth Time',
        helpTime: 'Accurate to the minute for true solar time calculation',
        labelLocation: 'Birth Location',
        placeholderLocation: 'Search city (e.g., Beijing, Shanghai, New York)',
        helpLocation: 'Enter city name to search, timezone will be auto-detected',
        labelTimezone: 'Timezone',
        helpTimezone: 'Auto-detected based on your selected city',
        btnGenerate: 'Generate Report',
        btnDemo: 'Fill Demo Data',
        loadingText: 'AI is generating your personalized report, please wait...',
        resultTitle: 'Your Personalized Report',
        btnCopy: 'Copy Report',
        btnDownload: 'Download TXT',
        btnDownloadPdf: 'Download PDF',
        btnCopied: 'Copied',
        btnDownloaded: 'Downloaded',
        errorGenerate: 'Generation failed: ',
        errorCopy: 'Copy failed, please copy manually',
        searching: 'Searching...',
        demoFilled: 'Filled',
        btnCard: 'Generate Soul Card',
        cardTitle: 'Your Soul Card',
        btnDownloadCard: 'Download Image',
        cardLoading: 'AI is generating your Soul Card...',
        cardGenerating: 'Generating...',
        cardError: 'Image generation failed: ',
        cardProgressTip: 'Image generation usually takes 30-60 seconds...',
        cardProgressTips: ['Analyzing BaZi data...', 'Designing card layout...', 'Rendering Five Elements...', 'Generating MBTI chart...', 'Almost done...'],
        historyTitle: 'Report History',
        btnClearHistory: 'Clear History',
        historyEmpty: 'No history reports',
        historyView: 'View',
        historyDelete: 'Delete',
        historyConfirmClear: 'Are you sure you want to clear all history?',
        historyConfirmDelete: 'Are you sure you want to delete this report?'
      }
    };

    let currentLang = localStorage.getItem('nc_language') || 'zh';
    let selectedCity = null;
    let selectedTimezone = null;

    function updateLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('nc_language', lang);

      // Update all elements with data-i18n
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[lang][key]) {
          el.textContent = translations[lang][key];
        }
      });

      // Update placeholders
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (translations[lang][key]) {
          el.placeholder = translations[lang][key];
        }
      });

      // Update language button
      document.getElementById('langText').textContent = lang === 'zh' ? 'EN' : 'ä¸­æ–‡';
    }

    // Initialize language
    updateLanguage(currentLang);

    // Set max date to today (can't select future dates)
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').setAttribute('max', today);

    // Language switcher
    document.getElementById('langSwitch').addEventListener('click', () => {
      const newLang = currentLang === 'zh' ? 'en' : 'zh';
      updateLanguage(newLang);
    });

    // ========== Form Data Persistence (localStorage) ==========
    const STORAGE_KEY = 'nc_form_data';

    // Save form data to localStorage
    function saveFormData() {
      const formData = {
        name: document.getElementById('name').value,
        gender: document.getElementById('gender').value,
        date: document.getElementById('date').value,
        time: document.getElementById('time').value,
        location: document.getElementById('location').value,
        timezone: document.getElementById('timezone').value,
        selectedCity: selectedCity,
        selectedTimezone: selectedTimezone,
        savedAt: Date.now()
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
    }

    // Restore form data from localStorage
    function restoreFormData() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return false;

        const formData = JSON.parse(saved);

        // Check if data is older than 30 days
        const thirtyDays = 30 * 24 * 60 * 60 * 1000;
        if (Date.now() - formData.savedAt > thirtyDays) {
          localStorage.removeItem(STORAGE_KEY);
          return false;
        }

        // Restore form fields
        if (formData.name) document.getElementById('name').value = formData.name;
        if (formData.gender) document.getElementById('gender').value = formData.gender;
        if (formData.date) document.getElementById('date').value = formData.date;
        if (formData.time) document.getElementById('time').value = formData.time;
        if (formData.location) document.getElementById('location').value = formData.location;

        // Restore city and timezone selection
        if (formData.selectedCity) {
          selectedCity = formData.selectedCity;
          selectedTimezone = formData.selectedTimezone;
          if (formData.timezone) {
            document.getElementById('timezone').value = formData.timezone;
            document.getElementById('timezoneGroup').style.display = 'block';
          }
        }

        return true;
      } catch (e) {
        console.error('Failed to restore form data:', e);
        return false;
      }
    }

    // Add event listeners to save form data on input change
    function setupFormPersistence() {
      const fields = ['name', 'gender', 'date', 'time', 'location'];
      fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('change', saveFormData);
          field.addEventListener('blur', saveFormData);
        }
      });
    }

    // Initialize form persistence
    restoreFormData();
    setupFormPersistence();

    // ========== City Database with Timezone ==========
    const cityDatabase = [
      // ä¸­å›½ä¸»è¦åŸå¸‚
      { zh: 'åŒ—äº¬', en: 'Beijing', pinyin: 'beijing', lat: 39.9042, lon: 116.4074, tz: 'Asia/Shanghai' },
      { zh: 'ä¸Šæµ·', en: 'Shanghai', pinyin: 'shanghai', lat: 31.2304, lon: 121.4737, tz: 'Asia/Shanghai' },
      { zh: 'å¹¿å·', en: 'Guangzhou', pinyin: 'guangzhou', lat: 23.1291, lon: 113.2644, tz: 'Asia/Shanghai' },
      { zh: 'æ·±åœ³', en: 'Shenzhen', pinyin: 'shenzhen', lat: 22.5431, lon: 114.0579, tz: 'Asia/Shanghai' },
      { zh: 'æ­å·', en: 'Hangzhou', pinyin: 'hangzhou', lat: 30.2741, lon: 120.1551, tz: 'Asia/Shanghai' },
      { zh: 'å—äº¬', en: 'Nanjing', pinyin: 'nanjing', lat: 32.0603, lon: 118.7969, tz: 'Asia/Shanghai' },
      { zh: 'æˆéƒ½', en: 'Chengdu', pinyin: 'chengdu', lat: 30.5728, lon: 104.0668, tz: 'Asia/Shanghai' },
      { zh: 'é‡åº†', en: 'Chongqing', pinyin: 'chongqing', lat: 29.4316, lon: 106.9123, tz: 'Asia/Shanghai' },
      { zh: 'æ­¦æ±‰', en: 'Wuhan', pinyin: 'wuhan', lat: 30.5928, lon: 114.3055, tz: 'Asia/Shanghai' },
      { zh: 'è¥¿å®‰', en: "Xi'an", pinyin: 'xian', lat: 34.3416, lon: 108.9398, tz: 'Asia/Shanghai' },
      { zh: 'å¤©æ´¥', en: 'Tianjin', pinyin: 'tianjin', lat: 39.3434, lon: 117.3616, tz: 'Asia/Shanghai' },
      { zh: 'è‹å·', en: 'Suzhou', pinyin: 'suzhou', lat: 31.2990, lon: 120.5853, tz: 'Asia/Shanghai' },
      { zh: 'é’å²›', en: 'Qingdao', pinyin: 'qingdao', lat: 36.0671, lon: 120.3826, tz: 'Asia/Shanghai' },
      { zh: 'å¤§è¿', en: 'Dalian', pinyin: 'dalian', lat: 38.9140, lon: 121.6147, tz: 'Asia/Shanghai' },
      { zh: 'å¦é—¨', en: 'Xiamen', pinyin: 'xiamen', lat: 24.4798, lon: 118.0894, tz: 'Asia/Shanghai' },
      { zh: 'é•¿æ²™', en: 'Changsha', pinyin: 'changsha', lat: 28.2282, lon: 112.9388, tz: 'Asia/Shanghai' },
      { zh: 'éƒ‘å·', en: 'Zhengzhou', pinyin: 'zhengzhou', lat: 34.7466, lon: 113.6253, tz: 'Asia/Shanghai' },
      { zh: 'æ²ˆé˜³', en: 'Shenyang', pinyin: 'shenyang', lat: 41.8057, lon: 123.4315, tz: 'Asia/Shanghai' },
      { zh: 'å“ˆå°”æ»¨', en: 'Harbin', pinyin: 'haerbin', lat: 45.8038, lon: 126.5350, tz: 'Asia/Shanghai' },
      { zh: 'æµå—', en: 'Jinan', pinyin: 'jinan', lat: 36.6512, lon: 117.1201, tz: 'Asia/Shanghai' },
      { zh: 'ç¦å·', en: 'Fuzhou', pinyin: 'fuzhou', lat: 26.0745, lon: 119.2965, tz: 'Asia/Shanghai' },
      { zh: 'æ˜†æ˜', en: 'Kunming', pinyin: 'kunming', lat: 25.0389, lon: 102.7183, tz: 'Asia/Shanghai' },
      { zh: 'æ— é”¡', en: 'Wuxi', pinyin: 'wuxi', lat: 31.4912, lon: 120.3119, tz: 'Asia/Shanghai' },
      { zh: 'å®æ³¢', en: 'Ningbo', pinyin: 'ningbo', lat: 29.8683, lon: 121.5440, tz: 'Asia/Shanghai' },
      { zh: 'åˆè‚¥', en: 'Hefei', pinyin: 'hefei', lat: 31.8206, lon: 117.2272, tz: 'Asia/Shanghai' },
      { zh: 'å—æ˜Œ', en: 'Nanchang', pinyin: 'nanchang', lat: 28.6820, lon: 115.8579, tz: 'Asia/Shanghai' },
      { zh: 'é•¿æ˜¥', en: 'Changchun', pinyin: 'changchun', lat: 43.8171, lon: 125.3235, tz: 'Asia/Shanghai' },
      { zh: 'çŸ³å®¶åº„', en: 'Shijiazhuang', pinyin: 'shijiazhuang', lat: 38.0428, lon: 114.5149, tz: 'Asia/Shanghai' },
      { zh: 'è´µé˜³', en: 'Guiyang', pinyin: 'guiyang', lat: 26.6470, lon: 106.6302, tz: 'Asia/Shanghai' },
      { zh: 'å—å®', en: 'Nanning', pinyin: 'nanning', lat: 22.8170, lon: 108.3665, tz: 'Asia/Shanghai' },
      { zh: 'å¤ªåŸ', en: 'Taiyuan', pinyin: 'taiyuan', lat: 37.8706, lon: 112.5489, tz: 'Asia/Shanghai' },
      { zh: 'ä¹Œé²æœ¨é½', en: 'Urumqi', pinyin: 'wulumuqi', lat: 43.8256, lon: 87.6168, tz: 'Asia/Urumqi' },
      { zh: 'å…°å·', en: 'Lanzhou', pinyin: 'lanzhou', lat: 36.0611, lon: 103.8343, tz: 'Asia/Shanghai' },
      { zh: 'æµ·å£', en: 'Haikou', pinyin: 'haikou', lat: 20.0440, lon: 110.1999, tz: 'Asia/Shanghai' },
      { zh: 'å‘¼å’Œæµ©ç‰¹', en: 'Hohhot', pinyin: 'huhehaote', lat: 40.8424, lon: 111.7490, tz: 'Asia/Shanghai' },
      { zh: 'é“¶å·', en: 'Yinchuan', pinyin: 'yinchuan', lat: 38.4872, lon: 106.2309, tz: 'Asia/Shanghai' },
      { zh: 'è¥¿å®', en: 'Xining', pinyin: 'xining', lat: 36.6171, lon: 101.7782, tz: 'Asia/Shanghai' },
      { zh: 'æ‹‰è¨', en: 'Lhasa', pinyin: 'lasa', lat: 29.6500, lon: 91.1000, tz: 'Asia/Shanghai' },
      // æ¸¯æ¾³å°
      { zh: 'é¦™æ¸¯', en: 'Hong Kong', pinyin: 'xianggang', lat: 22.3193, lon: 114.1694, tz: 'Asia/Hong_Kong' },
      { zh: 'æ¾³é—¨', en: 'Macau', pinyin: 'aomen', lat: 22.1987, lon: 113.5439, tz: 'Asia/Macau' },
      { zh: 'å°åŒ—', en: 'Taipei', pinyin: 'taibei', lat: 25.0330, lon: 121.5654, tz: 'Asia/Taipei' },
      { zh: 'é«˜é›„', en: 'Kaohsiung', pinyin: 'gaoxiong', lat: 22.6273, lon: 120.3014, tz: 'Asia/Taipei' },
      // äºšæ´²å…¶ä»–
      { zh: 'ä¸œäº¬', en: 'Tokyo', pinyin: 'dongjing', lat: 35.6762, lon: 139.6503, tz: 'Asia/Tokyo' },
      { zh: 'å¤§é˜ª', en: 'Osaka', pinyin: 'daban', lat: 34.6937, lon: 135.5023, tz: 'Asia/Tokyo' },
      { zh: 'é¦–å°”', en: 'Seoul', pinyin: 'shouer', lat: 37.5665, lon: 126.9780, tz: 'Asia/Seoul' },
      { zh: 'æ–°åŠ å¡', en: 'Singapore', pinyin: 'xinjiapo', lat: 1.3521, lon: 103.8198, tz: 'Asia/Singapore' },
      { zh: 'æ›¼è°·', en: 'Bangkok', pinyin: 'mangu', lat: 13.7563, lon: 100.5018, tz: 'Asia/Bangkok' },
      { zh: 'å‰éš†å¡', en: 'Kuala Lumpur', pinyin: 'jilongpo', lat: 3.1390, lon: 101.6869, tz: 'Asia/Kuala_Lumpur' },
      { zh: 'é›…åŠ è¾¾', en: 'Jakarta', pinyin: 'yajiade', lat: -6.2088, lon: 106.8456, tz: 'Asia/Jakarta' },
      { zh: 'é©¬å°¼æ‹‰', en: 'Manila', pinyin: 'manila', lat: 14.5995, lon: 120.9842, tz: 'Asia/Manila' },
      { zh: 'æ²³å†…', en: 'Hanoi', pinyin: 'henei', lat: 21.0285, lon: 105.8542, tz: 'Asia/Ho_Chi_Minh' },
      { zh: 'èƒ¡å¿—æ˜å¸‚', en: 'Ho Chi Minh City', pinyin: 'huzhimingshi', lat: 10.8231, lon: 106.6297, tz: 'Asia/Ho_Chi_Minh' },
      { zh: 'å­Ÿä¹°', en: 'Mumbai', pinyin: 'mengmai', lat: 19.0760, lon: 72.8777, tz: 'Asia/Kolkata' },
      { zh: 'æ–°å¾·é‡Œ', en: 'New Delhi', pinyin: 'xindeli', lat: 28.6139, lon: 77.2090, tz: 'Asia/Kolkata' },
      { zh: 'è¿ªæ‹œ', en: 'Dubai', pinyin: 'dibai', lat: 25.2048, lon: 55.2708, tz: 'Asia/Dubai' },
      // æ¬§æ´²
      { zh: 'ä¼¦æ•¦', en: 'London', pinyin: 'lundun', lat: 51.5074, lon: -0.1278, tz: 'Europe/London' },
      { zh: 'å·´é»', en: 'Paris', pinyin: 'bali', lat: 48.8566, lon: 2.3522, tz: 'Europe/Paris' },
      { zh: 'æŸæ—', en: 'Berlin', pinyin: 'bolin', lat: 52.5200, lon: 13.4050, tz: 'Europe/Berlin' },
      { zh: 'ç½—é©¬', en: 'Rome', pinyin: 'luoma', lat: 41.9028, lon: 12.4964, tz: 'Europe/Rome' },
      { zh: 'é©¬å¾·é‡Œ', en: 'Madrid', pinyin: 'madeli', lat: 40.4168, lon: -3.7038, tz: 'Europe/Madrid' },
      { zh: 'é˜¿å§†æ–¯ç‰¹ä¸¹', en: 'Amsterdam', pinyin: 'amusitedan', lat: 52.3676, lon: 4.9041, tz: 'Europe/Amsterdam' },
      { zh: 'è«æ–¯ç§‘', en: 'Moscow', pinyin: 'mosike', lat: 55.7558, lon: 37.6173, tz: 'Europe/Moscow' },
      { zh: 'ç»´ä¹Ÿçº³', en: 'Vienna', pinyin: 'weiyena', lat: 48.2082, lon: 16.3738, tz: 'Europe/Vienna' },
      { zh: 'è‹é»ä¸–', en: 'Zurich', pinyin: 'sulishi', lat: 47.3769, lon: 8.5417, tz: 'Europe/Zurich' },
      { zh: 'æ…•å°¼é»‘', en: 'Munich', pinyin: 'munihei', lat: 48.1351, lon: 11.5820, tz: 'Europe/Berlin' },
      { zh: 'ç±³å…°', en: 'Milan', pinyin: 'milan', lat: 45.4642, lon: 9.1900, tz: 'Europe/Rome' },
      { zh: 'å·´å¡ç½—é‚£', en: 'Barcelona', pinyin: 'basailuona', lat: 41.3851, lon: 2.1734, tz: 'Europe/Madrid' },
      { zh: 'å¸ƒé²å¡å°”', en: 'Brussels', pinyin: 'bulusaier', lat: 50.8503, lon: 4.3517, tz: 'Europe/Brussels' },
      { zh: 'æ–¯å¾·å“¥å°”æ‘©', en: 'Stockholm', pinyin: 'sidegeermo', lat: 59.3293, lon: 18.0686, tz: 'Europe/Stockholm' },
      { zh: 'å“¥æœ¬å“ˆæ ¹', en: 'Copenhagen', pinyin: 'gebenhagen', lat: 55.6761, lon: 12.5683, tz: 'Europe/Copenhagen' },
      { zh: 'èµ«å°”è¾›åŸº', en: 'Helsinki', pinyin: 'heersiji', lat: 60.1699, lon: 24.9384, tz: 'Europe/Helsinki' },
      { zh: 'åæ²™', en: 'Warsaw', pinyin: 'huasha', lat: 52.2297, lon: 21.0122, tz: 'Europe/Warsaw' },
      { zh: 'å¸ƒæ‹‰æ ¼', en: 'Prague', pinyin: 'bulage', lat: 50.0755, lon: 14.4378, tz: 'Europe/Prague' },
      { zh: 'å¸ƒè¾¾ä½©æ–¯', en: 'Budapest', pinyin: 'budapeisi', lat: 47.4979, lon: 19.0402, tz: 'Europe/Budapest' },
      { zh: 'é›…å…¸', en: 'Athens', pinyin: 'yadian', lat: 37.9838, lon: 23.7275, tz: 'Europe/Athens' },
      { zh: 'é‡Œæ–¯æœ¬', en: 'Lisbon', pinyin: 'lisiben', lat: 38.7223, lon: -9.1393, tz: 'Europe/Lisbon' },
      { zh: 'éƒ½æŸæ—', en: 'Dublin', pinyin: 'dubolin', lat: 53.3498, lon: -6.2603, tz: 'Europe/Dublin' },
      { zh: 'çˆ±ä¸å ¡', en: 'Edinburgh', pinyin: 'aidingbao', lat: 55.9533, lon: -3.1883, tz: 'Europe/London' },
      // åŒ—ç¾
      { zh: 'çº½çº¦', en: 'New York', pinyin: 'niuyue', lat: 40.7128, lon: -74.0060, tz: 'America/New_York' },
      { zh: 'æ´›æ‰çŸ¶', en: 'Los Angeles', pinyin: 'luosanji', lat: 34.0522, lon: -118.2437, tz: 'America/Los_Angeles' },
      { zh: 'èŠåŠ å“¥', en: 'Chicago', pinyin: 'zhijiage', lat: 41.8781, lon: -87.6298, tz: 'America/Chicago' },
      { zh: 'æ—§é‡‘å±±', en: 'San Francisco', pinyin: 'jiujinshan', lat: 37.7749, lon: -122.4194, tz: 'America/Los_Angeles' },
      { zh: 'è¥¿é›…å›¾', en: 'Seattle', pinyin: 'xiyatu', lat: 47.6062, lon: -122.3321, tz: 'America/Los_Angeles' },
      { zh: 'æ³¢å£«é¡¿', en: 'Boston', pinyin: 'boshidun', lat: 42.3601, lon: -71.0589, tz: 'America/New_York' },
      { zh: 'åç››é¡¿', en: 'Washington D.C.', pinyin: 'huashengdun', lat: 38.9072, lon: -77.0369, tz: 'America/New_York' },
      { zh: 'è¿ˆé˜¿å¯†', en: 'Miami', pinyin: 'maiami', lat: 25.7617, lon: -80.1918, tz: 'America/New_York' },
      { zh: 'ä¼‘æ–¯é¡¿', en: 'Houston', pinyin: 'xiusidun', lat: 29.7604, lon: -95.3698, tz: 'America/Chicago' },
      { zh: 'è¾¾æ‹‰æ–¯', en: 'Dallas', pinyin: 'dalasi', lat: 32.7767, lon: -96.7970, tz: 'America/Chicago' },
      { zh: 'ä¸¹ä½›', en: 'Denver', pinyin: 'danfo', lat: 39.7392, lon: -104.9903, tz: 'America/Denver' },
      { zh: 'æ‹‰æ–¯ç»´åŠ æ–¯', en: 'Las Vegas', pinyin: 'lasiweijisi', lat: 36.1699, lon: -115.1398, tz: 'America/Los_Angeles' },
      { zh: 'å¤šä¼¦å¤š', en: 'Toronto', pinyin: 'duolunduo', lat: 43.6532, lon: -79.3832, tz: 'America/Toronto' },
      { zh: 'æ¸©å“¥å', en: 'Vancouver', pinyin: 'wengehua', lat: 49.2827, lon: -123.1207, tz: 'America/Vancouver' },
      { zh: 'è’™ç‰¹åˆ©å°”', en: 'Montreal', pinyin: 'mengtelier', lat: 45.5017, lon: -73.5673, tz: 'America/Montreal' },
      { zh: 'å¢¨è¥¿å“¥åŸ', en: 'Mexico City', pinyin: 'moxigecheng', lat: 19.4326, lon: -99.1332, tz: 'America/Mexico_City' },
      // å¤§æ´‹æ´²
      { zh: 'æ‚‰å°¼', en: 'Sydney', pinyin: 'xini', lat: -33.8688, lon: 151.2093, tz: 'Australia/Sydney' },
      { zh: 'å¢¨å°”æœ¬', en: 'Melbourne', pinyin: 'moerben', lat: -37.8136, lon: 144.9631, tz: 'Australia/Melbourne' },
      { zh: 'å¸ƒé‡Œæ–¯ç­', en: 'Brisbane', pinyin: 'bulisiban', lat: -27.4698, lon: 153.0251, tz: 'Australia/Brisbane' },
      { zh: 'ç€æ–¯', en: 'Perth', pinyin: 'posi', lat: -31.9505, lon: 115.8605, tz: 'Australia/Perth' },
      { zh: 'å¥¥å…‹å…°', en: 'Auckland', pinyin: 'aokelan', lat: -36.8509, lon: 174.7645, tz: 'Pacific/Auckland' },
      // å—ç¾
      { zh: 'åœ£ä¿ç½—', en: 'SÃ£o Paulo', pinyin: 'shengbaoluo', lat: -23.5505, lon: -46.6333, tz: 'America/Sao_Paulo' },
      { zh: 'é‡Œçº¦çƒ­å†…å¢', en: 'Rio de Janeiro', pinyin: 'liyuereneilu', lat: -22.9068, lon: -43.1729, tz: 'America/Sao_Paulo' },
      { zh: 'å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯', en: 'Buenos Aires', pinyin: 'buyinuosiailisi', lat: -34.6037, lon: -58.3816, tz: 'America/Argentina/Buenos_Aires' },
      // éæ´²
      { zh: 'å¼€ç½—', en: 'Cairo', pinyin: 'kailuo', lat: 30.0444, lon: 31.2357, tz: 'Africa/Cairo' },
      { zh: 'çº¦ç¿°å†…æ–¯å ¡', en: 'Johannesburg', pinyin: 'yuehanneisibao', lat: -26.2041, lon: 28.0473, tz: 'Africa/Johannesburg' },
      { zh: 'å¼€æ™®æ•¦', en: 'Cape Town', pinyin: 'kaipudun', lat: -33.9249, lon: 18.4241, tz: 'Africa/Johannesburg' }
    ];

    // ========== City Search with Autocomplete ==========
    const locationInput = document.getElementById('location');
    const citySuggestions = document.getElementById('citySuggestions');
    const timezoneInput = document.getElementById('timezone');
    const timezoneGroup = document.getElementById('timezoneGroup');

    // Debounce timer for API calls
    let searchDebounceTimer = null;

    // Detect if input is Chinese
    function isChinese(str) {
      return /[\u4e00-\u9fa5]/.test(str);
    }

    // Search cities locally - instant response
    function searchCitiesLocal(query) {
      if (!query || query.length === 0) return [];

      const q = query.toLowerCase().trim();
      const isZh = isChinese(q);

      return cityDatabase.filter(city => {
        if (isZh) {
          // Chinese input: match Chinese name
          return city.zh.includes(q);
        } else {
          // English/Pinyin input: match English name or pinyin
          return city.en.toLowerCase().startsWith(q) ||
                 city.pinyin.startsWith(q) ||
                 city.en.toLowerCase().includes(q);
        }
      }).slice(0, 8); // Max 8 results
    }

    // Search cities via OpenStreetMap Nominatim API (fallback)
    async function searchCitiesOnline(query) {
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=8&addressdetails=1`,
          {
            headers: {
              'User-Agent': 'NatalCodex-App/1.0',
              'Accept-Language': currentLang === 'zh' ? 'zh-CN,zh' : 'en'
            }
          }
        );

        if (!response.ok) return [];

        const data = await response.json();

        // Convert OSM results to our format
        return data.map(place => {
          const lat = parseFloat(place.lat);
          const lon = parseFloat(place.lon);
          const displayName = place.display_name.split(',').slice(0, 2).join(',');
          const tz = guessTimezoneFromCoords(lat, lon);

          return {
            lat,
            lon,
            zh: displayName,
            en: displayName,
            tz,
            isOnline: true
          };
        });
      } catch (error) {
        console.error('Online city search failed:', error);
        return [];
      }
    }

    // Guess timezone from coordinates (approximate)
    function guessTimezoneFromCoords(lat, lon) {
      // Rough timezone estimation based on longitude
      // Each timezone is approximately 15 degrees wide
      const offset = Math.round(lon / 15);

      // Common timezone mappings by region
      if (lat >= 20 && lat <= 55 && lon >= 73 && lon <= 135) {
        // China region
        return 'Asia/Shanghai';
      } else if (lat >= 24 && lat <= 46 && lon >= 122 && lon <= 154) {
        // Japan region
        return 'Asia/Tokyo';
      } else if (lat >= 33 && lat <= 43 && lon >= 124 && lon <= 132) {
        // Korea region
        return 'Asia/Seoul';
      } else if (lat >= -10 && lat <= 10 && lon >= 95 && lon <= 141) {
        // Southeast Asia
        return 'Asia/Singapore';
      } else if (lat >= 35 && lat <= 72 && lon >= -10 && lon <= 40) {
        // Europe
        if (lon < 0) return 'Europe/London';
        if (lon < 15) return 'Europe/Paris';
        if (lon < 25) return 'Europe/Berlin';
        return 'Europe/Moscow';
      } else if (lat >= 25 && lat <= 50 && lon >= -130 && lon <= -60) {
        // North America
        if (lon < -115) return 'America/Los_Angeles';
        if (lon < -100) return 'America/Denver';
        if (lon < -85) return 'America/Chicago';
        return 'America/New_York';
      } else if (lat >= -45 && lat <= -10 && lon >= 110 && lon <= 155) {
        // Australia
        return 'Australia/Sydney';
      }

      // Fallback: calculate UTC offset
      if (offset >= 0) {
        return `Etc/GMT-${offset}`;
      } else {
        return `Etc/GMT+${Math.abs(offset)}`;
      }
    }

    // Render city suggestions
    function renderSuggestions(cities, query, isLoading = false) {
      if (isLoading) {
        citySuggestions.innerHTML = `<div style="padding:12px;text-align:center;color:#9ca3af">
          <span style="display:inline-block;animation:spin 1s linear infinite">â³</span>
          ${currentLang === 'zh' ? 'æœç´¢ä¸­...' : 'Searching...'}
        </div>`;
        citySuggestions.style.display = 'block';
        return;
      }

      if (cities.length === 0) {
        citySuggestions.innerHTML = `<div style="padding:12px;text-align:center;color:#9ca3af">${currentLang === 'zh' ? 'æœªæ‰¾åˆ°åŒ¹é…åŸå¸‚' : 'No matching city found'}</div>`;
        citySuggestions.style.display = 'block';
        return;
      }

      citySuggestions.innerHTML = cities.map(city => {
        const displayName = city.isOnline
          ? city.en
          : (currentLang === 'zh' ? `${city.zh} (${city.en})` : `${city.en} (${city.zh})`);
        const icon = city.isOnline ? 'ğŸŒ' : 'ğŸ“';
        return `
          <div class="city-option"
               data-lat="${city.lat}"
               data-lon="${city.lon}"
               data-zh="${city.zh}"
               data-en="${city.en}"
               data-tz="${city.tz}"
               style="padding:12px;cursor:pointer;border-bottom:1px solid rgba(0,255,157,0.1);color:#d4d4d8;transition:background 0.2s">
            ${icon} ${displayName}
            <span style="float:right;color:#6b7280;font-size:12px">${city.tz}</span>
          </div>
        `;
      }).join('');

      // Add click handlers
      document.querySelectorAll('.city-option').forEach(option => {
        option.addEventListener('mouseenter', () => {
          option.style.background = 'rgba(0,255,157,0.15)';
        });
        option.addEventListener('mouseleave', () => {
          option.style.background = 'transparent';
        });
        option.addEventListener('click', () => {
          selectCity({
            lat: parseFloat(option.dataset.lat),
            lon: parseFloat(option.dataset.lon),
            zh: option.dataset.zh,
            en: option.dataset.en,
            tz: option.dataset.tz
          });
        });
      });

      citySuggestions.style.display = 'block';
    }

    // Handle input - local search first, then online fallback
    locationInput.addEventListener('input', async (e) => {
      const query = e.target.value.trim();

      // Clear previous debounce timer
      if (searchDebounceTimer) {
        clearTimeout(searchDebounceTimer);
      }

      if (query.length === 0) {
        citySuggestions.style.display = 'none';
        return;
      }

      // First, try local search (instant)
      const localResults = searchCitiesLocal(query);

      if (localResults.length > 0) {
        // Local results found - show immediately
        renderSuggestions(localResults, query);
      } else if (query.length >= 2) {
        // No local results and query is long enough - try online search
        renderSuggestions([], query, true); // Show loading

        // Debounce the API call (500ms)
        searchDebounceTimer = setTimeout(async () => {
          const onlineResults = await searchCitiesOnline(query);
          renderSuggestions(onlineResults, query);
        }, 500);
      } else {
        // Query too short for online search
        renderSuggestions([], query);
      }
    });

    // Select city and auto-fill timezone
    function selectCity(city) {
      selectedCity = {
        lat: city.lat,
        lon: city.lon,
        displayName: currentLang === 'zh' ? city.zh : city.en
      };
      selectedTimezone = city.tz;

      locationInput.value = currentLang === 'zh' ? `${city.zh} (${city.en})` : `${city.en} (${city.zh})`;
      timezoneInput.value = city.tz;
      timezoneGroup.style.display = 'block';
      citySuggestions.style.display = 'none';

      // Save form data after city selection
      saveFormData();
    }

    // Close suggestions when clicking outside
    document.addEventListener('click', (e) => {
      if (!locationInput.contains(e.target) && !citySuggestions.contains(e.target)) {
        citySuggestions.style.display = 'none';
      }
    });

    // Handle keyboard navigation
    locationInput.addEventListener('keydown', (e) => {
      const options = citySuggestions.querySelectorAll('.city-option');
      if (options.length === 0) return;

      let currentIndex = Array.from(options).findIndex(opt => opt.style.background.includes('0,255,157'));

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (currentIndex >= 0) options[currentIndex].style.background = 'transparent';
        currentIndex = (currentIndex + 1) % options.length;
        options[currentIndex].style.background = 'rgba(0,255,157,0.15)';
        options[currentIndex].scrollIntoView({ block: 'nearest' });
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (currentIndex >= 0) options[currentIndex].style.background = 'transparent';
        currentIndex = currentIndex <= 0 ? options.length - 1 : currentIndex - 1;
        options[currentIndex].style.background = 'rgba(0,255,157,0.15)';
        options[currentIndex].scrollIntoView({ block: 'nearest' });
      } else if (e.key === 'Enter' && currentIndex >= 0) {
        e.preventDefault();
        options[currentIndex].click();
      } else if (e.key === 'Escape') {
        citySuggestions.style.display = 'none';
      }
    });

    // ========== Form Handling ==========
    const form = document.getElementById('generateForm');
    const submitBtn = document.getElementById('submitBtn');
    const loading = document.getElementById('loading');
    const resultSection = document.getElementById('resultSection');
    const reportContent = document.getElementById('reportContent');
    const copyBtn = document.getElementById('copyBtn');
    const errorDiv = document.getElementById('error');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Hide error and result
      errorDiv.classList.remove('active');
      resultSection.classList.remove('active');

      // Show loading
      loading.classList.add('active');
      submitBtn.disabled = true;

      // Get form data
      const formData = new FormData(form);
      const birthData = {
        name: formData.get('name'),
        gender: formData.get('gender'),
        date: formData.get('date'),
        time: formData.get('time'),
        location: selectedCity ? selectedCity.displayName : formData.get('location'),
        timezone: selectedTimezone || Intl.DateTimeFormat().resolvedOptions().timeZone,
        coordinates: selectedCity ? { lat: selectedCity.lat, lon: selectedCity.lon } : null,
        language: currentLang
      };

      try {
        const response = await fetch('/api/reports/generateWithAPImart', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            orderId: 'web-' + Date.now(),
            birthData
          })
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(data.error || 'Report generation failed');
        }

        // Clean markdown - remove ALL special formatting markers
        let cleanReport = data.reportContent
          // Remove bold markers
          .replace(/\*\*(.+?)\*\*/g, '$1')
          // Remove italic markers
          .replace(/\*(.+?)\*/g, '$1')
          // Remove underscore emphasis
          .replace(/__(.+?)__/g, '$1')
          .replace(/_(.+?)_/g, '$1')
          // Remove strikethrough
          .replace(/~~(.+?)~~/g, '$1')
          // Remove inline code backticks but keep content
          .replace(/`(.+?)`/g, '$1')
          // Clean up any remaining asterisks
          .replace(/\*/g, '')
          .replace(/_/g, '')
          // Remove extra blank lines
          .replace(/\n{3,}/g, '\n\n');

        // Store clean text for copying
        window.cleanReportText = cleanReport;

        // Store data for soul card generation
        lastAnalysisData = {
          name: birthData.name,
          gender: birthData.gender,
          reportContent: cleanReport,
          rawAnalysis: data.analysis?.raw_content || cleanReport
        };

        // Render markdown to HTML
        reportContent.innerHTML = marked.parse(cleanReport);

        // Save to history
        saveToHistory({
          name: birthData.name,
          gender: birthData.gender,
          date: birthData.date,
          time: birthData.time,
          location: birthData.location,
          content: cleanReport
        });

        // Show result
        loading.classList.remove('active');
        resultSection.classList.add('active');

        // Scroll to result after DOM renders
        setTimeout(() => {
          resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);

      } catch (error) {
        console.error('Error:', error);
        errorDiv.textContent = translations[currentLang].errorGenerate + error.message;
        errorDiv.classList.add('active');
        loading.classList.remove('active');
      } finally {
        submitBtn.disabled = false;
      }
    });

    // Copy button
    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(window.cleanReportText || reportContent.innerText);
        const originalHTML = copyBtn.innerHTML;
        copyBtn.innerHTML = `âœ… <span data-i18n="btnCopied">${translations[currentLang].btnCopied}</span>`;
        copyBtn.classList.add('copied');

        setTimeout(() => {
          copyBtn.innerHTML = `ğŸ“‹ <span data-i18n="btnCopy">${translations[currentLang].btnCopy}</span>`;
          copyBtn.classList.remove('copied');
        }, 2000);
      } catch (error) {
        console.error('Copy failed:', error);
        alert(translations[currentLang].errorCopy);
      }
    });

    // Download button
    const downloadBtn = document.getElementById('downloadBtn');
    downloadBtn.addEventListener('click', () => {
      const text = window.cleanReportText || reportContent.innerText;
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `BaZi-MBTI-Report_${document.getElementById('name').value}_${new Date().toLocaleDateString()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      downloadBtn.innerHTML = `âœ… <span data-i18n="btnDownloaded">${translations[currentLang].btnDownloaded}</span>`;
      downloadBtn.classList.add('copied');
      setTimeout(() => {
        downloadBtn.innerHTML = `ğŸ’¾ <span data-i18n="btnDownload">${translations[currentLang].btnDownload}</span>`;
        downloadBtn.classList.remove('copied');
      }, 2000);
    });

    // PDF Download button - Client-side generation with Chinese font support
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    downloadPdfBtn.addEventListener('click', async () => {
      const name = document.getElementById('name').value || 'User';
      const title = currentLang === 'zh' ? `${name}çš„å…«å­—MBTIåˆ†ææŠ¥å‘Š` : `${name}'s BaZi & MBTI Analysis Report`;

      downloadPdfBtn.innerHTML = `â³ <span>${currentLang === 'zh' ? 'ç”Ÿæˆä¸­...' : 'Generating...'}</span>`;
      downloadPdfBtn.disabled = true;

      try {
        // Create a styled container for PDF generation
        const pdfContainer = document.createElement('div');
        pdfContainer.style.cssText = `
          font-family: 'Microsoft YaHei', 'PingFang SC', 'Hiragino Sans GB', sans-serif;
          color: #333;
          padding: 20px;
          background: #fff;
          line-height: 1.8;
        `;
        pdfContainer.innerHTML = `
          <h1 style="text-align:center;color:#1a1f4d;margin-bottom:20px;font-size:24px">${title}</h1>
          <p style="text-align:center;color:#666;margin-bottom:30px;font-size:12px">${currentLang === 'zh' ? 'ç”Ÿæˆæ—¶é—´' : 'Generated'}: ${new Date().toLocaleString()}</p>
          <hr style="border:none;border-top:2px solid #00d4aa;margin-bottom:20px">
          <div style="font-size:12px">${reportContent.innerHTML}</div>
          <hr style="border:none;border-top:1px solid #ddd;margin-top:30px">
          <p style="text-align:center;color:#999;font-size:10px;margin-top:10px">Powered by NatalCodex - BaZi & MBTI Analysis</p>
        `;

        // PDF options
        const opt = {
          margin: [15, 15, 15, 15],
          filename: `BaZi-MBTI-Report_${name}_${new Date().toLocaleDateString()}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true, logging: false },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // Generate PDF
        await html2pdf().set(opt).from(pdfContainer).save();

        downloadPdfBtn.innerHTML = `âœ… <span data-i18n="btnDownloaded">${translations[currentLang].btnDownloaded}</span>`;
        downloadPdfBtn.classList.add('copied');
        setTimeout(() => {
          downloadPdfBtn.innerHTML = `ğŸ“„ <span data-i18n="btnDownloadPdf">${translations[currentLang].btnDownloadPdf}</span>`;
          downloadPdfBtn.classList.remove('copied');
        }, 2000);
      } catch (error) {
        console.error('PDF download failed:', error);
        downloadPdfBtn.innerHTML = `âŒ <span>${currentLang === 'zh' ? 'å¤±è´¥' : 'Failed'}</span>`;
        setTimeout(() => {
          downloadPdfBtn.innerHTML = `ğŸ“„ <span data-i18n="btnDownloadPdf">${translations[currentLang].btnDownloadPdf}</span>`;
        }, 2000);
      } finally {
        downloadPdfBtn.disabled = false;
      }
    });

    // Fill demo data button
    const fillDemoBtn = document.getElementById('fillDemoBtn');
    fillDemoBtn.addEventListener('click', () => {
      if (currentLang === 'zh') {
        document.getElementById('name').value = 'ææ¢…';
        document.getElementById('gender').value = 'å¥³';
        document.getElementById('date').value = '1999-08-08';
        document.getElementById('time').value = '14:30';
        // Set Shanghai city data
        const shanghaiCity = cityDatabase.find(c => c.zh === 'ä¸Šæµ·');
        if (shanghaiCity) {
          selectedCity = { lat: shanghaiCity.lat, lon: shanghaiCity.lon, displayName: shanghaiCity.zh };
          selectedTimezone = shanghaiCity.tz;
          document.getElementById('location').value = `${shanghaiCity.zh} (${shanghaiCity.en})`;
          document.getElementById('timezone').value = shanghaiCity.tz;
          document.getElementById('timezoneGroup').style.display = 'block';
        }
      } else {
        document.getElementById('name').value = 'Emma Johnson';
        document.getElementById('gender').value = 'å¥³'; // Female
        document.getElementById('date').value = '1999-08-08';
        document.getElementById('time').value = '14:30';
        // Set New York city data
        const nyCity = cityDatabase.find(c => c.en === 'New York');
        if (nyCity) {
          selectedCity = { lat: nyCity.lat, lon: nyCity.lon, displayName: nyCity.en };
          selectedTimezone = nyCity.tz;
          document.getElementById('location').value = `${nyCity.en} (${nyCity.zh})`;
          document.getElementById('timezone').value = nyCity.tz;
          document.getElementById('timezoneGroup').style.display = 'block';
        }
      }

      fillDemoBtn.innerHTML = `âœ… <span data-i18n="demoFilled">${translations[currentLang].demoFilled}</span>`;
      setTimeout(() => {
        fillDemoBtn.innerHTML = `ğŸ“ <span data-i18n="btnDemo">${translations[currentLang].btnDemo}</span>`;
      }, 1500);
    });

    // ========== Soul Card Generation ==========
    const generateCardBtn = document.getElementById('generateCardBtn');
    const cardSection = document.getElementById('cardSection');
    const cardLoading = document.getElementById('cardLoading');
    const cardImage = document.getElementById('cardImage');
    const soulCardImg = document.getElementById('soulCardImg');
    const downloadCardBtn = document.getElementById('downloadCardBtn');

    // Store analysis data for card generation
    let lastAnalysisData = null;

    // Progress bar elements
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressTip = document.getElementById('progressTip');
    let progressInterval = null;

    // Simulated progress animation (since API doesn't provide real progress)
    function startProgressAnimation() {
      let progress = 0;
      let tipIndex = 0;
      const tips = translations[currentLang].cardProgressTips;

      // Reset progress
      progressBar.style.width = '0%';
      progressText.textContent = '0%';
      progressTip.textContent = tips[0];

      progressInterval = setInterval(() => {
        // Slow progress that never quite reaches 100%
        if (progress < 90) {
          progress += Math.random() * 3 + 0.5;
          if (progress > 90) progress = 90;

          progressBar.style.width = `${progress}%`;
          progressText.textContent = `${Math.round(progress)}%`;

          // Update tip message at certain progress points
          const newTipIndex = Math.floor(progress / 20);
          if (newTipIndex !== tipIndex && newTipIndex < tips.length) {
            tipIndex = newTipIndex;
            progressTip.textContent = tips[tipIndex];
          }
        }
      }, 500);
    }

    function stopProgressAnimation(success = true) {
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
      if (success) {
        progressBar.style.width = '100%';
        progressText.textContent = '100%';
      }
    }

    generateCardBtn.addEventListener('click', async () => {
      if (!lastAnalysisData) {
        alert(currentLang === 'zh' ? 'è¯·å…ˆç”ŸæˆæŠ¥å‘Š' : 'Please generate report first');
        return;
      }

      // Show loading
      generateCardBtn.disabled = true;
      generateCardBtn.innerHTML = `â³ <span>${translations[currentLang].cardGenerating}</span>`;
      cardSection.style.display = 'block';
      cardLoading.style.display = 'block';
      cardImage.style.display = 'none';

      // Start progress animation
      startProgressAnimation();

      // Scroll to card section immediately when starting generation
      setTimeout(() => {
        cardSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);

      try {
        const response = await fetch('/api/reports/generateSoulCard', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...lastAnalysisData,
            language: currentLang
          })
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(data.error || 'Card generation failed');
        }

        // Stop progress animation with success
        stopProgressAnimation(true);

        // Display the image
        soulCardImg.src = data.imageUrl;
        cardLoading.style.display = 'none';
        cardImage.style.display = 'block';

        // Scroll to card
        setTimeout(() => {
          cardSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);

      } catch (error) {
        console.error('Card generation error:', error);
        stopProgressAnimation(false);
        cardLoading.innerHTML = `<div style="color:#fca5a5">${translations[currentLang].cardError}${error.message}<br><button id="retryCardBtn" class="copy-btn" style="margin-top:16px">ğŸ”„ ${currentLang === 'zh' ? 'é‡è¯•' : 'Retry'}</button></div>`;

        // Add retry button listener
        document.getElementById('retryCardBtn')?.addEventListener('click', () => {
          generateCardBtn.click();
        });
      } finally {
        generateCardBtn.disabled = false;
        generateCardBtn.innerHTML = `ğŸ´ <span data-i18n="btnCard">${translations[currentLang].btnCard}</span>`;
      }
    });

    // Download card image
    downloadCardBtn.addEventListener('click', async () => {
      const imgSrc = soulCardImg.src;
      if (!imgSrc) return;

      try {
        const response = await fetch(imgSrc);
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `SoulCard_${document.getElementById('name').value}_${new Date().toLocaleDateString()}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        downloadCardBtn.innerHTML = `âœ… <span>${translations[currentLang].btnDownloaded}</span>`;
        setTimeout(() => {
          downloadCardBtn.innerHTML = `ğŸ’¾ <span data-i18n="btnDownloadCard">${translations[currentLang].btnDownloadCard}</span>`;
        }, 2000);
      } catch (error) {
        console.error('Download failed:', error);
      }
    });

    // ========== Report History System ==========
    const HISTORY_KEY = 'nc_report_history';
    const MAX_HISTORY = 10; // Keep max 10 reports

    function getHistory() {
      try {
        return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      } catch {
        return [];
      }
    }

    function saveToHistory(report) {
      const history = getHistory();
      // Add new report at the beginning
      history.unshift({
        id: Date.now(),
        name: report.name,
        gender: report.gender,
        date: report.date,
        time: report.time,
        location: report.location,
        content: report.content,
        createdAt: new Date().toISOString()
      });
      // Keep only last MAX_HISTORY reports
      if (history.length > MAX_HISTORY) {
        history.pop();
      }
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
      renderHistory();
    }

    function deleteFromHistory(id) {
      const history = getHistory().filter(r => r.id !== id);
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
      renderHistory();
    }

    function clearHistory() {
      localStorage.removeItem(HISTORY_KEY);
      renderHistory();
    }

    function viewReport(id) {
      const report = getHistory().find(r => r.id === id);
      if (!report) return;

      // Show result section with this report
      window.cleanReportText = report.content;
      reportContent.innerHTML = marked.parse(report.content);
      resultSection.classList.add('active');

      // Set up data for soul card generation
      lastAnalysisData = {
        name: report.name,
        gender: report.gender,
        reportContent: report.content,
        rawAnalysis: report.content
      };

      // Hide card section when viewing history
      cardSection.style.display = 'none';

      // Scroll to result
      setTimeout(() => {
        resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
    }

    function renderHistory() {
      const history = getHistory();
      const historySection = document.getElementById('historySection');
      const historyList = document.getElementById('historyList');

      if (history.length === 0) {
        historySection.style.display = 'none';
        return;
      }

      historySection.style.display = 'block';
      historyList.innerHTML = history.map(report => {
        const date = new Date(report.createdAt);
        const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        return `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:8px;border:1px solid rgba(0,255,157,0.1)">
            <div style="flex:1">
              <div style="font-weight:600;color:#e5e7eb">${report.name} <span style="color:#9ca3af;font-weight:400;font-size:13px">(${report.gender})</span></div>
              <div style="font-size:12px;color:#6b7280;margin-top:4px">${report.date} ${report.time} Â· ${report.location}</div>
              <div style="font-size:11px;color:#4b5563;margin-top:2px">${dateStr}</div>
            </div>
            <div style="display:flex;gap:8px">
              <button onclick="viewReport(${report.id})" class="copy-btn" style="padding:6px 12px;font-size:12px">
                ğŸ‘ï¸ ${translations[currentLang].historyView}
              </button>
              <button onclick="if(confirm('${translations[currentLang].historyConfirmDelete}')){deleteFromHistory(${report.id})}" class="copy-btn" style="padding:6px 12px;font-size:12px;background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.3);color:#fca5a5">
                ğŸ—‘ï¸
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Clear history button
    document.getElementById('clearHistoryBtn').addEventListener('click', () => {
      if (confirm(translations[currentLang].historyConfirmClear)) {
        clearHistory();
      }
    });

    // Initialize history display
    renderHistory();

  </script>
</body>
</html>
